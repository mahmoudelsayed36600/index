<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS Ultimate v19.0 | النظام الشامل المطور</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        /* --- المتغيرات والتصميم العام --- */
        :root { 
            --primary: #4361ee; --secondary: #3f37c9; --accent: #4895ef;
            --dark: #0b132b; --light: #f8f9fa; 
            --success: #10b981; --danger: #ef476f; --warning: #f59e0b;
            --glass: rgba(255, 255, 255, 0.95);
        }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; outline: none; }
        
        body { 
            margin: 0; background: #eef2f6; height: 100vh; overflow: hidden; 
        }
        
        input, textarea, select, .allow-copy, .allow-copy * { 
            user-select: text !important; -webkit-user-select: text !important; cursor: text; 
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* --- Layout --- */
        .app-container { display: none; height: 100vh; animation: fadeIn 0.5s; }
        .app-container.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Sidebar --- */
        .sidebar { width: 280px; background: var(--dark); color: white; display: flex; flex-direction: column; box-shadow: 4px 0 15px rgba(0,0,0,0.1); z-index: 10; flex-shrink: 0; }
        .sidebar-header { padding: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 20px; font-weight: 900; display: flex; align-items: center; gap: 10px; color: var(--accent); }
        .nav-links { list-style: none; padding: 0; margin: 15px 0; overflow-y: auto; flex: 1; }
        .nav-links li a { display: flex; align-items: center; gap: 12px; padding: 14px 25px; color: #b8c1ec; text-decoration: none; transition: 0.3s; font-size: 14px; border-right: 4px solid transparent; cursor: pointer; }
        .nav-links li a:hover, .nav-links li a.active { background: rgba(255,255,255,0.05); color: white; border-right-color: var(--primary); padding-right: 35px; }
        .nav-category { font-size: 11px; color: #6c757d; padding: 15px 25px 5px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }

        /* --- Main Content --- */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: #eef2f6; position: relative; }
        .section { display: none; animation: slideUp 0.4s; padding-bottom: 80px; }
        .section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Components --- */
        .card { background: var(--glass); padding: 25px; border-radius: 16px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.8); }
        h2 { color: var(--dark); border-bottom: 3px solid var(--primary); display: inline-block; padding-bottom: 5px; margin-bottom: 25px; }
        
        .form-control { width: 100%; padding: 12px 15px; margin-bottom: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; transition: 0.3s; background: #fff; }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.15); }
        
        .btn { padding: 10px 25px; border: none; border-radius: 10px; cursor: pointer; color: white; font-weight: bold; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); }
        .btn-success { background: linear-gradient(135deg, #06d6a0, #04b386); }
        .btn-danger { background: linear-gradient(135deg, #ef476f, #d62f55); }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .btn-dark { background: linear-gradient(135deg, #2b2d42, #1a1b29); }
        .btn-sm { padding: 5px 10px; font-size: 12px; }

        .btn-icon { background: #f1f5f9; border: none; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #555; cursor: pointer; transition: 0.2s; }
        .btn-icon:hover { background: var(--primary); color: white; }
        .btn-icon.delete:hover { background: var(--danger); color: white; }
        .btn-icon.edit:hover { background: var(--warning); color: white; }

        /* --- Auth Screens --- */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1e293b, #0f172a); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .auth-box { background: white; padding: 50px; border-radius: 20px; width: 450px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); position: relative; overflow: hidden; }
        .auth-toggle { display: flex; background: #f1f5f9; padding: 5px; border-radius: 12px; margin-bottom: 20px; }
        .auth-toggle button { flex: 1; border: none; background: transparent; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; color: #666; transition: 0.3s; }
        .auth-toggle button.active { background: white; color: var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        /* --- Data Tables --- */
        .data-table-container { overflow-x: auto; border-radius: 10px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; background: white; }
        th { background: #f8fafc; padding: 15px 20px; text-align: right; color: #475569; font-weight: 800; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
        td { padding: 15px 20px; border-bottom: 1px solid #f1f5f9; color: #334155; vertical-align: middle; }
        tr:hover td { background-color: #f8faff; }
        tr:last-child td { border-bottom: none; }
        
        /* --- Mobile Responsive --- */
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; padding-bottom: 0; }
            .nav-links { display: flex; margin: 0; }
            .nav-links li a { padding: 10px; border-right: none; border-bottom: 3px solid transparent; }
            .nav-links li a:hover, .nav-links li a.active { border-right: none; border-bottom-color: var(--primary); padding-right: 10px; }
            .nav-category { display: none; }
            .main-content { padding: 15px; }
            .card { padding: 15px; }
            .stats-grid { grid-template-columns: 1fr; }
            .charts-grid { grid-template-columns: 1fr !important; }
        }

        /* --- Question & Quiz --- */
        .q-display-card { border: 1px solid #ccc; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #fff; position: relative; }
        .q-display-text { font-weight: bold; font-size: 15px; margin-bottom: 10px; color: var(--dark); }
        .q-options-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .q-option-view { padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 13px; }
        .q-option-view.correct-ans { background-color: #dcfce7; border-color: #10b981; color: #047857; font-weight: bold; }
        .q-controls { position: absolute; top: 10px; left: 10px; display: flex; gap: 5px; }
        .q-input-group { border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; background: #fff; margin-bottom: 15px; }
        .q-text-area { font-size: 16px; font-weight: 800; border: 2px solid #cbd5e1; background: #f0f9ff; }
        .option-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 12px; border: 2px solid transparent; border-radius: 8px; background: white; transition: 0.2s; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .option-row:hover { border-color: var(--primary); transform: translateX(-5px); }
        .option-row.correct { background: #d1fae5 !important; border-color: #10b981 !important; }
        .option-row.wrong { background: #fee2e2 !important; border-color: #ef4444 !important; }
        .opt-char { width: 35px; height: 35px; background: var(--dark); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; flex-shrink: 0; }
        .img-upload-label { cursor: pointer; color: var(--primary); font-size: 20px; transition: 0.2s; }
        .preview-thumb { max-height: 50px; border-radius: 5px; border: 1px solid #ddd; margin-right: 10px; display: none; }

        /* --- Stats Grid & Charts --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 25px; border-radius: 15px; text-align: center; border-bottom: 5px solid var(--primary); transition: 0.3s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .stat-num { font-size: 32px; font-weight: 900; color: var(--dark); margin: 10px 0; }
        
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .chart-container { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        /* --- Student UI --- */
        .course-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.05); transition: 0.4s; border: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; position: relative; }
        .course-card:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .course-card-header { height: 180px; background: #eee; position: relative; overflow: hidden; background-size: cover; background-position: center; }
        .course-card-body { padding: 15px; flex: 1; }
        .course-price-box { font-weight: bold; font-size: 16px; margin-top: 5px; color: var(--primary); }
        .old-price { text-decoration: line-through; color: var(--danger); font-size: 13px; margin-left: 5px; opacity: 0.7; }

        /* Video & PDF Styles (Student) */
        .video-container { width: 100%; margin-bottom: 20px; background: #000; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .video-container video, .video-container iframe { width: 100%; height: 60vh; border: none; }
        .pdf-container { width: 100%; height: 85vh; border: 2px solid #ddd; border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
        .pdf-container iframe { width: 100%; height: 100%; border: none; }

        /* --- Updated Course Structure Styles --- */
        .unit-block { border: 1px solid #ccc; margin-bottom: 10px; border-radius: 8px; overflow: hidden; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .unit-head { 
            padding: 10px 15px; 
            background: #dcfce7 !important; 
            color: #065f46; 
            font-weight: bold; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #86efac; 
            font-size: 15px; 
        }

        .lesson-row { padding: 10px 15px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: white; transition: 0.2s; font-size: 13px; }
        .lesson-row:hover { background: #f0f9ff; padding-right: 20px; }
        .actions-group { display: flex; gap: 5px; }

        /* --- Content Upload Types & Content Items --- */
        .upload-type-selector { display: flex; gap: 15px; margin-bottom: 15px; }
        .type-option { display: flex; align-items: center; gap: 5px; cursor: pointer; border: 1px solid #ddd; padding: 8px 15px; border-radius: 8px; background: white; }
        .type-option input { margin: 0; cursor: pointer; }
        .type-option.selected { border-color: var(--primary); background: #eff6ff; color: var(--primary); font-weight: bold; }

        /* تنسيق بنود المحتوى */
        .content-item-row {
            display: flex; justify-content: space-between; align-items: center;
            background-color: #d1fae5 !important;
            border: 1px solid #10b981;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            color: #065f46;
            font-weight: bold;
        }
        .content-thumb { width: 30px; height: 30px; background: rgba(255,255,255,0.5); display: flex; justify-content: center; align-items: center; border-radius: 50%; margin-left: 10px; color: #047857; }
        .content-item-left { display: flex; align-items: center; }

        /* --- Tabs Colors (Content) --- */
        .tab-btn-video { background: #10b981 !important; color: white !important; }
        .tab-btn-pdf { background: #10b981 !important; color: white !important; }
        .tab-btn-quiz { background: #f59e0b !important; color: white !important; }
        .content-tab { display:none; }
        .content-tab.active { display:block; }

        /* --- Modals & Printing --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 2000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 700px; max-width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.25); }
        
        .ai-btn { position: fixed; bottom: 30px; left: 30px; background: linear-gradient(45deg, #f72585, #7209b7); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: 0 5px 20px rgba(114, 9, 183, 0.4); z-index: 1000; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; background: white; }
            .no-print { display: none !important; }
            .card { box-shadow: none; border: none; }
            .q-display-card { border: 1px solid #000; break-inside: avoid; }
            .watermark { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 100px; color: rgba(0,0,0,0.03); z-index: -1; }
            .hide-answers .q-option-view.correct-ans { background-color: transparent !important; border-color: #ccc !important; font-weight: normal !important; color: black !important; }
            .show-answers .q-option-view.correct-ans { background-color: #ddd !important; border-color: #000 !important; font-weight: bold !important; -webkit-print-color-adjust: exact; }
        }

        /* --- Review Colors --- */
        .rev-correct { background-color: #d1fae5; border: 2px solid #10b981; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .rev-wrong { background-color: #fee2e2; border: 2px solid #ef4444; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .rev-note { font-weight: bold; margin-top: 5px; color: #047857; }
        
        /* --- Quiz UI --- */
        .quiz-header { display: flex; justify-content: center; align-items: center; padding-bottom: 15px; border-bottom: 2px solid #eee; margin-bottom: 30px; position: relative; }
        .quiz-timer { font-size: 28px; font-weight: 900; color: var(--danger); background: #fff0f3; padding: 10px 30px; border-radius: 50px; box-shadow: 0 5px 15px rgba(239, 71, 111, 0.2); }
        .q-nav { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 20px; }
        .q-dot { width: 35px; height: 35px; border-radius: 50%; background: #e9ecef; display: flex; justify-content: center; align-items: center; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .q-dot.active { background: var(--primary); color: white; transform: scale(1.1); }
        .q-dot.solved { background: var(--success); color: white; }
        .q-dot.unsolved { background: var(--danger); color: white; }
        .quiz-question-box { font-size: 22px; font-weight: bold; margin-bottom: 30px; color: #1e293b; line-height: 1.6; padding: 20px; background: #fff; border-radius: 12px; border-right: 5px solid var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .quiz-option-label { display: flex; align-items: center; padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 15px; cursor: pointer; transition: 0.3s; background: #fff; gap: 15px; font-size: 18px; }
        .quiz-option-label:hover { border-color: var(--primary); background: #f8fafc; transform: translateX(-5px); }
        .quiz-option-label input { width: 24px; height: 24px; accent-color: var(--primary); }
        .quiz-option-label input:checked + span { font-weight: bold; color: var(--primary); }

        /* --- أنماط التقارير الجديدة --- */
        .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--primary); }
        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-bar select { min-width: 150px; }
        .report-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 4px solid var(--primary); }
        .report-stat { display: inline-block; background: #f8fafc; padding: 15px; border-radius: 10px; margin: 0 10px 10px 0; min-width: 120px; text-align: center; }
        .report-stat-value { font-size: 24px; font-weight: bold; color: var(--primary); display: block; }
        .report-stat-label { font-size: 12px; color: #666; }
        .export-btn { background: linear-gradient(135deg, #10b981, #059669); }
        
        /* --- إضافات جديدة --- */
        .retry-wrong-btn { background: linear-gradient(135deg, #ef476f, #d62f55); margin-left: 10px; }
        .retry-all-btn { background: linear-gradient(135deg, #f59e0b, #d97706); margin-left: 10px; }
        .quiz-settings { display: flex; gap: 15px; margin-bottom: 15px; align-items: center; }
        .quiz-settings label { display: flex; align-items: center; gap: 5px; }
        
        /* --- إضافات جديدة للطلب --- */
        .student-status { display: inline-flex; align-items: center; gap: 5px; padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .status-online { background: #d1fae5; color: #065f46; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-suspended { background: #fee2e2; color: #991b1b; }
        
        .notification-badge { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 11px; display: flex; align-items: center; justify-content: center; }
        
        .student-profile-img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); cursor: pointer; }
        .profile-upload-label { cursor: pointer; display: inline-block; margin-top: 10px; color: var(--primary); }
        
        .file-display-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #f8fafc; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e2e8f0; }
        
        /* --- أيقونة التحدث مع المعلم --- */
        .teacher-chat-btn { position: fixed; bottom: 30px; right: 30px; background: linear-gradient(45deg, #10b981, #059669); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4); z-index: 1000; }
        .teacher-chat-btn .teacher-status { position: absolute; top: -5px; right: -5px; width: 15px; height: 15px; border-radius: 50%; }
        .teacher-chat-btn .online { background: #10b981; }
        .teacher-chat-btn .offline { background: #ef4444; }
        
        /* شات المعلم */
        .chat-container { position: fixed; bottom: 100px; right: 30px; width: 350px; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 1001; display: none; }
        .chat-container.active { display: block; }
        .chat-header { background: var(--primary); color: white; padding: 15px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .chat-messages { height: 300px; overflow-y: auto; padding: 15px; }
        .chat-input-area { padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; }
        .chat-message { margin-bottom: 10px; padding: 10px; border-radius: 10px; max-width: 80%; }
        .chat-message.student { background: #e0f2fe; margin-left: auto; }
        .chat-message.teacher { background: #d1fae5; }
        
        /* إصلاح اللاج (Lag) عند الانتقال بين الأقسام */
        .section { display: none; animation: fadeIn 0.3s ease-out; }
        .section.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* تصحيح عرض الملفات والفيديوهات */
        .file-preview-container { width: 100%; margin-bottom: 20px; background: #f8fafc; border-radius: 12px; padding: 15px; }
        .file-preview-container video { width: 100%; border-radius: 8px; }
        .pdf-embed-container { width: 100%; height: 500px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
        .pdf-embed-container iframe { width: 100%; height: 100%; border: none; }
        
        /* تحسين عرض إحصائيات الطالب */
        .performance-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .performance-card { background: white; padding: 20px; border-radius: 12px; text-align: center; border-left: 5px solid var(--primary); }
        .performance-value { font-size: 28px; font-weight: bold; color: var(--primary); margin: 10px 0; }
        .performance-label { font-size: 14px; color: #666; }
        
        /* --- تبويبات كورسات الطالب الجديدة --- */
        .student-course-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        .student-tab-btn { padding: 10px 20px; border: none; border-radius: 8px; background: #f1f5f9; color: #475569; cursor: pointer; transition: 0.3s; font-weight: bold; }
        .student-tab-btn.active { background: var(--primary); color: white; }
        .student-tab-content { display: none; animation: fadeIn 0.3s; }
        .student-tab-content.active { display: block; }
        .student-video-grid, .student-file-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 20px; 
            margin-top: 15px; 
        }
        .student-video-card, .student-file-card { 
            background: white; 
            border-radius: 12px; 
            overflow: hidden; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); 
            transition: 0.3s; 
            border: 1px solid #e2e8f0;
        }
        .student-video-card:hover, .student-file-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
        }
        .student-video-thumb { 
            height: 150px; 
            background: #000; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-size: 40px; 
        }
        .student-file-thumb { 
            height: 150px; 
            background: #dcfce7; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: #047857; 
            font-size: 50px; 
        }
        .student-video-body, .student-file-body { padding: 15px; }
        .student-quiz-list { margin-top: 15px; }
        .student-quiz-item { 
            background: white; 
            padding: 15px; 
            border-radius: 10px; 
            margin-bottom: 10px; 
            border-left: 4px solid #f59e0b; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        /* --- زر الشات في لوحة الأدمن --- */
        .admin-chat-btn { position: fixed; bottom: 30px; left: 30px; background: linear-gradient(45deg, #4361ee, #3a0ca3); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: 0 5px 20px rgba(67, 97, 238, 0.4); z-index: 1000; }
        .admin-chat-btn .notification-badge { top: -2px; right: -2px; width: 20px; height: 20px; font-size: 12px; }
        
        /* --- أيقونة الأدمن للشات --- */
        .admin-chat-icon { position: fixed; bottom: 100px; left: 30px; background: linear-gradient(45deg, #4361ee, #3a0ca3); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4); z-index: 1000; }
        
        /* --- شات الأدمن --- */
        .admin-chat-container { position: fixed; bottom: 160px; left: 30px; width: 400px; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 1001; display: none; }
        .admin-chat-container.active { display: block; }
        .admin-chat-header { background: var(--primary); color: white; padding: 15px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .admin-chat-students { width: 120px; border-right: 1px solid #eee; overflow-y: auto; max-height: 300px; }
        .admin-chat-messages { flex: 1; height: 300px; overflow-y: auto; padding: 15px; }
        .admin-chat-input-area { padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; }
        
        /* --- تحسينات جديدة --- */
        .file-icon-container { 
            background: #f0f9ff; 
            border-radius: 10px; 
            padding: 15px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.3s; 
            border: 2px solid #e0f2fe;
        }
        .file-icon-container:hover { 
            transform: translateY(-5px); 
            border-color: var(--primary); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .file-icon { 
            font-size: 40px; 
            color: var(--primary); 
            margin-bottom: 10px;
        }
        .compact-quiz-area { 
            padding: 15px; 
            background: white; 
            border-radius: 10px; 
            margin-top: 10px; 
            max-height: 70vh; 
            overflow-y: auto;
        }
        .chat-student-frame { 
            background: #f8fafc; 
            padding: 10px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            border-left: 4px solid var(--primary);
        }
        /* تنسيق إضافي للمودال لمنع المشاكل */
.modal {
    animation: fadeIn 0.3s ease-out !important;
}

.modal-content {
    animation: slideUp 0.3s ease-out !important;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* منع التمرير عند فتح المودال */
body.modal-open {
    overflow: hidden !important;
}
/* ===== تحسينات حجم الاختبار للطالب ===== */
.compact-quiz-area { 
    padding: 15px; 
    background: white; 
    border-radius: 12px; 
    margin-top: 10px; 
    max-height: 80vh; 
    overflow-y: auto;
    width: 100%;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    border: 1px solid #e2e8f0;
}

#takingQuizTitle {
    font-size: 18px;
    font-weight: bold;
    color: var(--dark);
    flex: 1;
}

#st-quiz-active .btn {
    padding: 8px 20px;
    font-size: 14px;
    margin: 0 3px;
    min-width: 80px;
}

#st-quiz-active > .compact-quiz-area > div:last-child {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
}

@media (max-width: 768px) {
    .compact-quiz-area {
        padding: 12px;
        max-height: 75vh;
    }
    
    #takingQuizTitle {
        font-size: 16px;
        margin-bottom: 10px;
    }
    
    .quiz-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    #st-quiz-active .btn {
        padding: 7px 15px;
        font-size: 13px;
        min-width: 70px;
        flex: 1;
        margin: 2px;
    }
    
    #st-quiz-active > .compact-quiz-area > div:last-child {
        gap: 5px;
    }
}

#st-quiz-active {
    padding-bottom: 20px;
}
    </style>
</head>
<body>

    <!-- شاشة المصادقة -->
    <div id="auth-screen">
        <div class="auth-box">
            <div class="auth-header">
                <h1 style="color:var(--primary); margin:0;">LMS Ultimate</h1>
                <p style="color:#666; margin-top:5px;">بوابة المستقبل التعليمية</p>
            </div>
            
            <div class="auth-toggle">
                <button class="active" onclick="toggleAuthMode('login', this)">دخول</button>
                <button onclick="toggleAuthMode('register', this)">تسجيل طالب جديد</button>
            </div>

            <div id="login-form">
                <input type="text" id="lUser" class="form-control" placeholder="اسم المستخدم / الجوال">
                <input type="password" id="lPass" class="form-control" placeholder="كلمة المرور">
                <button class="btn btn-primary" style="width:100%; justify-content:center;" onclick="login()">دخول آمن <i class="fas fa-sign-in-alt"></i></button>
                <div style="margin-top:20px; font-size:13px; display:flex; justify-content:space-between;">
                    <a href="#" onclick="alert('تواصل مع الإدارة')" style="color:#666;">نسيت كلمة المرور؟</a>
                    <a href="https://wa.me/966509635561" target="_blank" style="color:var(--success); font-weight:bold; text-decoration:none;"><i class="fab fa-whatsapp"></i> تواصل للدعم</a>
                </div>
            </div>

            <div id="register-form" style="display:none;">
                <input type="text" id="rName" class="form-control" placeholder="الاسم الثلاثي">
                <input type="text" id="rPhone" class="form-control" placeholder="رقم الجوال (اسم المستخدم)">
                <input type="text" id="rEmail" class="form-control" placeholder="البريد الإلكتروني (اختياري)">
                <input type="text" id="rParent" class="form-control" placeholder="رقم ولي الأمر">
                <input type="password" id="rPass" class="form-control" placeholder="كلمة المرور">
                <input type="password" id="rParentPass" class="form-control" placeholder="كلمة مرور ولي الأمر">
                <select id="rGrade" class="form-control">
                    <option value="">اختر الصف الدراسي</option>
                    <option value="1">أول ثانوي</option><option value="2">ثاني ثانوي</option><option value="3">ثالث ثانوي</option>
                </select>
                <button class="btn btn-success" style="width:100%; justify-content:center;" onclick="registerStudent()">تسجيل الحساب <i class="fas fa-check"></i></button>
            </div>
        </div>
    </div>

    <!-- لوحة الأدمن -->
    <div id="admin-panel" class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header"><i class="fas fa-crown"></i> الإدارة العليا</div>
            <ul class="nav-links">
                <div class="nav-category">الأكاديمية</div>
                <li><a href="#" class="active" onclick="nav('adm-home')"><i class="fas fa-home"></i> الرئيسية</a></li>
                <li><a href="#" onclick="nav('adm-courses')"><i class="fas fa-book"></i> الكورسات</a></li>
                <li><a href="#" onclick="nav('adm-structure')"><i class="fas fa-network-wired"></i> هيكل الكورس</a></li>
                <li><a href="#" onclick="nav('adm-content')"><i class="fas fa-photo-video"></i> محتوى الدروس</a></li>
                
                <div class="nav-category">الامتحانات</div>
                <li><a href="#" onclick="nav('adm-add-q')"><i class="fas fa-plus-circle"></i> إضافة سؤال</a></li>
                <li><a href="#" onclick="nav('adm-comp-exams')"><i class="fas fa-clipboard-list"></i> الاختبارات المجمعة</a></li>
                <li><a href="#" onclick="nav('adm-preview-q')"><i class="fas fa-print"></i> معاينة وطباعة</a></li>
                
                <!-- قسم التقارير الجديد -->
                <div class="nav-category">التقارير والتحليلات</div>
                <li><a href="#" onclick="nav('adm-reports-comp')"><i class="fas fa-chart-bar"></i> تقارير الاختبارات المجمعة</a></li>
                <li><a href="#" onclick="nav('adm-reports-self')"><i class="fas fa-brain"></i> تقارير "أختبر نفسي"</a></li>
                
                <div class="nav-category">المتابعة</div>
                <li><a href="#" onclick="nav('adm-students')"><i class="fas fa-users"></i> الطلاب (تسكين)</a></li>
                <li><a href="#" onclick="nav('adm-st-courses')"><i class="fas fa-chalkboard-teacher"></i> إدارة كورسات الطلاب</a></li>
                <li><a href="#" onclick="nav('adm-performance')"><i class="fas fa-chart-pie"></i> أداء الطلاب</a></li>
                
                <!-- قسم الطلبات والإشعارات -->
                <div class="nav-category">الطلبات والإشعارات</div>
                <li>
                    <a href="#" onclick="nav('adm-requests')">
                        <i class="fas fa-clipboard-list"></i> طلبات الاشتراك
                        <span id="adminRequestsBadge" class="notification-badge" style="display:none;">0</span>
                    </a>
                </li>
                <li>
                    <a href="#" onclick="nav('adm-notifications')">
                        <i class="fas fa-bell"></i> الإشعارات
                        <span id="adminNotificationsBadge" class="notification-badge" style="display:none;">0</span>
                    </a>
                </li>
                
                <li style="margin-top:auto"><a href="#" onclick="logout()" style="color:#fca5a5"><i class="fas fa-sign-out-alt"></i> خروج</a></li>
            </ul>
        </aside>

        <main class="main-content">
            
            <!-- القسم الرئيسي -->
            <div id="adm-home" class="section active">
                <h2>الإحصائيات العامة</h2>
                <div class="stats-grid">
                    <div class="stat-card"><h3>الطلاب المسجلين</h3><div class="stat-num" id="stCount">0</div></div>
                    <div class="stat-card"><h3>الكورسات</h3><div class="stat-num" id="crCount">0</div></div>
                    <div class="stat-card"><h3>بنك الأسئلة</h3><div class="stat-num" id="qCountAll">0</div></div>
                </div>
                
                <h2>تحليل البيانات</h2>
                <div class="charts-grid">
                    <div class="chart-container">
                        <canvas id="gradeChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="questionsChart"></canvas>
                    </div>
                </div>
                <div class="chart-container" style="max-width:100%; height:300px;">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>

            <!-- قسم إدارة الكورسات -->
            <div id="adm-courses" class="section">
                <h2>إدارة الكورسات</h2>
                <div class="card">
                    <h3 id="courseFormTitle"><i class="fas fa-plus"></i> إضافة / تعديل كورس</h3>
                    <input type="hidden" id="cEditId" value="-1">
                    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;">
                        <input id="cName" class="form-control" placeholder="اسم الكورس">
                        <select id="cGrade" class="form-control"><option value="1">1ث</option><option value="2">2ث</option><option value="3">3ث</option></select>
                        <input type="number" id="cPrice" class="form-control" placeholder="السعر">
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                        <div>
                            <label style="font-size:12px; color:#666">تاريخ البدء:</label>
                            <input type="date" id="cStartDate" class="form-control">
                        </div>
                        <div>
                            <label style="font-size:12px; color:#666">تاريخ الانتهاء:</label>
                            <input type="date" id="cEndDate" class="form-control">
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <label style="font-size:14px; font-weight:bold;">حالة الكورس:</label>
                            <select id="cActive" class="form-control">
                                <option value="true">مفعل</option>
                                <option value="false">غير مفعل</option>
                            </select>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 3fr; gap:10px; margin-top:10px;">
                        <input type="number" id="cDiscount" class="form-control" placeholder="خصم %">
                        <input id="cDesc" class="form-control" placeholder="الوصف">
                    </div>
                    <div style="margin-top:10px;">
                        <label style="font-size:13px; color:#666">صورة الكورس (اختر ملف):</label>
                        <input type="file" id="cImgInput" class="form-control" accept="image/*" onchange="previewCourseImage(this)">
                        <div id="cImgPreview" style="margin-top:5px; max-width:100px; max-height:100px; overflow:hidden;"></div>
                    </div>
                    <div style="margin-top:15px; display:flex; gap:10px;">
                        <button class="btn btn-primary" id="btnSaveCourse" onclick="saveCourse()">حفظ الكورس <i class="fas fa-save"></i></button>
                        <button class="btn btn-dark" style="display:none;" id="btnCancelEdit" onclick="resetCourseForm()">إلغاء <i class="fas fa-times"></i></button>
                    </div>
                </div>
                
                <h3 style="border-bottom:2px solid var(--primary); padding-bottom:5px;">الكورسات المجدولة</h3>
                <div id="coursesList"></div>
            </div>

            <!-- قسم هيكل الكورس -->
            <div id="adm-structure" class="section">
                <h2>هيكل الكورس (وحدات ودروس)</h2>
                <div class="card">
                    <label>اختر الكورس لإضافة/تعديل المحتوى:</label>
                    <select id="strucCourse" class="form-control" onchange="loadStructureTree()"></select>
                    
                    <div id="addUnitArea" style="display:none; margin-top:15px; border-top:1px dashed #ccc; padding-top:15px;">
                        <div style="display:flex; gap:10px;">
                            <input id="uTitle" class="form-control" placeholder="اسم الوحدة الجديدة" style="margin:0; font-weight:bold;">
                            <button class="btn btn-success" onclick="addUnit()"><i class="fas fa-plus"></i> إضافة وحدة</button>
                        </div>
                    </div>
                </div>
                <div id="structureTree"></div>
            </div>

            <!-- قسم محتوى الدروس -->
            <div id="adm-content" class="section">
                <h2>إضافة محتوى الدروس</h2>
                <div class="card">
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                        <select id="contCourse" class="form-control" onchange="updContDrops('c')"></select>
                        <select id="contUnit" class="form-control" onchange="updContDrops('u')"></select>
                        <select id="contLesson" class="form-control" onchange="loadLessonContent()"></select>
                    </div>
                </div>

                <div id="lessonContentArea" style="display:none;">
                    <div class="content-selector" style="display:flex; gap:10px; margin-bottom:15px;">
                        <button class="btn tab-btn-video" onclick="switchTab('tab-video', this)">1. فيديو</button>
                        <button class="btn tab-btn-pdf" onclick="switchTab('tab-pdf', this)">2. ملف PDF</button>
                        <button class="btn tab-btn-quiz" onclick="switchTab('tab-quiz', this)">3. اختبار</button>
                    </div>

                    <div id="tab-video" class="content-tab active card">
                        <h4><i class="fas fa-video"></i> إدارة الفيديو (محمي)</h4>
                        
                        <div class="upload-type-selector">
                           <label class="type-option selected" onclick="selType(this, 'vidLinkGroup', 'vidFileGroup')">
                               <input type="radio" name="vidType" checked> رابط خارجي (يوتيوب، فيميو، زووم...)
                            </label>
                            <label class="type-option" onclick="selType(this, 'vidFileGroup', 'vidLinkGroup')">
                                <input type="radio" name="vidType"> رفع فيديو من الجهاز
                            </label>
                        </div>

                        <div id="vidLinkGroup">
                            <input type="text" id="vidUrl" class="form-control" placeholder="رابط الفيديو هنا...">
                        </div>
                        <div id="vidFileGroup" style="display:none;">
                            <input type="file" id="vidFile" class="form-control" accept="video/*">
                        </div>

                        <button class="btn btn-primary" onclick="addVideo()">إضافة للفيديو</button>
                        <div id="videoList" style="margin-top:10px;"></div>
                    </div>

                    <div id="tab-pdf" class="content-tab card">
                        <h4><i class="fas fa-file-pdf"></i> إدارة ملفات PDF (محمي)</h4>
                        
                        <div class="upload-type-selector">
                            <label class="type-option selected" onclick="selType(this, 'pdfFileGroup', 'pdfLinkGroup')">
                                <input type="radio" name="pdfType" checked> رفع ملف PDF
                            </label>
                            <label class="type-option" onclick="selType(this, 'pdfLinkGroup', 'pdfFileGroup')">
                                <input type="radio" name="pdfType"> رابط خارجي
                            </label>
                        </div>

                        <div id="pdfFileGroup">
                            <input type="file" id="pdfFile" class="form-control" accept="application/pdf" style="margin:0">
                        </div>
                        <div id="pdfLinkGroup" style="display:none;">
                            <input type="text" id="pdfUrl" class="form-control" placeholder="رابط ملف PDF...">
                        </div>

                         <button class="btn btn-success" style="margin-top:10px;" onclick="addPdf()"><i class="fas fa-plus"></i> إضافة</button>
                        <div id="pdfList" style="margin-top:10px;"></div>
                    </div>

                   <div id="tab-quiz" class="content-tab card">
    <h4><i class="fas fa-clipboard-check"></i> إضافة اختبار لهذا الدرس</h4>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
        <input type="date" id="qFrom" class="form-control" title="من تاريخ">
        <input type="date" id="qTo" class="form-control" title="إلى تاريخ">
        <input type="number" id="qDur" class="form-control" placeholder="المدة (د)">
    </div>
    
    <div class="quiz-settings">
        <label><input type="checkbox" id="randomOrder" checked> ترتيب عشوائي للأسئلة</label>
        <label><input type="checkbox" id="randomOptions" checked> ترتيب عشوائي للخيارات (اختيار متعدد)</label>
    </div>
    
    <div class="card" style="background:#f1f5f9; padding:15px; margin-top:15px; border:1px dashed var(--primary);">
        <h5><i class="fas fa-list-check"></i> اختر الأسئلة (من بنك الأسئلة لهذا الدرس):</h5>
        
        <div id="qBankSelectionList" style="max-height:300px; overflow-y:auto; margin-top:10px;"></div>
    </div>
    <button class="btn btn-success" style="margin-top:10px;" onclick="saveLessonQuiz()">حفظ الاختبار للدرس</button>
    <div id="currentQuizInfo" style="margin-top:10px;"></div>
</div>
                </div>
            </div>

            <!-- قسم إضافة الأسئلة -->
            <div id="adm-add-q" class="section">
                <h2>إضافة سؤال جديد</h2>
                
                <div class="card">
                    <h3>طريقة الإضافة</h3>
                    <div class="upload-type-selector">
                        <label class="type-option selected" onclick="toggleAddQMode('manual', this)">
                            <input type="radio" name="addQMethod" checked> إضافة يدوية
                        </label>
                        <label class="type-option" onclick="toggleAddQMode('import', this)">
                            <input type="radio" name="addQMethod"> استيراد قالب (Excel)
                        </label>
                    </div>
                </div>

                <div id="qManualSection" class="card">
                    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-bottom:15px;">
                        <select id="qCourse" class="form-control" onchange="updQDrops('c')"></select>
                        <select id="qUnit" class="form-control" onchange="updQDrops('u')"></select>
                        <select id="qLesson" class="form-control"></select>
                    </div>
                    <div style="display:flex; gap:15px; margin-bottom:15px;">
                        <select id="qType" class="form-control" onchange="renderQInputs()"><option value="mcq">اختيار</option><option value="tf">صح/خطأ</option><option value="fill">أكمل</option></select>
                        <select id="qLang" class="form-control" onchange="renderQInputs()"><option value="ar">عربي</option><option value="en">إنجليزي</option></select>
                    </div>
                    <div class="q-input-group">
                        <textarea id="qText" class="form-control q-text-area" placeholder="نص السؤال..."></textarea>
                        <label style="cursor:pointer; color:var(--primary); font-size:13px;"><i class="fas fa-image"></i> صورة <input type="file" id="qImg" style="display:none" onchange="previewImg(this, 'qImgPrev')"></label>
                        <img id="qImgPrev" class="preview-thumb">
                    </div>
                    <div id="answersArea" class="q-input-group" style="background:#f8fafc;"></div>
                    <div style="text-align:center;"><button class="btn btn-success" style="width:30%" onclick="saveQuestion()">حفظ السؤال</button></div>
                </div>

                <div id="qImportSection" class="card" style="display:none; background:#e0f2fe; border:1px dashed var(--primary);">
                    <h3>استيراد أسئلة من ملف Excel</h3>
                    <div style="margin-bottom:15px; padding:10px; background:white; border-radius:8px;">
                        <p style="margin:0 0 10px;">1. حدد مكان الأسئلة:</p>
                        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;">
                            <select id="impCourse" class="form-control" onchange="updImpDrops('c')"><option value="">الكورس</option></select>
                            <select id="impUnit" class="form-control" onchange="updImpDrops('u')"><option value="">الوحدة</option></select>
                            <select id="impLesson" class="form-control"><option value="">الدرس</option></select>
                        </div>
                    </div>
                    
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                         <p style="margin:0;">2. حمل القالب واملأه:</p>
                         <button onclick="downloadTemplate()" class="btn btn-dark btn-sm"><i class="fas fa-download"></i> تحميل القالب (Excel)</button>
                    </div>

                    <div style="display:flex; gap:10px; align-items:center;">
                        <p style="margin:0;">3. ارفع الملف:</p>
                        <input type="file" id="importFile" class="form-control" style="width:auto; margin:0;" accept=".xlsx, .xls, .csv">
                        <button class="btn btn-primary" onclick="importQs()">استيراد وحفظ</button>
                    </div>
                </div>
            </div>

            <!-- قسم الاختبارات المجمعة -->
            <div id="adm-comp-exams" class="section">
                <h2>الاختبارات المجمعة</h2>
                <div class="card">
                    <h3>إنشاء اختبار جديد</h3>
                    <input id="ceTitle" class="form-control" placeholder="اسم الاختبار (مثال: اختبار شامل على الوحدة الأولى)">
                    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-bottom:10px;">
                        <input type="date" id="ceFrom" class="form-control" title="من تاريخ">
                        <input type="date" id="ceTo" class="form-control" title="إلى تاريخ">
                        <input type="number" id="ceDur" class="form-control" placeholder="المدة (د)">
                    </div>
                    
                    <!-- إضافة خيارات ترتيب الأسئلة -->
                    <div class="quiz-settings">
                        <label><input type="checkbox" id="ceRandomOrder" checked> ترتيب عشوائي للأسئلة</label>
                        <label><input type="checkbox" id="ceRandomOptions" checked> ترتيب عشوائي للخيارات (اختيار متعدد)</label>
                    </div>
                    
                    <div style="margin-bottom:10px;">
                        <label>اختر المصدر:</label>
                        <select id="ceCourseSource" class="form-control" onchange="loadCompExamQuestions()">
                            <option value="">-- حدد --</option>
                            <option value="all">الجميع (كل الكورسات)</option>
                            </select>
                    </div>
                    
                    <div id="compExamQArea" style="display:none; border:1px solid #ccc; padding:15px; border-radius:8px; background:#fff; max-height:400px; overflow-y:auto;">
                        </div>
                    
                    <button class="btn btn-primary" style="margin-top:15px; width:100%" onclick="saveCompExam()">حفظ الاختبار المجمع</button>
                </div>
                
                <h3 style="margin-top:30px;">الاختبارات المجمعة الحالية</h3>
                <div id="compExamsList"></div>
            </div>

            <!-- قسم معاينة وطباعة -->
            <div id="adm-preview-q" class="section">
                <h2>معاينة وطباعة الأسئلة</h2>
                <div class="card no-print">
                    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;">
                        <select id="pCourse" class="form-control" onchange="updPDrops('c')"></select>
                        <select id="pUnit" class="form-control" onchange="updPDrops('u')"></select>
                        <select id="pLesson" class="form-control" onchange="loadQPreview()"></select>
                    </div>
                </div>

                <div id="printArea" class="card">
                    <div class="watermark">المنصة التعليمية</div>
                    <h3 style="text-align:center; border-bottom:2px solid #000; padding-bottom:10px;">
                        اختبار درس: <span id="printLessonName">---</span>
                    </h3>
                    <div id="qPreviewList" class="hide-answers"></div> 
                </div>
                
                <div class="card no-print" style="display:flex; justify-content:space-between;">
                    <button class="btn btn-dark" onclick="printWithMode(false)">طباعة (بدون إجابات)</button>
                    <button class="btn btn-success" style="background:var(--success)" onclick="printWithMode(true)">طباعة (مع الإجابات)</button>
                </div>
            </div>

            <!-- قسم إدارة الطلاب -->
            <div id="adm-students" class="section">
                <h2>إدارة الطلاب (تسكين)</h2>
                <div class="card">
                    <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:10px;">
                        <input id="stName" class="form-control" placeholder="اسم الطالب">
                        <input id="stPhone" class="form-control" placeholder="جوال الطالب">
                        <input id="stEmail" class="form-control" placeholder="إيميل">
                        <input id="pPhone" class="form-control" placeholder="جوال ولي الأمر">
                        <select id="stStatus" class="form-control"><option value="active">نشط</option><option value="inactive">غير نشط</option></select>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="btn btn-primary" onclick="addStudent()">حفظ وإرسال واتساب</button>
                        <button class="btn btn-success" onclick="exportEnrollments()"><i class="fas fa-file-excel"></i> تصدير التسكين (Excel)</button>
                    </div>
                </div>
                <div class="card">
                    <div class="data-table-container allow-copy">
                        <table id="studentsTable"><thead><tr><th>الاسم</th><th>بيانات الدخول</th><th>ولي الأمر</th><th>الحالة</th><th>تحكم</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
            </div>

            <!-- قسم إدارة كورسات الطلاب -->
            <div id="adm-st-courses" class="section">
                <h2>إدارة كورسات الطلاب</h2>
                <div class="card">
                    <input type="text" id="searchStCourses" class="form-control" placeholder="ابحث باسم الطالب..." onkeyup="renderStudentCoursesManagement()">
                    <div class="data-table-container">
                        <table id="stCoursesMgmtTable">
                            <thead><tr><th>اسم الطالب</th><th>الكورسات المسجل بها</th><th>تحكم</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
            </div>

            <!-- قسم أداء الطلاب -->
            <div id="adm-performance" class="section">
                <h2>أداء الطلاب</h2>
                <div class="stats-grid">
                    <div class="stat-card"><h3>الطلاب</h3><div class="stat-num" id="statTotalSt">0</div></div>
                    <div class="stat-card"><h3>المتوسط</h3><div class="stat-num" id="statAvg">0%</div></div>
                </div>
                <div class="card">
                    <h3>تفاصيل الدرجات (دروس + مجمعة)</h3>
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <select id="perfCourse" class="form-control" onchange="updatePerfDrops('c')"><option value="all">كل الكورسات</option></select>
                        <select id="perfUnit" class="form-control" onchange="updatePerfDrops('u')"><option value="all">كل الوحدات</option></select>
                        <select id="perfLesson" class="form-control" onchange="loadDetailedGrades()"><option value="all">كل الدروس</option></select>
                    </div>
                    <div class="data-table-container">
                        <table id="detailedGradesTable"><thead><tr><th>الطالب</th><th>الكورس/النوع</th><th>الاختبار</th><th>الدرجة</th><th>الحالة</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
                <div class="card" style="border-top:4px solid green;">
                    <h3>الأوائل</h3>
                    <div class="data-table-container">
                        <table id="topTable"><thead><tr><th>#</th><th>الطالب</th><th>النسبة</th><th>تهنئة الطالب</th><th>تهنئة ولي الأمر</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
                <div class="card" style="border-top:4px solid red;">
                    <h3>المقصرين</h3>
                    <div class="data-table-container">
                        <table id="lowTable"><thead><tr><th>الطالب</th><th>النسبة</th><th>تنبيه ولي الأمر</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
            </div>

            <!-- === قسم تقارير الاختبارات المجمعة الجديد === -->
            <div id="adm-reports-comp" class="section">
                <h2>تقارير الاختبارات المجمعة</h2>
                <div class="card">
                    <div class="filter-bar">
                        <select id="reportCompExamFilter" class="form-control" onchange="loadCompExamReports()">
                            <option value="all">جميع الاختبارات</option>
                        </select>
                        <select id="reportCompStudentFilter" class="form-control" onchange="loadCompExamReports()">
                            <option value="all">جميع الطلاب</option>
                        </select>
                        <select id="reportCompDateFilter" class="form-control" onchange="loadCompExamReports()">
                            <option value="all">جميع الفترات</option>
                            <option value="week">آخر أسبوع</option>
                            <option value="month">آخر شهر</option>
                            <option value="3months">آخر 3 أشهر</option>
                        </select>
                        <button class="btn btn-success export-btn" onclick="exportCompExamReports()">
                            <i class="fas fa-file-excel"></i> تصدير Excel
                        </button>
                    </div>
                    
                    <div id="compExamStats" style="margin: 20px 0; display: flex; flex-wrap: wrap; gap: 15px;">
                        <!-- سيتم تعبئتها بالبيانات -->
                    </div>
                    
                    <div class="report-card">
                        <div class="report-header">
                            <h3 style="margin:0;">تفاصيل أداء الطلاب</h3>
                        </div>
                        <div class="data-table-container">
                            <table id="compExamReportsTable">
                                <thead>
                                    <tr>
                                        <th>اسم الطالب</th>
                                        <th>الاختبار</th>
                                        <th>الدرجة</th>
                                        <th>النسبة</th>
                                        <th>التاريخ</th>
                                        <th>الحالة</th>
                                        <th>التفاصيل</th>
                                    </tr>
                                </thead>
                                <tbody id="compExamReportsBody">
                                    <!-- سيتم تعبئتها بالبيانات -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="report-card">
                        <div class="report-header">
                            <h3 style="margin:0;">تحليل النتائج</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="chart-container">
                                <canvas id="compExamChart1"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="compExamChart2"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- === قسم تقارير "أختبر نفسي" الجديد === -->
            <div id="adm-reports-self" class="section">
                <h2>تقارير "أختبر نفسي" (التدريب الذاتي)</h2>
                <div class="card">
                    <div class="filter-bar">
                        <select id="reportSelfStudentFilter" class="form-control" onchange="loadSelfTestReports()">
                            <option value="all">جميع الطلاب</option>
                        </select>
                        <select id="reportSelfCourseFilter" class="form-control" onchange="loadSelfTestReports()">
                            <option value="all">جميع الكورسات</option>
                        </select>
                        <select id="reportSelfDateFilter" class="form-control" onchange="loadSelfTestReports()">
                            <option value="all">جميع الفترات</option>
                            <option value="today">اليوم</option>
                            <option value="week">آخر أسبوع</option>
                            <option value="month">آخر شهر</option>
                        </select>
                        <button class="btn btn-success export-btn" onclick="exportSelfTestReports()">
                            <i class="fas fa-file-excel"></i> تصدير Excel
                        </button>
                    </div>
                    
                    <div id="selfTestStats" style="margin: 20px 0; display: flex; flex-wrap: wrap; gap: 15px;">
                        <!-- سيتم تعبئتها بالبيانات -->
                    </div>
                    
                    <div class="report-card">
                        <div class="report-header">
                            <h3 style="margin:0;">تفاصيل جلسات "أختبر نفسي"</h3>
                        </div>
                        <div class="data-table-container">
                            <table id="selfTestReportsTable">
                                <thead>
                                    <tr>
                                        <th>اسم الطالب</th>
                                        <th>الكورس</th>
                                        <th>عدد الأسئلة</th>
                                        <th>الدرجة</th>
                                        <th>النسبة</th>
                                        <th>المستوى</th>
                                        <th>التاريخ</th>
                                        <th>التفاصيل</th>
                                    </tr>
                                </thead>
                                <tbody id="selfTestReportsBody">
                                    <!-- سيتم تعبئتها بالبيانات -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="report-card">
                        <div class="report-header">
                            <h3 style="margin:0;">تحليل النشاط التدريبي</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="chart-container">
                                <canvas id="selfTestChart1"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="selfTestChart2"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="report-card">
                        <div class="report-header">
                            <h3 style="margin:0;">الطلاب الأكثر نشاطاً في التدريب</h3>
                        </div>
                        <div class="data-table-container">
                            <table id="topActiveStudentsTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>اسم الطالب</th>
                                        <th>عدد الجلسات</th>
                                        <th>متوسط النسبة</th>
                                        <th>إجمالي الأسئلة</th>
                                        <th>آخر نشاط</th>
                                    </tr>
                                </thead>
                                <tbody id="topActiveStudentsBody">
                                    <!-- سيتم تعبئتها بالبيانات -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- === قسم طلبات الاشتراك الجديد === -->
            <div id="adm-requests" class="section">
                <h2>طلبات الاشتراك في الكورسات</h2>
                <div class="card">
                    <div class="filter-bar">
                        <select id="requestStatusFilter" class="form-control" onchange="loadSubscriptionRequests()">
                            <option value="all">جميع الطلبات</option>
                            <option value="pending">قيد الانتظار</option>
                            <option value="approved">مقبولة</option>
                            <option value="rejected">مرفوضة</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadSubscriptionRequests()"><i class="fas fa-sync"></i> تحديث</button>
                    </div>
                    
                    <div class="data-table-container">
                        <table id="subscriptionRequestsTable">
                            <thead>
                                <tr>
                                    <th>اسم الطالب</th>
                                    <th>رقم الجوال</th>
                                    <th>الكورس المطلوب</th>
                                    <th>تاريخ الطلب</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="subscriptionRequestsBody">
                                <!-- سيتم تعبئتها بالبيانات -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- === قسم الإشعارات الجديد === -->
            <div id="adm-notifications" class="section">
                <h2>الإشعارات</h2>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 style="margin:0;">الإشعارات الحديثة</h3>
                        <button class="btn btn-danger btn-sm" onclick="clearAllNotifications('admin')">حذف الكل</button>
                    </div>
                    
                    <div id="adminNotificationsList" style="max-height: 500px; overflow-y: auto;">
                        <!-- سيتم تعبئتها بالإشعارات -->
                    </div>
                </div>
            </div>

        </main>
        
        <!-- زر شات الأدمن -->
        <div class="admin-chat-btn" onclick="toggleAdminChat()" id="adminChatBtn">
            <i class="fas fa-comments"></i>
            <span id="adminChatBadge" class="notification-badge" style="display:none;">0</span>
        </div>
        
        <!-- نافذة شات الأدمن -->
        <div id="adminChat" class="admin-chat-container">
            <div class="admin-chat-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div>
                        <h4 style="margin:0;">محادثات الطلاب</h4>
                        <small id="adminChatStatus" style="font-size:12px;">إجمالي الرسائل: <span id="totalMessages">0</span></small>
                    </div>
                </div>
                <button class="btn-icon" onclick="toggleAdminChat()" style="background:transparent; color:white;">X</button>
            </div>
            <div style="display:flex; height:300px;">
                <div class="admin-chat-students" id="adminChatStudents">
                    <!-- قائمة الطلاب -->
                </div>
                <div class="admin-chat-messages" id="adminChatMessages">
                    <!-- الرسائل -->
                </div>
            </div>
            <div class="admin-chat-input-area">
                <input type="text" id="adminChatInput" class="form-control" placeholder="اكتب ردك هنا..." style="margin:0;">
                <button class="btn btn-primary" onclick="sendAdminChatMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- لوحة الطالب -->
    <div id="student-panel" class="app-container" style="flex-direction: column;">
        <header class="st-header" style="background:var(--dark); color:white; padding:15px; display:flex; justify-content:space-between; align-items:center;">
            <div style="display:flex; align-items:center; gap:15px;">
                <div>
                    <strong>مرحباً <span id="stNameDisplay" style="color:var(--accent)"></span></strong>
                </div>
                <!-- صورة الملف الشخصي -->
                <img id="studentProfileImg" src="" alt="صورة الملف الشخصي" class="student-profile-img" onclick="openProfileEditModal()">
                <!-- أيقونة الإشعارات -->
                <div style="position:relative; cursor:pointer;" onclick="stNav('st-notifications')">
                    <i class="fas fa-bell" style="font-size:20px; color:#ccc;"></i>
                    <span id="studentNotificationsBadge" class="notification-badge" style="display:none;">0</span>
                </div>
                <!-- أيقونة الطلبات -->
                <div style="position:relative; cursor:pointer;" onclick="stNav('st-requests')">
                    <i class="fas fa-clipboard-list" style="font-size:20px; color:#ccc;"></i>
                    <span id="studentRequestsBadge" class="notification-badge" style="display:none;">0</span>
                </div>
            </div>
            <div style="display:flex; gap:10px; overflow-x:auto;">
                <button class="btn btn-dark" onclick="stNav('st-home')">الرئيسية</button>
                <button class="btn btn-dark" onclick="stNav('st-courses')">كورساتي</button>
                <button class="btn btn-dark" onclick="stNav('st-files')"><i class="fas fa-file-alt"></i> الملفات</button>
                <button class="btn btn-dark" onclick="stNav('st-subscribe')">الاشتراك</button>
                <button class="btn btn-dark" onclick="stNav('st-all-exams')">الاختبارات</button>
                <button class="btn btn-dark" onclick="stNav('st-self-test')"><i class="fas fa-brain"></i> أختبر نفسي</button>
                <button class="btn btn-dark" onclick="stNav('st-stats')">أدائي</button>
                <button class="btn btn-dark" onclick="stNav('st-profile')"><i class="fas fa-user"></i> حسابي</button>
                <button class="btn btn-danger" onclick="logout()">خروج</button>
            </div>
        </header>

        <main class="main-content" style="user-select: none;" oncontextmenu="return false;">
            <div id="st-home" class="section active">
                <h2>لوحة المعلومات</h2>
                <div class="stats-grid">
                    <div class="stat-card"><h3>الكورسات المشتركة</h3><div class="stat-num" id="stStatsCourses">0</div></div>
                    <div class="stat-card"><h3>الاختبارات المنجزة</h3><div class="stat-num" id="stStatsExams">0</div></div>
                    <div class="stat-card"><h3>الأسئلة المحلولة</h3><div class="stat-num" id="stStatsQs">0</div></div>
                    <div class="stat-card"><h3>مستوى الأداء</h3><div class="stat-num" id="stStatsLvl">--</div></div>
                </div>
                <div class="card"><canvas id="stChart" style="max-height:250px;"></canvas></div>
            </div>

            <!-- قسم كورساتي المعدل -->
            <div id="st-courses" class="section">
                <h2 style="border-bottom:2px solid var(--primary); padding-bottom:10px;">كورساتي المسجلة</h2>
                <div id="stMyCourses" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:20px; margin-bottom:30px;"></div>
                
                <!-- تبويبات المحتوى (تظهر بعد اختيار كورس) -->
                <div id="courseContentTabs" style="display:none;">
                    <div class="student-course-tabs">
                        <button class="student-tab-btn active" onclick="switchStudentTab('videos-tab', this)">الفيديوهات</button>
                        <button class="student-tab-btn" onclick="switchStudentTab('files-tab', this)">الملفات</button>
                        <button class="student-tab-btn" onclick="switchStudentTab('quizzes-tab', this)">الاختبارات</button>
                    </div>
                    
                    <div id="videos-tab" class="student-tab-content active">
                        <h3><i class="fas fa-video"></i> فيديوهات الكورس</h3>
                        <div id="courseVideosList" class="student-video-grid"></div>
                    </div>
                    
                    <div id="files-tab" class="student-tab-content">
                        <h3><i class="fas fa-file-pdf"></i> ملفات الكورس</h3>
                        <div id="courseFilesList" class="student-file-grid"></div>
                    </div>
                    
                    <div id="quizzes-tab" class="student-tab-content">
                        <h3><i class="fas fa-clipboard-check"></i> اختبارات الكورس</h3>
                        <div id="courseQuizzesList" class="student-quiz-list"></div>
                    </div>
                </div>
            </div>

            <div id="st-subscribe" class="section">
                <h2 style="border-bottom:2px solid #ccc; padding-bottom:10px;">الكورسات المتاحة للاشتراك</h2>
                <div id="stOtherCourses" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:20px;"></div>
            </div>

            <div id="st-files" class="section">
                <h2><i class="fas fa-folder-open"></i> ملفات الكورس</h2>
                <div class="card">
                    <label>اختر الكورس لعرض ملفاته:</label>
                    <select id="stFileCourse" class="form-control" onchange="renderStudentFiles()"></select>
                </div>
                <div id="stFilesDisplay"></div>
            </div>
            
            <div id="st-self-test" class="section">
                <h2><i class="fas fa-brain"></i> أختبر نفسي (تدريب)</h2>
                <div class="card">
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
                        <div>
                            <label>اختر الكورس:</label>
                            <select id="selfTestCourse" class="form-control" onchange="updSelfTestUnits()"></select>
                        </div>
                        <div>
                            <label>اختر الوحدة:</label>
                            <select id="selfTestUnit" class="form-control"><option value="all">كل المنهج</option></select>
                        </div>
                        <div>
                            <label>عدد الأسئلة:</label>
                            <input type="number" id="selfTestCount" class="form-control" value="10" min="5" max="50">
                        </div>
                    </div>
                    <button class="btn btn-primary" style="margin-top:15px;" onclick="generateSelfTest()">ابدأ التدريب الآن</button>
                </div>
            </div>

            <div id="st-viewer" class="section">
                <button class="btn btn-dark" onclick="stNav('st-courses')">رجوع للكورسات</button>
                <div style="display:flex; gap:20px; margin-top:20px; flex-wrap:wrap;">
                    <div style="width:280px; background:white; padding:15px; border-radius:10px; max-height:80vh; overflow-y:auto;" id="stUnitMenu"></div>
                    <div style="flex:1; background:white; padding:20px; border-radius:10px; min-width:300px;">
                        <h2 id="stLessonTitle" style="color:var(--primary);"></h2>
                        <div id="stContentArea"></div>
                    </div>
                </div>
            </div>

            <div id="st-all-exams" class="section">
                <h2>الاختبارات</h2>
                <h3 style="color:var(--primary)">الاختبارات المجمعة</h3>
                <div id="stCompExamsList" style="margin-bottom:20px;"></div>
                <h3 style="color:var(--primary)">اختبارات الدروس</h3>
                <div id="stExamsList"></div>
            </div>

            <div id="st-quiz-active" class="section">
                <button class="btn btn-dark" onclick="stNav('st-all-exams')" style="margin-bottom:10px;">رجوع للقائمة</button>
                <div id="stQuizArea" class="compact-quiz-area">
                    <div class="quiz-header">
                        <span id="takingQuizTitle"></span>
                        <div class="quiz-timer" id="quizTimer"></div>
                    </div>
                    <div class="q-nav" id="qNavDots"></div>
                    <div id="quizQuestionContainer"></div>
                    <div style="display:flex; justify-content:space-between; margin-top:20px;">
                        <button class="btn btn-dark" onclick="prevQ()">سابق</button>
                        <button class="btn btn-primary" onclick="nextQ()">تالي</button>
                        <button class="btn btn-success" onclick="submitQuiz()">تسليم</button>
                    </div>
                </div>
            </div>

            <div id="st-stats" class="section">
                <h2>أدائي</h2>
                <div class="performance-stats">
                    <div class="performance-card">
                        <div class="performance-value" id="myScoreAvg">0%</div>
                        <div class="performance-label">متوسط الأداء</div>
                    </div>
                    <div class="performance-card">
                        <div class="performance-value" id="myCompleted">0</div>
                        <div class="performance-label">الدروس المكتملة</div>
                    </div>
                    <div class="performance-card">
                        <div class="performance-value" id="myLevel">--</div>
                        <div class="performance-label">مستوى الأداء</div>
                    </div>
                    <div class="performance-card">
                        <div class="performance-value" id="myTotalExams">0</div>
                        <div class="performance-label">الاختبارات المنجزة</div>
                    </div>
                </div>
                <div class="card">
                    <h3>سجل الاختبارات</h3>
                    <div class="data-table-container">
                        <table id="stHistoryTable">
                            <thead><tr><th>الاختبار</th><th>النوع</th><th>الدرجة</th><th>التاريخ</th><th>مراجعة</th><th>إعادة</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
            </div>
            
            <!-- قسم حساب الطالب (الملف الشخصي) -->
            <div id="st-profile" class="section">
                <h2><i class="fas fa-user"></i> حسابي الشخصي</h2>
                <div class="card">
                    <div style="display:flex; align-items:center; gap:30px; margin-bottom:20px;">
                        <div>
                            <img id="profileDisplayImg" src="" alt="صورة الملف الشخصي" class="student-profile-img">
                            <label class="profile-upload-label">
                                <i class="fas fa-camera"></i> تغيير الصورة
                                <input type="file" id="profileImageUpload" style="display:none" accept="image/*" onchange="uploadProfileImage(this)">
                            </label>
                        </div>
                        <div style="flex:1;">
                            <h3 id="profileStudentName"></h3>
                            <p id="profileStudentPhone"></p>
                            <p id="profileStudentGrade"></p>
                        </div>
                    </div>
                    
                    <h3>تعديل البيانات الشخصية</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:15px;">
                        <input type="text" id="profileName" class="form-control" placeholder="الاسم الثلاثي">
                        <input type="email" id="profileEmail" class="form-control" placeholder="البريد الإلكتروني">
                        <input type="text" id="profileParentPhone" class="form-control" placeholder="جوال ولي الأمر">
                        <select id="profileGrade" class="form-control">
                            <option value="">اختر الصف الدراسي</option>
                            <option value="1">أول ثانوي</option>
                            <option value="2">ثاني ثانوي</option>
                            <option value="3">ثالث ثانوي</option>
                        </select>
                        <input type="password" id="profilePassword" class="form-control" placeholder="كلمة المرور الجديدة (اتركه فارغاً للحفاظ على الحالي)">
                        <input type="password" id="profileConfirmPassword" class="form-control" placeholder="تأكيد كلمة المرور الجديدة">
                    </div>
                    <button class="btn btn-primary" style="margin-top:15px;" onclick="updateStudentProfile()">حفظ التعديلات</button>
                </div>
            </div>
            
            <!-- قسم طلبات الطالب -->
            <div id="st-requests" class="section">
                <h2><i class="fas fa-clipboard-list"></i> طلباتي</h2>
                <div class="card">
                    <h3>طلبات الاشتراك في الكورسات</h3>
                    <div class="data-table-container">
                        <table id="studentRequestsTable">
                            <thead>
                                <tr>
                                    <th>الكورس المطلوب</th>
                                    <th>تاريخ الطلب</th>
                                    <th>الحالة</th>
                                    <th>الملاحظات</th>
                                </tr>
                            </thead>
                            <tbody id="studentRequestsBody">
                                <!-- سيتم تعبئتها بالبيانات -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- قسم إشعارات الطالب -->
            <div id="st-notifications" class="section">
                <h2><i class="fas fa-bell"></i> الإشعارات</h2>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 style="margin:0;">إشعاراتي</h3>
                        <button class="btn btn-danger btn-sm" onclick="clearAllNotifications('student')">حذف الكل</button>
                    </div>
                    
                    <div id="studentNotificationsList" style="max-height: 500px; overflow-y: auto;">
                        <!-- سيتم تعبئتها بالإشعارات -->
                    </div>
                </div>
            </div>
            
            <!-- زر التحدث مع المعلم -->
            <div class="teacher-chat-btn" onclick="toggleTeacherChat()">
                <i class="fas fa-comment-dots"></i>
                <div id="teacherStatus" class="teacher-status online"></div>
            </div>
            
            <!-- نافذة الشات مع المعلم -->
            <div id="teacherChat" class="chat-container">
                <div class="chat-header">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div id="chatTeacherStatus" class="teacher-status online"></div>
                        <div>
                            <h4 style="margin:0;">التحدث مع المعلم</h4>
                            <small id="chatStatusText" style="font-size:12px;">أونلاين - يجيب خلال دقائق</small>
                        </div>
                    </div>
                    <button class="btn-icon" onclick="toggleTeacherChat()" style="background:transparent; color:white;">X</button>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message teacher">
                        <strong>المعلم:</strong> مرحباً، كيف يمكنني مساعدتك اليوم؟
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="chatInput" class="form-control" placeholder="اكتب رسالتك هنا..." style="margin:0;">
                    <button class="btn btn-primary" onclick="sendChatMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
            
            <div class="ai-btn" onclick="window.open('https://gemini.google.com', '_blank')"><i class="fas fa-robot"></i></div>
        </main>
    </div>

    <!-- لوحة ولي الأمر -->
    <div id="parent-panel" class="app-container" style="flex-direction: column;">
        <header class="st-header" style="background:var(--dark); color:white; padding:15px; display:flex; justify-content:space-between;">
            <div> ولي أمر الطالب: <span id="parentStName" style="color:var(--primary); font-weight:bold;"></span></div>
            <button class="btn btn-danger" onclick="logout()">خروج</button>
        </header>
        <main class="main-content">
            <div class="card">
                <h3>ملخص الأداء</h3>
                <div class="stats-grid">
                    <div class="stat-card"><h3>الكورسات</h3><div class="stat-num" id="pCoursesCount">0</div></div>
                    <div class="stat-card"><h3>الاختبارات</h3><div class="stat-num" id="pExamsCount">0</div></div>
                    <div class="stat-card"><h3>المتوسط</h3><div class="stat-num" id="pAvg">0%</div></div>
                </div>
                <h4>التفاصيل:</h4>
                <div class="data-table-container">
                    <table id="pDetailedTable"><thead><tr><th>الكورس</th><th>الدرس/الاختبار</th><th>الدرجة</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </main>
    </div>

    <!-- نافذة مراجعة الإجابات -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>مراجعة الإجابات</h3>
                <button class="btn-icon delete" onclick="document.getElementById('reviewModal').classList.remove('active')">X</button>
            </div>
            <div id="reviewContent" style="margin-top:20px;"></div>
        </div>
    </div>

    <!-- نافذة تسكين الطالب -->
    <div id="enrollModal" class="modal">
        <div class="modal-content" style="width: 400px;">
            <h3 style="margin-top:0;">تسكين الطالب في كورس</h3>
            <p id="enrollStName" style="color:#666; font-weight:bold;"></p>
            <label>اختر الكورس:</label>
            <select id="enrollCourseSelect" class="form-control"></select>
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
                <button class="btn btn-dark" onclick="closeEnrollModal()">إغلاق</button>
                <button class="btn btn-primary" onclick="confirmEnroll()">تأكيد التسكين</button>
            </div>
        </div>
    </div>
    
    <!-- نافذة طلاب الكورس -->
    <div id="courseStudentsModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>الطلاب المسجلين في الكورس</h3>
                <button class="btn-icon delete" onclick="document.getElementById('courseStudentsModal').classList.remove('active')">X</button>
            </div>
            <h4 style="color:var(--primary)" id="modalCourseName"></h4>
            <div class="data-table-container">
                <table id="courseStudentsTable"><thead><tr><th>اسم الطالب</th><th>الجوال</th><th>تحكم</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </div>
    
    <!-- نافذة تعديل السؤال -->
    <div id="editQuestionModal" class="modal">
        <div class="modal-content" style="width: 800px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0;">تعديل السؤال</h3>
                <button class="btn-icon delete" onclick="closeEditQuestionModal()">X</button>
            </div>
            <div id="editQuestionForm"></div>
        </div>
    </div>

    <!-- نافذة تعديل محتوى الدرس -->
    <div id="editContentModal" class="modal">
        <div class="modal-content" style="width: 600px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0;">تعديل المحتوى</h3>
                <button class="btn-icon delete" onclick="closeEditContentModal()">X</button>
            </div>
            <div id="editContentForm"></div>
        </div>
    </div>

    <!-- نافذة تعديل الاختبار المجمع -->
    <div id="editCompExamModal" class="modal">
        <div class="modal-content" style="width: 800px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0;">تعديل الاختبار المجمع</h3>
                <button class="btn-icon delete" onclick="closeEditCompExamModal()">X</button>
            </div>
            <div id="editCompExamForm"></div>
        </div>
    </div>

    <script>
        // --- Database & Global Vars ---
        const db = JSON.parse(localStorage.getItem('lmsV19DB')) || { 
            courses: [], 
            questions: [], 
            students: {}, 
            compExams: [],
            subscriptionRequests: [],
            notifications: [],
            chatMessages: [],
            teachers: {
                'admin': {
                    id: 'admin',
                    name: 'المعلم الرئيسي',
                    status: 'online',
                    lastActive: Date.now()
                }
            }
        };
        if(!db.compExams) db.compExams = [];
        if(!db.subscriptionRequests) db.subscriptionRequests = [];
        if(!db.notifications) db.notifications = [];
        if(!db.chatMessages) db.chatMessages = [];
        if(!db.teachers) db.teachers = {
            'admin': {
                id: 'admin',
                name: 'المعلم الرئيسي',
                status: 'online',
                lastActive: Date.now()
            }
        };

        let currentUser = null;
        let examTimerInterval = null;
        let currentQuiz = { qs:[], answers:{}, time:0, idx:0, context: {}, randomOrder: true, randomOptions: true };
        let currentStudentForEnroll = null;
        let editingCourseId = -1;
        let adminCharts = { grade: null, questions: null, activity: null };
        let editingQuestionId = null;
        let teacherChatOpen = false;
        let adminChatOpen = false;
        let selectedChatStudent = null;
        let currentCourseContent = null;

        // === دالة تحديد الكل العامة ===
function toggleAllCheckboxes(containerId, sourceCheckbox) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    // تجنب تحديد checkbox المصدر نفسه
    const checkboxes = container.querySelectorAll('input[type="checkbox"]');
    
    Array.from(checkboxes).forEach(cb => {
        if (cb !== sourceCheckbox) {
            cb.checked = sourceCheckbox.checked;
        }
    });
}

        function saveDB() { localStorage.setItem('lmsV19DB', JSON.stringify(db)); }

        // --- Auth ---
        function toggleAuthMode(mode, btn) {
            document.querySelectorAll('.auth-toggle button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('login-form').style.display = mode==='login'?'block':'none';
            document.getElementById('register-form').style.display = mode==='register'?'block':'none';
        }
        
        function login() {
            const u = document.getElementById('lUser').value.trim();
            const p = document.getElementById('lPass').value.trim();
            if ((u==='admin'&&p==='123') || (u==='Mahmoud Elsayed'&&p==='Ma@52#19$90**')) {
                document.getElementById('auth-screen').style.display='none';
                document.getElementById('admin-panel').classList.add('active');
                initAdmin();
                // تحديث حالة المعلم
                if(db.teachers['admin']) {
                    db.teachers['admin'].status = 'online';
                    db.teachers['admin'].lastActive = Date.now();
                    saveDB();
                }
            } else if(db.students[u]) {
                const st = db.students[u];
                if(st.pass===p) {
                    if(st.status!=='active') return alert('حساب غير نشط');
                    currentUser=st; currentUser.id=u; showPanel('student-panel'); initStudent();
                } else if(st.pPass===p) {
                    currentUser=st; currentUser.id=u; showPanel('parent-panel'); initParent();
                } else alert('كلمة المرور خطأ');
            } else alert('المستخدم غير موجود');
        }
        
        function registerStudent() {
            const d = {
                name: document.getElementById('rName').value,
                phone: document.getElementById('rPhone').value,
                pPhone: document.getElementById('rParent').value,
                pass: document.getElementById('rPass').value,
                pPass: document.getElementById('rParentPass').value,
                grade: document.getElementById('rGrade').value,
                status: 'active', 
                courses: [], 
                history: [], 
                tasks: [],
                profileImage: null,
                email: document.getElementById('rEmail').value || '',
                subscriptionRequests: []
            };
            if(!d.name || !d.phone || !d.pass) return alert('أكمل البيانات');
            if(db.students[d.phone]) return alert('مسجل مسبقاً');
            db.students[d.phone] = d; saveDB();
            alert('تم التسجيل بنجاح!');
            toggleAuthMode('login', document.querySelector('.auth-toggle button'));
        }
        
        function showPanel(id){ 
            document.getElementById('auth-screen').style.display='none'; 
            document.querySelectorAll('.app-container').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active'); 
        }
        
        function logout(){ 
            if(currentUser && currentUser.id === 'admin' && db.teachers['admin']) {
                db.teachers['admin'].status = 'offline';
                db.teachers['admin'].lastActive = Date.now();
                saveDB();
            }
            location.reload(); 
        }
        
        function nav(id){ 
            document.querySelectorAll('#admin-panel .section').forEach(s=>s.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); 
            document.querySelectorAll('.sidebar .active').forEach(a=>a.classList.remove('active'));
            event.target.classList.add('active');
            
            // تحميل التقارير عند الدخول للأقسام الجديدة
            if(id === 'adm-reports-comp') {
                loadCompExamReportsFilters();
                loadCompExamReports();
            }
            if(id === 'adm-reports-self') {
                loadSelfTestReportsFilters();
                loadSelfTestReports();
            }
            if(id === 'adm-requests') {
                loadSubscriptionRequests();
            }
            if(id === 'adm-notifications') {
                loadAdminNotifications();
            }
            
            if(id.includes('add-q')) renderQInputs(); 
            if(id.includes('preview-q')) updPDrops('init'); 
            if(id === 'adm-performance') updatePerformancePage(); 
            if(id === 'adm-home') updateStats(); 
            if(id === 'adm-comp-exams') { updateCompExamSources(); renderCompExams(); }
            if(id === 'adm-st-courses') renderStudentCoursesManagement();
        }

        function stNav(id){ 
            document.querySelectorAll('#student-panel .section').forEach(s=>s.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); 
            if(id==='st-home') renderStudentDashboard();
            if(id==='st-courses') renderMyCourses();
            if(id==='st-subscribe') renderSubscribe();
            if(id==='st-all-exams') renderAllExams();
            if(id==='st-stats') renderStStatsTable();
            if(id==='st-self-test') renderSelfTestSetup();
            if(id==='st-files') {
                document.getElementById('stFilesDisplay').innerHTML = ''; 
                const sel = document.getElementById('stFileCourse');
                sel.innerHTML = '<option value="">اختر الكورس...</option>';
                if(currentUser.courses) {
                    currentUser.courses.forEach(cid => {
                        const c = db.courses.find(x => x.id === cid);
                        if(c) sel.innerHTML += `<option value="${cid}">${c.name}</option>`;
                    });
                }
            }
            if(id==='st-profile') loadStudentProfile();
            if(id==='st-requests') loadStudentRequests();
            if(id==='st-notifications') loadStudentNotifications();
        }

        // --- Admin Logic ---
        function initAdmin(){ 
            renderCourses(); 
            updateDrops(); 
            renderStudentsTable(); 
            updateStats(); 
            loadAdminNotifications();
            checkNotifications();
            loadAdminChatStudents();
            // تحديث حالة المعلم
            if(db.teachers['admin']) {
                db.teachers['admin'].status = 'online';
                db.teachers['admin'].lastActive = Date.now();
                saveDB();
            }
        }
        
        // --- Course Management ---
        function previewCourseImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('cImgPreview').innerHTML = `<img src="${e.target.result}" style="width:100%; border-radius:5px;">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function resetCourseForm() {
            document.getElementById('cName').value = '';
            document.getElementById('cPrice').value = '';
            document.getElementById('cGrade').value = '1';
            document.getElementById('cDiscount').value = '';
            document.getElementById('cDesc').value = '';
            document.getElementById('cStartDate').value = '';
            document.getElementById('cEndDate').value = '';
            document.getElementById('cActive').value = 'true';
            document.getElementById('cImgInput').value = '';
            document.getElementById('cImgPreview').innerHTML = '';
            
            document.getElementById('cEditId').value = -1;
            document.getElementById('courseFormTitle').innerHTML = '<i class="fas fa-plus"></i> إضافة كورس جديد';
            document.getElementById('btnSaveCourse').innerText = 'حفظ الكورس';
            document.getElementById('btnCancelEdit').style.display = 'none';
        }

        function saveCourse() {
            const id = parseInt(document.getElementById('cEditId').value);
            const isEdit = id !== -1;
            const fileInput = document.getElementById('cImgInput');
            
            const processSave = (imgData) => {
                const cData = {
                    name: document.getElementById('cName').value,
                    grade: document.getElementById('cGrade').value,
                    price: document.getElementById('cPrice').value,
                    discount: document.getElementById('cDiscount').value,
                    desc: document.getElementById('cDesc').value,
                    startDate: document.getElementById('cStartDate').value,
                    endDate: document.getElementById('cEndDate').value,
                    active: document.getElementById('cActive').value === 'true',
                    image: imgData, 
                };

                if(!cData.name || !cData.price) return alert('يرجى إدخال الاسم والسعر');

                if (isEdit) {
                    const idx = db.courses.findIndex(x => x.id === id);
                    if(idx > -1) {
                        if(imgData === null) cData.image = db.courses[idx].image;
                        cData.units = db.courses[idx].units;
                        cData.id = id; 
                        db.courses[idx] = cData;
                        alert('تم تحديث الكورس');
                    }
                } else {
                    cData.id = Date.now();
                    cData.units = [];
                    db.courses.push(cData);
                    alert('تم إضافة الكورس');
                }
                
                saveDB();
                renderCourses();
                updateDrops();
                resetCourseForm();
                
                // إضافة إشعار
                addNotification('system', 'admin', `تم ${isEdit ? 'تحديث' : 'إضافة'} كورس: ${cData.name}`, 'info');
            };

            if(fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) { processSave(e.target.result); };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                processSave(null);
            }
        }

        function editCourse(i) {
            const c = db.courses[i];
            document.getElementById('cEditId').value = c.id;
            document.getElementById('cName').value = c.name;
            document.getElementById('cPrice').value = c.price;
            document.getElementById('cGrade').value = c.grade;
            document.getElementById('cDiscount').value = c.discount || '';
            document.getElementById('cDesc').value = c.desc || '';
            document.getElementById('cStartDate').value = c.startDate || '';
            document.getElementById('cEndDate').value = c.endDate || '';
            document.getElementById('cActive').value = c.active ? 'true' : 'false';
            
            if(c.image) {
                document.getElementById('cImgPreview').innerHTML = `<img src="${c.image}" style="width:100%">`;
            } else {
                document.getElementById('cImgPreview').innerHTML = '';
            }

            document.getElementById('courseFormTitle').innerHTML = '<i class="fas fa-pen"></i> تعديل: ' + c.name;
            document.getElementById('btnSaveCourse').innerText = 'تحديث البيانات';
            document.getElementById('btnCancelEdit').style.display = 'inline-block';
            window.scrollTo(0,0);
        }

        function toggleCourseActive(i) {
            db.courses[i].active = !db.courses[i].active;
            saveDB(); renderCourses();
        }

        function renderCourses() {
            document.getElementById('coursesList').innerHTML = db.courses.map((c,i)=> {
                let pr = c.price; 
                if(c.discount) pr=`<span class="old-price">${c.price}</span> <span style="color:var(--success)">${Math.round(c.price-(c.price*c.discount/100))}</span>`;
                const activeLabel = c.active ? '<span style="color:green;font-size:12px;">(مفعل)</span>' : '<span style="color:red;font-size:12px;">(غير مفعل)</span>';
                
                return `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                    <div style="flex:1">
                        <b>${c.name}</b> (${c.grade}ث) - ${pr} ريال ${activeLabel}
                        <div style="font-size:12px; color:#666">${c.startDate || '?'} الى ${c.endDate || '?'}</div>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-warning btn-sm" onclick="showCourseStudents(${c.id}, '${c.name}')"><i class="fas fa-users"></i> الطلاب</button>
                        <button class="btn-icon edit" onclick="editCourse(${i})"><i class="fas fa-pen"></i></button>
                        <button class="btn-icon" onclick="toggleCourseActive(${i})" title="تفعيل/ايقاف"><i class="fas fa-power-off"></i></button>
                        <button class="btn-icon delete" onclick="delCourse(${i})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('');
        }
        
        function delCourse(i){ 
            if(confirm('حذف؟')) {
                const courseName = db.courses[i].name;
                db.courses.splice(i,1); 
                saveDB(); 
                renderCourses();
                addNotification('system', 'admin', `تم حذف كورس: ${courseName}`, 'warning');
            }
        }
        
        function updateDrops(){ 
            const o='<option value="">اختر</option>'+db.courses.map((c,i)=>`<option value="${i}">${c.name}</option>`).join(''); 
            ['strucCourse','contCourse','qCourse','impCourse','pCourse','perfCourse'].forEach(id=>{
                const e=document.getElementById(id);
                if(e) e.innerHTML=o;
            }); 
        }

        // --- Course Students Management ---
        function showCourseStudents(cId, cName) {
            const tbody = document.querySelector('#courseStudentsTable tbody');
            tbody.innerHTML = '';
            document.getElementById('modalCourseName').innerText = cName;
            
            Object.values(db.students).forEach(st => {
                if(st.courses && st.courses.includes(cId)) {
                    const onlineStatus = st.lastLogin && (Date.now() - st.lastLogin < 300000) ? 
                        '<span class="student-status status-online"><i class="fas fa-circle"></i> أونلاين</span>' : 
                        '<span class="student-status" style="background:#e5e7eb;color:#4b5563;"><i class="fas fa-circle" style="color:#9ca3af;"></i> أوفلاين</span>';
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>
                                <div>${st.name}</div>
                                <div style="font-size:12px;">${onlineStatus}</div>
                            </td>
                            <td>${st.phone}</td>
                            <td><button class="btn btn-danger btn-sm" onclick="removeStudentFromCourse('${st.id}', ${cId})">حذف</button></td>
                        </tr>
                    `;
                }
            });
            document.getElementById('courseStudentsModal').classList.add('active');
        }

        function removeStudentFromCourse(stId, cId) {
            if(confirm('هل أنت متأكد من حذف الطالب من هذا الكورس؟')) {
                db.students[stId].courses = db.students[stId].courses.filter(id => id !== cId);
                saveDB();
                if(document.getElementById('courseStudentsModal').classList.contains('active')) {
                    showCourseStudents(cId, document.getElementById('modalCourseName').innerText);
                }
                if(document.getElementById('adm-st-courses').classList.contains('active')) {
                    renderStudentCoursesManagement();
                }
                updateStats();
                addNotification('system', stId, `تم إزالتك من كورس`, 'warning');
                addNotification('system', 'admin', `تم إزالة الطالب ${db.students[stId].name} من الكورس`, 'info');
            }
        }

        // --- Student Courses Management Section ---
        function renderStudentCoursesManagement() {
             const searchTerm = document.getElementById('searchStCourses').value.toLowerCase();
             const tbody = document.querySelector('#stCoursesMgmtTable tbody');
             tbody.innerHTML = '';
             
             Object.values(db.students).forEach(st => {
                 if (searchTerm && !st.name.toLowerCase().includes(searchTerm)) return;
                 
                 let coursesHTML = '';
                 if (st.courses && st.courses.length > 0) {
                     coursesHTML = st.courses.map(cid => {
                         const c = db.courses.find(x => x.id === cid);
                         return c ? `<div style="display:inline-block; background:#e0f2fe; padding:2px 8px; border-radius:4px; margin:2px; font-size:12px;">
                                           ${c.name} 
                                           <button class="btn-icon edit btn-sm" style="width:20px;height:20px;font-size:10px;" onclick="editStudentCourse('${st.id}', ${cid})"><i class="fas fa-pen"></i></button>
                                           <button class="btn-icon delete btn-sm" style="width:20px;height:20px;font-size:10px;background:#fee2e2;color:#ef4444;" onclick="removeStudentFromCourse('${st.id}', ${cid})">x</button>
                                      </div>` : '';
                     }).join('');
                 } else {
                     coursesHTML = '<span style="color:#999">غير مسجل في كورسات</span>';
                 }
                 
                 tbody.innerHTML += `<tr>
                    <td>${st.name}</td>
                    <td>${coursesHTML}</td>
                    <td>
                        <button onclick="openEnrollModal('${st.id}')" class="btn btn-sm btn-primary">إضافة كورس</button>
                        <button onclick="editStudentCourses('${st.id}')" class="btn btn-sm btn-warning">تعديل</button>
                    </td>
                  </tr>`;
             });
        }

        function editStudentCourses(stId) {
            const student = db.students[stId];
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="width: 600px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 style="margin:0;">تعديل كورسات الطالب: ${student.name}</h3>
                        <button class="btn-icon delete" onclick="this.parentElement.parentElement.remove()">X</button>
                    </div>
                    <div id="editStudentCoursesList"></div>
                    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                        <button class="btn btn-dark" onclick="this.parentElement.parentElement.remove()">إغلاق</button>
                        <button class="btn btn-primary" onclick="saveStudentCourses('${stId}')">حفظ التعديلات</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const listDiv = document.getElementById('editStudentCoursesList');
            listDiv.innerHTML = db.courses.map(course => {
                const isEnrolled = student.courses && student.courses.includes(course.id);
                return `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                        <span>${course.name}</span>
                        <input type="checkbox" ${isEnrolled ? 'checked' : ''} value="${course.id}" style="transform: scale(1.2);">
                    </div>
                `;
            }).join('');
        }

        function saveStudentCourses(stId) {
            const checkboxes = document.querySelectorAll('#editStudentCoursesList input[type="checkbox"]:checked');
            const selectedCourses = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            db.students[stId].courses = selectedCourses;
            saveDB();
            
            document.querySelector('#editStudentCoursesList').parentElement.parentElement.remove();
            renderStudentCoursesManagement();
            addNotification('system', stId, `تم تحديث كورساتك`, 'info');
            addNotification('system', 'admin', `تم تحديث كورسات الطالب ${db.students[stId].name}`, 'info');
            alert('تم تحديث كورسات الطالب بنجاح');
        }

        function editStudentCourse(stId, courseId) {
            const student = db.students[stId];
            const course = db.courses.find(c => c.id === courseId);
            
            if(!course) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="width: 500px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 style="margin:0;">تعديل اشتراك الطالب في الكورس</h3>
                        <button class="btn-icon delete" onclick="this.parentElement.parentElement.remove()">X</button>
                    </div>
                    <p><strong>الطالب:</strong> ${student.name}</p>
                    <p><strong>الكورس:</strong> ${course.name}</p>
                    
                    <div style="margin-top:20px;">
                        <label>تاريخ بدء الاشتراك:</label>
                        <input type="date" id="editStartDate" class="form-control" value="${student.courseStartDate?.[courseId] || ''}">
                    </div>
                    
                    <div style="margin-top:10px;">
                        <label>تاريخ انتهاء الاشتراك:</label>
                        <input type="date" id="editEndDate" class="form-control" value="${student.courseEndDate?.[courseId] || ''}">
                    </div>
                    
                    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                        <button class="btn btn-dark" onclick="this.parentElement.parentElement.remove()">إغلاق</button>
                        <button class="btn btn-primary" onclick="saveStudentCourseEdit('${stId}', ${courseId})">حفظ التعديلات</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function saveStudentCourseEdit(stId, courseId) {
            const startDate = document.getElementById('editStartDate').value;
            const endDate = document.getElementById('editEndDate').value;
            
            if(!db.students[stId].courseStartDate) db.students[stId].courseStartDate = {};
            if(!db.students[stId].courseEndDate) db.students[stId].courseEndDate = {};
            
            db.students[stId].courseStartDate[courseId] = startDate;
            db.students[stId].courseEndDate[courseId] = endDate;
            
            saveDB();
            document.querySelector('.modal.active').remove();
            alert('تم حفظ التعديلات بنجاح');
        }

        // --- Structure (Units & Lessons) ---
        function loadStructureTree(){ 
             const cIdx=document.getElementById('strucCourse').value, tree=document.getElementById('structureTree'); tree.innerHTML='';
             if(cIdx==="") { document.getElementById('addUnitArea').style.display='none'; return; }
             document.getElementById('addUnitArea').style.display='block';
             
             db.courses[cIdx].units.forEach((u, uIdx) => {
                 let ls = u.lessons.map((l, lIdx) => `
                    <div class="lesson-row">
                        <span><i class="fas fa-play-circle" style="color:#ccc; margin-left:5px;"></i> ${l.title}</span>
                        <div class="actions-group">
                            <button class="btn-icon edit" style="width:25px;height:25px;font-size:12px;" onclick="renameLesson(${cIdx},${uIdx},${lIdx})"><i class="fas fa-pen"></i></button>
                            <button class="btn-icon delete" style="width:25px;height:25px;font-size:12px;background:#fee2e2;color:#ef4444;" onclick="delLesson(${cIdx},${uIdx},${lIdx})">x</button>
                        </div>
                    </div>`).join('');
                 
                 ls += `<div style="padding:10px; background:#fff; border-top:1px solid #eee;">
                            <div style="display:flex; gap:5px;">
                                <input id="nl_${uIdx}" placeholder="اسم الدرس الجديد" class="form-control" style="margin:0; flex:1;">
                                <button class="btn btn-primary" onclick="addLInS(${cIdx},${uIdx})"><i class="fas fa-plus"></i> إضافة درس</button>
                            </div>
                        </div>`;
                 
                 tree.innerHTML += `
                    <div class="unit-block">
                        <div class="unit-head">
                            <span>${u.title}</span>
                            <div class="actions-group">
                                <button class="btn-icon edit" style="width:28px;height:28px;font-size:12px;" onclick="renameUnit(${cIdx},${uIdx})"><i class="fas fa-pen"></i></button>
                                <button class="btn-icon delete" style="width:28px;height:28px;font-size:12px;background:#fee2e2;color:#ef4444;" onclick="delUnit(${cIdx},${uIdx})"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        ${ls}
                    </div>`;
             });
        }
        
        function addUnit(){ 
            const c=document.getElementById('strucCourse').value, t=document.getElementById('uTitle').value; 
            if(t){
                db.courses[c].units.push({title:t, lessons:[]}); 
                saveDB(); 
                loadStructureTree(); 
                document.getElementById('uTitle').value='';
                addNotification('system', 'admin', `تم إضافة وحدة جديدة: ${t}`, 'info');
            }
        }
        
        function addLInS(c,u){ 
            const t=document.getElementById(`nl_${u}`).value; 
            if(t){
                db.courses[c].units[u].lessons.push({id:Date.now(), title:t, data:{video:[],pdf:[],quiz:null}}); 
                saveDB(); 
                loadStructureTree(); 
                addNotification('system', 'admin', `تم إضافة درس جديد: ${t}`, 'info');
            }
        }
        
        function delUnit(c,u){ 
            if(confirm('حذف الوحدة؟')) { 
                const unitName = db.courses[c].units[u].title;
                db.courses[c].units.splice(u,1); 
                saveDB(); 
                loadStructureTree(); 
                addNotification('system', 'admin', `تم حذف وحدة: ${unitName}`, 'warning');
            } 
        }
        
        function delLesson(c,u,l){ 
            if(confirm('حذف الدرس؟')) { 
                const lessonName = db.courses[c].units[u].lessons[l].title;
                db.courses[c].units[u].lessons.splice(l,1); 
                saveDB(); 
                loadStructureTree(); 
                addNotification('system', 'admin', `تم حذف درس: ${lessonName}`, 'warning');
            } 
        }
        
        function renameUnit(c, u) {
            const newName = prompt("اسم الوحدة الجديد:", db.courses[c].units[u].title);
            if(newName) { 
                const oldName = db.courses[c].units[u].title;
                db.courses[c].units[u].title = newName; 
                saveDB(); 
                loadStructureTree(); 
                addNotification('system', 'admin', `تم تعديل اسم الوحدة من "${oldName}" إلى "${newName}"`, 'info');
            }
        }
        
        function renameLesson(c, u, l) {
            const newName = prompt("اسم الدرس الجديد:", db.courses[c].units[u].lessons[l].title);
            if(newName) { 
                const oldName = db.courses[c].units[u].lessons[l].title;
                db.courses[c].units[u].lessons[l].title = newName; 
                saveDB(); 
                loadStructureTree(); 
                addNotification('system', 'admin', `تم تعديل اسم الدرس من "${oldName}" إلى "${newName}"`, 'info');
            }
        }

        // --- Content (Type Selection) ---
        function updContDrops(t) { 
             const cSel=document.getElementById('contCourse'), uSel=document.getElementById('contUnit'), lSel=document.getElementById('contLesson');
             if(t==='c') { 
                 const c=cSel.value; 
                 uSel.innerHTML='<option value="">وحدة</option>'; 
                 lSel.innerHTML=''; 
                 if(c!=='') db.courses[c].units.forEach((u,i)=>uSel.innerHTML+=`<option value="${i}">${u.title}</option>`); 
             }
             else if(t==='u') { 
                 const c=cSel.value, u=uSel.value; 
                 lSel.innerHTML='<option value="">درس</option>'; 
                 if(c!==''&&u!=='') db.courses[c].units[u].lessons.forEach((l,i)=>lSel.innerHTML+=`<option value="${i}">${l.title}</option>`); 
             }
             document.getElementById('lessonContentArea').style.display = (t==='l' && lSel.value!=="") ? 'block' : 'none';
             if(t==='l') renderContent();
        }
        
        function loadLessonContent(){ updContDrops('l'); }
        
        function switchTab(t,b){
            document.querySelectorAll('.content-tab').forEach(x=>x.classList.remove('active')); 
            document.getElementById(t).classList.add('active'); 
        }
        
        function getLessonFromDrops() { 
            const cIdx = document.getElementById('contCourse').value;
            const uIdx = document.getElementById('contUnit').value;
            const lIdx = document.getElementById('contLesson').value;
            return db.courses[cIdx].units[uIdx].lessons[lIdx]; 
        }
        
        function selType(el, showId, hideId) {
            el.parentElement.querySelectorAll('.type-option').forEach(x => x.classList.remove('selected'));
            el.classList.add('selected');
            el.querySelector('input').checked = true;
            document.getElementById(showId).style.display = 'block';
            document.getElementById(hideId).style.display = 'none';
        }

        function addVideo() {
            const l = getLessonFromDrops();
            if (!l.data.video) l.data.video = [];

            const useFile = document.querySelector('input[name="vidType"]:checked').parentElement.innerText.includes('رفع');

            if (useFile) {
                const f = document.getElementById('vidFile').files[0];
                if (f) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        l.data.video.push({
                            type: 'uploaded',
                            url: e.target.result,
                            title: f.name,
                            format: f.type.includes('mp4') ? 'mp4' : 'video'
                        });
                        saveDB();
                        renderContent();
                        addNotification('system', 'admin', `تم إضافة فيديو للدرس: ${l.title}`, 'info');
                    };
                    reader.readAsDataURL(f);
                } else alert("اختر ملف فيديو");
            } else {
                const url = document.getElementById('vidUrl').value;
                if (url) {
                    // التعديل هنا: حفظ النوع كـ external بدلاً من youtube
                    l.data.video.push({
                        type: 'external', 
                        url: url,
                        title: 'رابط فيديو خارجي'
                    });
                    saveDB();
                    renderContent();
                    addNotification('system', 'admin', `تم إضافة رابط فيديو للدرس: ${l.title}`, 'info');
                }
            }
        }

        function addPdf(){ 
            const l = getLessonFromDrops(); 
            if(!l.data.pdf) l.data.pdf=[]; 

            const useFile = document.querySelector('input[name="pdfType"]:checked').parentElement.innerText.includes('ملف');
            
            if(useFile) {
                const f = document.getElementById('pdfFile').files[0];
                if(f) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        l.data.pdf.push({
                            type: 'uploaded',
                            url: e.target.result,
                            title: f.name,
                            size: f.size
                        });
                        saveDB(); renderContent();
                        addNotification('system', 'admin', `تم إضافة ملف PDF للدرس: ${l.title}`, 'info');
                    };
                    reader.readAsDataURL(f);
                } else alert("اختر ملف");
            } else {
                const url = document.getElementById('pdfUrl').value;
                if(url) { 
                    l.data.pdf.push({
                        type: 'external',
                        url: url,
                        title: 'ملف PDF خارجي'
                    }); 
                    saveDB(); renderContent(); 
                    addNotification('system', 'admin', `تم إضافة ملف PDF خارجي للدرس: ${l.title}`, 'info');
                }
            }
        }
        
        function renderContent(){ 
             const l=getLessonFromDrops();
             
             // عرض الفيديوهات مع أزرار التعديل والحذف
             document.getElementById('videoList').innerHTML = l.data.video.map((v,i)=>`
                <div class="content-item-row">
                    <div class="content-item-left">
                        <div class="content-thumb"><i class="fas fa-play"></i></div>
                        <div>${v.title || `فيديو ${i+1}`}</div>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-icon edit" style="background:transparent; color:var(--warning);" onclick="editContent('video', ${i})"><i class="fas fa-pen"></i></button>
                        <button class="btn-icon delete" style="background:transparent; color:#ef4444;" onclick="delContent('video', ${i})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`).join('');
             
             // عرض ملفات PDF مع أزرار التعديل والحذف
             document.getElementById('pdfList').innerHTML = l.data.pdf.map((p,i)=>`
                <div class="content-item-row">
                    <div class="content-item-left">
                        <div class="content-thumb"><i class="fas fa-file-pdf"></i></div>
                        <div>${p.title || `ملف PDF ${i+1}`}</div>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-icon edit" style="background:transparent; color:var(--warning);" onclick="editContent('pdf', ${i})"><i class="fas fa-pen"></i></button>
                        <button class="btn-icon delete" style="background:transparent; color:#ef4444;" onclick="delContent('pdf', ${i})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`).join('');
             
            // عرض بنك الأسئلة للدرس
    const qList = document.getElementById('qBankSelectionList');
    const lessonQs = db.questions.filter(q => q.lessonId == l.id);
    
    if (lessonQs.length === 0) {
        qList.innerHTML = '<p style="color:red; text-align:center;">لا توجد أسئلة مضافة لهذا الدرس في البنك.</p>';
    } else {
        qList.innerHTML = `
            <div style="margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                <label style="font-weight:bold; cursor:pointer;">
                    <input type="checkbox" onchange="toggleAllCheckboxes('qBankSelectionList', this)"> تحديد الكل
                </label>
                <span style="font-size: 12px; color: #666;">${lessonQs.length} سؤال متاح</span>
            </div>
        ` + lessonQs.map(q => {
            const checked = (l.data.quiz && l.data.quiz.qs.includes(q.id)) ? 'checked' : '';
            return getQuestionHTML(q, true, checked);
        }).join('');
    }
             
             // عرض معلومات الاختبار الحالي
             const quizInfo = document.getElementById('currentQuizInfo');
             if(l.data.quiz && l.data.quiz.qs.length > 0) {
                 quizInfo.innerHTML = `
                     <div style="background:#e0f2fe; padding:15px; border-radius:8px;">
                         <h5><i class="fas fa-info-circle"></i> معلومات الاختبار الحالي:</h5>
                         <p>عدد الأسئلة: ${l.data.quiz.qs.length}</p>
                         <p>المدة: ${l.data.quiz.dur} دقيقة</p>
                         <p>من: ${l.data.quiz.from} إلى: ${l.data.quiz.to}</p>
                         <button class="btn btn-danger btn-sm" onclick="deleteLessonQuiz()">حذف الاختبار</button>
                     </div>
                 `;
             } else {
                 quizInfo.innerHTML = '<p style="color:#666;">لا يوجد اختبار مضاف لهذا الدرس بعد.</p>';
             }
        }
        
function editContent(type, idx) {
            const l = getLessonFromDrops();
            const content = l.data[type][idx];

            document.getElementById('editContentForm').innerHTML = `
                <h4>تعديل ${type === 'video' ? 'فيديو' : 'ملف PDF'}</h4>
                <div class="form-control">
                    <label>العنوان:</label>
                    <input type="text" id="editContentTitle" class="form-control" value="${content.title || ''}" placeholder="أدخل العنوان">
                </div>
                ${type === 'video' ? `
                    <div class="form-control">
                        <label>رابط الفيديو (يوتيوب أو أي رابط خارجي):</label>
                        <input type="text" id="editContentUrl" class="form-control" value="${content.type === 'external' || content.type === 'youtube' ? content.url : ''}" ${content.type === 'uploaded' ? 'disabled placeholder="لا يمكن تعديل رابط فيديو مرفوع"' : ''}>
                    </div>
                ` : `
                    <div class="form-control">
                        <label>رابط الملف (للملفات الخارجية):</label>
                        <input type="text" id="editContentUrl" class="form-control" value="${content.type === 'external' ? content.url : ''}" placeholder="رابط الملف">
                    </div>
                `}
                <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                    <button class="btn btn-dark" onclick="closeEditContentModal()">إلغاء</button>
                    <button class="btn btn-primary" onclick="saveContentEdit('${type}', ${idx})">حفظ التعديلات</button>
                </div>
            `;

            document.getElementById('editContentModal').classList.add('active');
        }

       function saveContentEdit(type, idx) {
            const l = getLessonFromDrops();
            const title = document.getElementById('editContentTitle').value;
            const url = document.getElementById('editContentUrl') ? document.getElementById('editContentUrl').value : null;

            l.data[type][idx].title = title;
            
            // تحديث الرابط فقط إذا لم يكن ملفاً مرفوعاً
            if (url && l.data[type][idx].type !== 'uploaded') {
                l.data[type][idx].url = url;
                // التأكد من أن النوع external إذا كان فيديو
                if(type === 'video') l.data[type][idx].type = 'external';
            }

            saveDB();
            renderContent();
            closeEditContentModal();
            addNotification('system', 'admin', `تم تعديل ${type === 'video' ? 'فيديو' : 'ملف PDF'}`, 'info');
        }
        
        function closeEditContentModal() {
            document.getElementById('editContentModal').classList.remove('active');
        }
        
        function delContent(type, idx) {
            if(confirm("حذف؟")) {
                const l = getLessonFromDrops();
                const contentTitle = l.data[type][idx].title;
                l.data[type].splice(idx, 1);
                saveDB(); 
                renderContent();
                addNotification('system', 'admin', `تم حذف ${type === 'video' ? 'فيديو' : 'ملف PDF'}: ${contentTitle}`, 'warning');
            }
        }
        
        function deleteLessonQuiz() {
            if(confirm('هل تريد حذف اختبار هذا الدرس؟')) {
                const l = getLessonFromDrops();
                l.data.quiz = null;
                saveDB();
                renderContent();
                addNotification('system', 'admin', `تم حذف اختبار الدرس: ${l.title}`, 'warning');
            }
        }

        function saveLessonQuiz(){ 
             const l=getLessonFromDrops(); 
             l.data.quiz={ 
                 qs: Array.from(document.querySelectorAll('#qBankSelectionList input:checked')).map(c=>parseInt(c.value)), 
                 dur: document.getElementById('qDur').value, 
                 from: document.getElementById('qFrom').value, 
                 to: document.getElementById('qTo').value,
                 randomOrder: document.getElementById('randomOrder').checked,
                 randomOptions: document.getElementById('randomOptions').checked
             }; 
             saveDB(); 
             alert('تم حفظ الاختبار'); 
             renderContent();
             addNotification('system', 'admin', `تم حفظ اختبار للدرس: ${l.title}`, 'success');
        }

        // --- Comprehensive Exams Logic ---
        function updateCompExamSources() {
            const s = document.getElementById('ceCourseSource');
            s.innerHTML = '<option value="">-- حدد --</option><option value="all">الجميع (كل الكورسات)</option>';
            db.courses.forEach(c => s.innerHTML +=`<option value="${c.id}">${c.name}</option>`);
        }

        function loadCompExamQuestions() {
            const source = document.getElementById('ceCourseSource').value;
    const area = document.getElementById('compExamQArea');
    area.style.display = 'block';
    
    if(!source) { area.innerHTML = ''; return; }
    
    let qs = [];
    if(source === 'all') {
        qs = db.questions;
    } else {
        const courseId = parseInt(source);
        const course = db.courses.find(c => c.id === courseId);
        let lessonIds = [];
        if(course) {
            course.units.forEach(u => u.lessons.forEach(l => lessonIds.push(l.id)));
        }
        qs = db.questions.filter(q => lessonIds.includes(q.lessonId));
    }

    if (qs.length === 0) {
    area.innerHTML = '<p style="color:red">لا توجد أسئلة في هذا النطاق</p>';
} else {
    area.innerHTML = `
        <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center;">
            <label style="font-weight:bold; cursor:pointer;">
                <input type="checkbox" onchange="toggleAllCheckboxes('compExamQArea', this)"> تحديد الكل
            </label>
            <span style="font-size: 12px; color: #666;">${qs.length} سؤال متاح</span>
        </div>
    ` + qs.map(q => getQuestionHTML(q, true)).join('');
}
}
        function saveCompExam() {
            const title = document.getElementById('ceTitle').value;
            const from = document.getElementById('ceFrom').value;
            const to = document.getElementById('ceTo').value;
            const dur = document.getElementById('ceDur').value;
            
            const selectedQs = Array.from(document.querySelectorAll('#compExamQArea input:checked')).map(c=>parseInt(c.value));
            
            if(!title || !from || !to || !dur) return alert('أكمل جميع البيانات');
            if(selectedQs.length === 0) return alert('يجب اختيار سؤال واحد على الأقل');

            const compExam = {
                id: Date.now(),
                title: title,
                from: from,
                to: to,
                dur: parseInt(dur),
                qs: selectedQs,
                source: document.getElementById('ceCourseSource').value,
                randomOrder: document.getElementById('ceRandomOrder').checked,
                randomOptions: document.getElementById('ceRandomOptions').checked
            };
            
            if(!db.compExams) db.compExams = [];
            db.compExams.push(compExam);
            saveDB();
            
            alert('تم حفظ الاختبار المجمع بنجاح');
            document.getElementById('ceTitle').value = '';
            document.getElementById('compExamQArea').innerHTML = '';
            renderCompExams();
            addNotification('system', 'admin', `تم إنشاء اختبار مجمع: ${title}`, 'success');
        }

        function renderCompExams() {
            const list = document.getElementById('compExamsList');
            if(!db.compExams || db.compExams.length === 0) { 
                list.innerHTML = '<p>لا توجد اختبارات مجمعة</p>'; 
                return; 
            }
            
            list.innerHTML = db.compExams.map((e, i) => `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>${e.title}</strong>
                        <div style="font-size:12px; color:#666">${e.from} إلى ${e.to} | ${e.dur} دقيقة | ${e.qs.length} سؤال</div>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-warning btn-sm" onclick="editCompExam(${i})"><i class="fas fa-pen"></i> تعديل</button>
                        <button class="btn btn-danger btn-sm" onclick="delCompExam(${i})">حذف</button>
                    </div>
                </div>
            `).join('');
        }

        function editCompExam(idx) {
            const exam = db.compExams[idx];
            
            document.getElementById('editCompExamForm').innerHTML = `
                <div class="form-control">
                    <label>اسم الاختبار:</label>
                    <input type="text" id="editCeTitle" class="form-control" value="${exam.title}">
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin:15px 0;">
                    <div>
                        <label>من تاريخ:</label>
                        <input type="date" id="editCeFrom" class="form-control" value="${exam.from}">
                    </div>
                    <div>
                        <label>إلى تاريخ:</label>
                        <input type="date" id="editCeTo" class="form-control" value="${exam.to}">
                    </div>
                    <div>
                        <label>المدة (دقيقة):</label>
                        <input type="number" id="editCeDur" class="form-control" value="${exam.dur}">
                    </div>
                </div>
                
                <div class="quiz-settings">
                    <label><input type="checkbox" id="editCeRandomOrder" ${exam.randomOrder ? 'checked' : ''}> ترتيب عشوائي للأسئلة</label>
                    <label><input type="checkbox" id="editCeRandomOptions" ${exam.randomOptions ? 'checked' : ''}> ترتيب عشوائي للخيارات</label>
                </div>
                
                <div style="margin:20px 0; padding:15px; background:#f1f5f9; border-radius:8px;">
                    <h5>الأسئلة المختارة (${exam.qs.length} سؤال):</h5>
                    <div style="max-height:200px; overflow-y:auto;">
                        ${exam.qs.map(qId => {
                            const q = db.questions.find(q => q.id === qId);
                            return q ? `<div style="padding:5px; border-bottom:1px solid #ddd;">${q.text.substring(0, 100)}...</div>` : '';
                        }).join('')}
                    </div>
                    <button class="btn btn-primary btn-sm" style="margin-top:10px;" onclick="changeCompExamQuestions(${idx})">تغيير الأسئلة</button>
                </div>
                
                <div style="display:flex; justify-content:flex-end; gap:10px;">
                    <button class="btn btn-dark" onclick="closeEditCompExamModal()">إلغاء</button>
                    <button class="btn btn-primary" onclick="saveCompExamEdit(${idx})">حفظ التعديلات</button>
                </div>
            `;
            
            document.getElementById('editCompExamModal').classList.add('active');
        }

        function saveCompExamEdit(idx) {
            const exam = db.compExams[idx];
            
            exam.title = document.getElementById('editCeTitle').value;
            exam.from = document.getElementById('editCeFrom').value;
            exam.to = document.getElementById('editCeTo').value;
            exam.dur = parseInt(document.getElementById('editCeDur').value);
            exam.randomOrder = document.getElementById('editCeRandomOrder').checked;
            exam.randomOptions = document.getElementById('editCeRandomOptions').checked;
            
            saveDB();
            renderCompExams();
            closeEditCompExamModal();
            addNotification('system', 'admin', `تم تعديل اختبار مجمع: ${exam.title}`, 'info');
            alert('تم تحديث الاختبار المجمع بنجاح');
        }

        function changeCompExamQuestions(idx) {
            const exam = db.compExams[idx];
            const modal = document.createElement('div');
            modal.className = 'modal active';
            
            let allQuestions = [];
            if(exam.source === 'all') {
                allQuestions = db.questions;
            } else {
                const courseId = parseInt(exam.source);
                const course = db.courses.find(c => c.id === courseId);
                let lessonIds = [];
                if(course) {
                    course.units.forEach(u => u.lessons.forEach(l => lessonIds.push(l.id)));
                }
                allQuestions = db.questions.filter(q => lessonIds.includes(q.lessonId));
            }
            
            modal.innerHTML = `
                <div class="modal-content" style="width: 800px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 style="margin:0;">اختيار أسئلة جديدة للاختبار</h3>
                        <button class="btn-icon delete" onclick="this.parentElement.parentElement.remove()">X</button>
                    </div>
                    
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${allQuestions.map(q => `
                            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                                <div>
                                    <input type="checkbox" ${exam.qs.includes(q.id) ? 'checked' : ''} value="${q.id}" id="q_${q.id}" style="margin-left:10px;">
                                    <label for="q_${q.id}">${q.text.substring(0, 150)}...</label>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                        <button class="btn btn-dark" onclick="this.parentElement.parentElement.remove()">إلغاء</button>
                        <button class="btn btn-primary" onclick="saveCompExamQuestions(${idx})">حفظ الأسئلة</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function saveCompExamQuestions(idx) {
            const checkboxes = document.querySelectorAll('.modal.active input[type="checkbox"]:checked');
            const selectedQs = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if(selectedQs.length === 0) {
                alert('يجب اختيار سؤال واحد على الأقل');
                return;
            }
            
            db.compExams[idx].qs = selectedQs;
            saveDB();
            
            document.querySelector('.modal.active').remove();
            editCompExam(idx); // إعادة فتح نافذة التعديل لتحديث عرض الأسئلة
        }

        function closeEditCompExamModal() {
            document.getElementById('editCompExamModal').classList.remove('active');
        }

        function delCompExam(i) {
            if(confirm('حذف هذا الاختبار المجمع؟')) {
                const examTitle = db.compExams[i].title;
                db.compExams.splice(i, 1);
                saveDB(); 
                renderCompExams();
                addNotification('system', 'admin', `تم حذف اختبار مجمع: ${examTitle}`, 'warning');
            }
        }

        // --- Question Bank ---
        function toggleAddQMode(mode, el) {
            el.parentElement.querySelectorAll('.type-option').forEach(x => x.classList.remove('selected'));
            el.classList.add('selected');
            el.querySelector('input').checked = true;

            if(mode === 'manual') {
                document.getElementById('qManualSection').style.display = 'block';
                document.getElementById('qImportSection').style.display = 'none';
            } else {
                document.getElementById('qManualSection').style.display = 'none';
                document.getElementById('qImportSection').style.display = 'block';
            }
        }

        function updQDrops(t) { 
             const cSel=document.getElementById('qCourse'), uSel=document.getElementById('qUnit'), lSel=document.getElementById('qLesson');
             if(t==='c') { 
                 const c=cSel.value; 
                 uSel.innerHTML='<option value="">وحدة</option>'; 
                 if(c!=='') db.courses[c].units.forEach((u,i)=>uSel.innerHTML+=`<option value="${i}">${u.title}</option>`); 
             }
             else if(t==='u') { 
                 const c=cSel.value, u=uSel.value; 
                 lSel.innerHTML='<option value="">درس</option>'; 
                 if(c!==''&&u!=='') db.courses[c].units[u].lessons.forEach((l)=>lSel.innerHTML+=`<option value="${l.id}">${l.title}</option>`); 
             }
        }

        // --- Import Drops Logic ---
        function updImpDrops(t) {
             const cSel=document.getElementById('impCourse'), uSel=document.getElementById('impUnit'), lSel=document.getElementById('impLesson');
             if(t==='c') { 
                 const c=cSel.value; 
                 uSel.innerHTML='<option value="">وحدة</option>'; 
                 if(c!=='') db.courses[c].units.forEach((u,i)=>uSel.innerHTML+=`<option value="${i}">${u.title}</option>`); 
             }
             else if(t==='u') { 
                 const c=cSel.value, u=uSel.value; 
                 lSel.innerHTML='<option value="">درس</option>'; 
                 if(c!==''&&u!=='') db.courses[c].units[u].lessons.forEach((l)=>lSel.innerHTML+=`<option value="${l.id}">${l.title}</option>`); 
             }
        }

        function downloadTemplate() {
            const wb = XLSX.utils.book_new();
            const ws_data = [
                ["text", "type", "option1", "option2", "option3", "option4", "correct", "lang"],
                ["مثال: ما هي عاصمة السعودية؟", "mcq", "جدة", "الرياض", "مكة", "الدمام", "2", "ar"],
                ["مثال: الشمس تدور حول الأرض", "tf", "", "", "", "", "0", "ar"],
                ["مثال: أكمل الفراغ: عاصمة مصر هي ...", "fill", "", "", "", "", "القاهرة", "ar"]
            ];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "QuestionsTemplate");
            XLSX.writeFile(wb, "Questions_Template.xlsx");
        }

       function renderQInputs() {
    const type=document.getElementById('qType').value, lang=document.getElementById('qLang').value, area=document.getElementById('answersArea');
    document.getElementById('qText').style.direction = lang==='ar'?'rtl':'ltr'; area.innerHTML='';
    
    if(type==='mcq') {
        const ch=lang==='ar'?['أ','ب','ج','د']:['A','B','C','D'];
        for(let i=0; i<4; i++) {
            area.innerHTML+=`
            <div class="option-row" id="opt${i}" onclick="selOpt(${i})" style="direction:${lang==='ar'?'rtl':'ltr'}">
                <div class="opt-char">${ch[i]}</div>
                <input type="radio" name="corr" value="${i}" style="display:none">
                <input id="oval${i}" class="form-control" placeholder="خيار نصي" style="margin:0">
                
                <label class="img-upload-label" title="أضف صورة للخيار">
                    <i class="far fa-image"></i>
                    <input type="file" id="optImg${i}" style="display:none" onchange="previewOptImg(this, 'optImgPrev${i}')">
                </label>
                <img id="optImgPrev${i}" class="preview-thumb" style="display:none; height:30px;">
            </div>`;
        }
    } else if(type==='tf') {
        const txt=lang==='ar'?['صح','خطأ']:['True','False'];
        area.innerHTML=`<div style="display:flex;gap:10px"><div class="option-row" id="opt0" onclick="selOpt(0)"><input type="radio" name="corr" value="0" style="display:none"><b>${txt[0]}</b></div><div class="option-row" id="opt1" onclick="selOpt(1)"><input type="radio" name="corr" value="1" style="display:none"><b>${txt[1]}</b></div></div>`;
    } else { 
        area.innerHTML=`<input id="fillAns" class="form-control" placeholder="الإجابة الصحيحة">`; 
    }
}
function previewOptImg(input, id) {
    if(input.files && input.files[0]) {
        const reader=new FileReader();
        reader.onload=function(e){
            const img=document.getElementById(id);
            img.src=e.target.result;
            img.style.display='block';
        };
        reader.readAsDataURL(input.files[0]);
    }
}
        
        function selOpt(i) { 
            document.querySelectorAll('.option-row').forEach(r=>r.classList.remove('correct')); 
            document.getElementById('opt'+i).classList.add('correct'); 
            document.querySelector(`input[name="corr"][value="${i}"]`).checked = true; 
        }
        
      async function saveQuestion() { 
    const lId=document.getElementById('qLesson').value;
    const txt=document.getElementById('qText').value;
    const type = document.getElementById('qType').value;
    const lang = document.getElementById('qLang').value;
    
    if(!lId) return alert('خطأ: يرجى اختيار الدرس أولاً.');
    if(!txt.trim()) return alert('خطأ: يرجى كتابة نص السؤال.');
    
    let q={
        id:Date.now(), 
        lessonId:parseInt(lId), 
        text:txt, 
        type:type, 
        options:[], 
        optionImages: [], // مصفوفة جديدة لصور الخيارات
        correct:null, 
        lang: lang,
        image: null
    };
    
    // حفظ صورة السؤال الرئيسي
    const qImgInput = document.getElementById('qImg');
    if(qImgInput.files[0]) {
        q.image = await readFileAsDataURL(qImgInput.files[0]);
    }

    if(type==='mcq') { 
        const corrInput = document.querySelector('input[name="corr"]:checked');
        if(!corrInput) return alert('خطأ: حدد الإجابة الصحيحة.');
        q.correct=parseInt(corrInput.value); 
        
        for(let i=0;i<4;i++) {
            let optInput = document.getElementById('oval'+i);
            let optImgInput = document.getElementById('optImg'+i);
            
            // نحفظ النص (حتى لو فارغ إذا كانت هناك صورة)
            q.options.push(optInput.value || " "); 
            
            // نحفظ الصورة
            if(optImgInput && optImgInput.files[0]) {
                const imgData = await readFileAsDataURL(optImgInput.files[0]);
                q.optionImages.push(imgData);
            } else {
                q.optionImages.push(null);
            }
        }
    }
    else if(type==='tf') {
        const corrInput = document.querySelector('input[name="corr"]:checked');
        if(!corrInput) return alert('خطأ: حدد الإجابة الصحيحة.');
        q.correct=parseInt(corrInput.value);
    }
    else {
        let ansVal = document.getElementById('fillAns').value;
        if(!ansVal.trim()) return alert('خطأ: أدخل الإجابة الصحيحة.');
        q.correct=ansVal.trim();
    }
    
    db.questions.push(q); 
    saveDB(); 
    updateStats(); 
    alert('تم حفظ السؤال بنجاح!'); 
    
    // إعادة تعيين الحقول
    document.getElementById('qText').value=''; 
    document.getElementById('qImg').value = '';
    document.getElementById('qImgPrev').style.display='none';
    renderQInputs(); 
}

// دالة مساعدة لقراءة الملفات
function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
        let reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

        // --- Import Questions ---
        function importQs() {
            const lId = document.getElementById('impLesson').value;
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];

            if(!lId) return alert("يرجى اختيار الكورس والوحدة والدرس أولاً");
            if(!file) return alert("يرجى اختيار ملف Excel لاستيراده");

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if(jsonData.length === 0) return alert("الملف فارغ!");

                    let count = 0;
                    let errors = [];
                    jsonData.forEach((row, idx) => {
                        if(row.text && row.type && row.correct !== undefined && row.correct !== null) {
                            let q = {
                                id: Date.now() + Math.floor(Math.random() * 10000) + count,
                                lessonId: parseInt(lId),
                                text: row.text,
                                type: row.type,
                                options: [],
                                correct: null,
                                lang: row.lang || 'ar',
                                image: null
                            };

                            if(row.type === 'mcq') {
                                if(row.option1) q.options.push(row.option1);
                                if(row.option2) q.options.push(row.option2);
                                if(row.option3) q.options.push(row.option3);
                                if(row.option4) q.options.push(row.option4);
                                
                                let correctNum = parseInt(row.correct);
                                if(correctNum >= 1 && correctNum <= 4) {
                                    q.correct = correctNum - 1;
                                } else if(correctNum >= 0 && correctNum <= 3) {
                                    q.correct = correctNum;
                                } else {
                                    errors.push(`سطر ${idx+2}: رقم الإجابة الصحيحة غير صحيح (${row.correct})`);
                                    return;
                                }
                            } else if(row.type === 'tf') {
                                let correctNum = parseInt(row.correct);
                                if(correctNum === 0 || correctNum === 1) {
                                    q.correct = correctNum;
                                } else if(row.correct === 'صح' || row.correct === 'true' || row.correct === 'True') {
                                    q.correct = 0;
                                } else if(row.correct === 'خطأ' || row.correct === 'false' || row.correct === 'False') {
                                    q.correct = 1;
                                } else {
                                    errors.push(`سطر ${idx+2}: قيمة صح/خطأ غير صحيحة (${row.correct})`);
                                    return;
                                }
                            } else {
                                q.correct = String(row.correct).trim();
                            }
                            
                            db.questions.push(q);
                            count++;
                        } else {
                            errors.push(`سطر ${idx+2}: بيانات ناقصة`);
                        }
                    });

                    saveDB();
                    updateStats();
                    
                    let msg = `تم استيراد ${count} سؤال بنجاح!`;
                    if(errors.length > 0) {
                        msg += `\n\nالأخطاء (${errors.length}):\n` + errors.slice(0, 5).join('\n');
                        if(errors.length > 5) msg += `\n...و ${errors.length - 5} خطأ آخر`;
                    }
                    
                    alert(msg);
                    fileInput.value = '';
                    addNotification('system', 'admin', `تم استيراد ${count} سؤال`, 'success');
                } catch(err) {
                    console.error(err);
                    alert("حدث خطأ أثناء قراءة الملف، تأكد من الصيغة.");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function previewImg(input, id) { 
            if(input.files && input.files[0]) { 
                const reader=new FileReader(); 
                reader.onload=function(e){
                    const img=document.getElementById(id); 
                    img.src=e.target.result; 
                    img.style.display='block';
                }; 
                reader.readAsDataURL(input.files[0]); 
            } 
        }

        // --- Preview & Print ---
        function updPDrops(t){ 
             const cSel=document.getElementById('pCourse'), uSel=document.getElementById('pUnit'), lSel=document.getElementById('pLesson');
             if(t==='init') cSel.innerHTML='<option value="">اختر الكورس</option>' + db.courses.map((c, i) => `<option value="${i}">${c.name}</option>`).join('');
             else if(t==='c'){ 
                 uSel.innerHTML='<option value="">وحدة</option>'; 
                 if(cSel.value!=='') db.courses[cSel.value].units.forEach((x,i)=>uSel.innerHTML+=`<option value="${i}">${x.title}</option>`); 
             }
             else if(t==='u'){ 
                 lSel.innerHTML='<option value="">درس</option>'; 
                 if(cSel.value!=='') db.courses[cSel.value].units[uSel.value].lessons.forEach((x)=>lSel.innerHTML+=`<option value="${x.id}">${x.title}</option>`); 
             }
        }
        
        function loadQPreview() {
            const lId = document.getElementById('pLesson').value;
            const div = document.getElementById('qPreviewList');
            div.innerHTML = '';
            document.getElementById('printLessonName').innerText = document.getElementById('pLesson').options[document.getElementById('pLesson').selectedIndex].text;
            const qs = db.questions.filter(q => q.lessonId == lId);
            qs.forEach((q, i) => { 
                div.innerHTML += getQuestionHTML(q, false, null, true, true); 
            });
        }
        
        function editQuestion(qId) {
            const q = db.questions.find(q => q.id === qId);
            if(!q) return;
            
            editingQuestionId = qId;
            
            let optionsHTML = '';
            if(q.type === 'mcq') {
                const chars = q.lang === 'ar' ? ['أ', 'ب', 'ج', 'د'] : ['A', 'B', 'C', 'D'];
                optionsHTML = q.options.map((opt, idx) => `
                    <div class="option-row" id="editOpt${idx}" onclick="selEditOpt(${idx})" style="direction:${q.lang==='ar'?'rtl':'ltr'}">
                        <div class="opt-char">${chars[idx]}</div>
                        <input type="radio" name="editCorr" value="${idx}" ${q.correct === idx ? 'checked' : ''} style="display:none">
                        <input id="editOval${idx}" class="form-control" value="${opt}" style="margin:0">
                    </div>
                `).join('');
            } else if(q.type === 'tf') {
                const txt = q.lang === 'ar' ? ['صح', 'خطأ'] : ['True', 'False'];
                optionsHTML = `
                    <div style="display:flex;gap:10px">
                        <div class="option-row" id="editOpt0" onclick="selEditOpt(0)">
                            <input type="radio" name="editCorr" value="0" ${q.correct === 0 ? 'checked' : ''} style="display:none">
                            <b>${txt[0]}</b>
                        </div>
                        <div class="option-row" id="editOpt1" onclick="selEditOpt(1)">
                            <input type="radio" name="editCorr" value="1" ${q.correct === 1 ? 'checked' : ''} style="display:none">
                            <b>${txt[1]}</b>
                        </div>
                    </div>
                `;
            } else {
                optionsHTML = `<input id="editFillAns" class="form-control" value="${q.correct}" placeholder="الإجابة الصحيحة">`;
            }
            
            document.getElementById('editQuestionForm').innerHTML = `
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                    <select id="editQType" class="form-control" onchange="renderEditQInputs()">
                        <option value="mcq" ${q.type === 'mcq' ? 'selected' : ''}>اختيار متعدد</option>
                        <option value="tf" ${q.type === 'tf' ? 'selected' : ''}>صح/خطأ</option>
                        <option value="fill" ${q.type === 'fill' ? 'selected' : ''}>أكمل</option>
                    </select>
                    <select id="editQLang" class="form-control" onchange="renderEditQInputs()">
                        <option value="ar" ${q.lang === 'ar' ? 'selected' : ''}>عربي</option>
                        <option value="en" ${q.lang === 'en' ? 'selected' : ''}>إنجليزي</option>
                    </select>
                </div>
                
                <div class="q-input-group">
                    <textarea id="editQText" class="form-control q-text-area" placeholder="نص السؤال..." style="direction:${q.lang==='ar'?'rtl':'ltr'}">${q.text}</textarea>
                    <div style="margin-top:10px;">
                        <label style="cursor:pointer; color:var(--primary); font-size:13px;">
                            <i class="fas fa-image"></i> تغيير الصورة 
                            <input type="file" id="editQImg" style="display:none" onchange="previewEditImg(this, 'editQImgPrev')">
                        </label>
                        ${q.image ? `<img id="editQImgPrev" src="${q.image}" class="preview-thumb" style="display:block; margin-top:5px;">` : '<img id="editQImgPrev" class="preview-thumb" style="display:none;">'}
                    </div>
                </div>
                
                <div id="editAnswersArea" class="q-input-group" style="background:#f8fafc;">
                    ${optionsHTML}
                </div>
                
                <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                    <button class="btn btn-dark" onclick="closeEditQuestionModal()">إلغاء</button>
                    <button class="btn btn-primary" onclick="saveQuestionEdit()">حفظ التعديلات</button>
                </div>
            `;
            
            document.getElementById('editQuestionModal').classList.add('active');
        }
        
        function selEditOpt(i) {
            document.querySelectorAll('#editAnswersArea .option-row').forEach(r => r.classList.remove('correct'));
            document.getElementById('editOpt' + i).classList.add('correct');
            document.querySelector(`input[name="editCorr"][value="${i}"]`).checked = true;
        }
        
        function renderEditQInputs() {
            const type = document.getElementById('editQType').value;
            const lang = document.getElementById('editQLang').value;
            const area = document.getElementById('editAnswersArea');
            
            document.getElementById('editQText').style.direction = lang === 'ar' ? 'rtl' : 'ltr';
            
            if(type === 'mcq') {
                const ch = lang === 'ar' ? ['أ', 'ب', 'ج', 'د'] : ['A', 'B', 'C', 'D'];
                area.innerHTML = '';
                for(let i = 0; i < 4; i++) {
                    area.innerHTML += `
                        <div class="option-row" id="editOpt${i}" onclick="selEditOpt(${i})" style="direction:${lang==='ar'?'rtl':'ltr'}">
                            <div class="opt-char">${ch[i]}</div>
                            <input type="radio" name="editCorr" value="${i}" style="display:none">
                            <input id="editOval${i}" class="form-control" placeholder="خيار" style="margin:0">
                        </div>
                    `;
                }
            } else if(type === 'tf') {
                const txt = lang === 'ar' ? ['صح', 'خطأ'] : ['True', 'False'];
                area.innerHTML = `
                    <div style="display:flex;gap:10px">
                        <div class="option-row" id="editOpt0" onclick="selEditOpt(0)">
                            <input type="radio" name="editCorr" value="0" style="display:none">
                            <b>${txt[0]}</b>
                        </div>
                        <div class="option-row" id="editOpt1" onclick="selEditOpt(1)">
                            <input type="radio" name="editCorr" value="1" style="display:none">
                            <b>${txt[1]}</b>
                        </div>
                    </div>
                `;
            } else {
                area.innerHTML = `<input id="editFillAns" class="form-control" placeholder="الإجابة الصحيحة">`;
            }
        }
        
        function previewEditImg(input, id) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById(id);
                    img.src = e.target.result;
                    img.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function saveQuestionEdit() {
            const q = db.questions.find(q => q.id === editingQuestionId);
            if(!q) return;
            
            const txt = document.getElementById('editQText').value;
            const type = document.getElementById('editQType').value;
            const lang = document.getElementById('editQLang').value;
            
            if(!txt.trim()) return alert('خطأ: يرجى كتابة نص السؤال.');
            
            q.text = txt;
            q.type = type;
            q.lang = lang;
            
            const imgInput = document.getElementById('editQImg');
            if(imgInput.files && imgInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    q.image = e.target.result;
                    finalizeQuestionEdit(q);
                };
                reader.readAsDataURL(imgInput.files[0]);
            } else {
                finalizeQuestionEdit(q);
            }
        }
        
        function finalizeQuestionEdit(q) {
            if(q.type === 'mcq') {
                q.options = [];
                for(let i = 0; i < 4; i++) {
                    const optInput = document.getElementById('editOval' + i);
                    if(!optInput || !optInput.value.trim()) {
                        alert('خطأ: املأ جميع الخيارات الأربعة.');
                        return;
                    }
                    q.options.push(optInput.value);
                }
                const corrInput = document.querySelector('input[name="editCorr"]:checked');
                if(!corrInput) {
                    alert('خطأ: حدد الإجابة الصحيحة.');
                    return;
                }
                q.correct = parseInt(corrInput.value);
            } else if(q.type === 'tf') {
                const corrInput = document.querySelector('input[name="editCorr"]:checked');
                if(!corrInput) {
                    alert('خطأ: حدد الإجابة الصحيحة.');
                    return;
                }
                q.correct = parseInt(corrInput.value);
            } else {
                const ansVal = document.getElementById('editFillAns').value;
                if(!ansVal.trim()) {
                    alert('خطأ: أدخل الإجابة الصحيحة.');
                    return;
                }
                q.correct = ansVal.trim();
            }
            
            saveDB();
            closeEditQuestionModal();
            
            // تحديث السؤال في جميع الأماكن
            if(document.getElementById('pLesson').value == q.lessonId) loadQPreview();
            if(document.getElementById('adm-comp-exams').classList.contains('active')) renderCompExams();
            
            addNotification('system', 'admin', `تم تعديل سؤال`, 'info');
            alert('تم تحديث السؤال بنجاح!');
        }
        
        function closeEditQuestionModal() {
            document.getElementById('editQuestionModal').classList.remove('active');
            editingQuestionId = null;
        }
        
        function delQ(id) { 
            if(confirm('حذف؟')) { 
                db.questions = db.questions.filter(q => q.id !== id); 
                saveDB(); 
                loadQPreview(); 
                updateStats();
                addNotification('system', 'admin', `تم حذف سؤال`, 'warning');
            } 
        }
        
        function printWithMode(showAnswers) {
            const list = document.getElementById('qPreviewList');
            if(showAnswers) { 
                list.classList.remove('hide-answers'); 
                list.classList.add('show-answers'); 
            } else { 
                list.classList.remove('show-answers'); 
                list.classList.add('hide-answers'); 
            }
            window.print();
        }
        
       function getQuestionHTML(q, showCheckbox, checkAttr = '', showAdminControls = false, showEditButton = false) {
    let html = `<div class="q-display-card" style="direction:${q.lang==='ar'?'rtl':'ltr'}">`;
    html += `<div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px;">
                <div style="display:flex; gap:10px; align-items:center;">
                    ${showCheckbox ? `<input type="checkbox" value="${q.id}" ${checkAttr} style="transform:scale(1.2);">` : `<span style="font-weight:bold;">${q.id.toString().slice(-4)}.</span>`}
                    <div class="q-display-text">${q.text}</div>
                </div>
                ${showAdminControls ? `
                    <div class="no-print q-controls" style="display:flex; gap:5px;">
                        ${showEditButton ? `<button class="btn-icon edit" onclick="editQuestion(${q.id})"><i class="fas fa-pen"></i></button>` : ''}
                        <button class="btn-icon delete" onclick="delQ(${q.id})"><i class="fas fa-trash"></i></button>
                    </div>` : ''}
             </div>`;
    
    // === التصحيح: عرض صورة السؤال مرة واحدة فقط ===
    if(q.image && q.image.trim() !== '') {
        html += `<img src="${q.image}" class="q-img-preview" style="max-height:150px; display:block; margin:10px auto; border-radius:5px;">`;
    }
    
    if (q.type === 'mcq') {
        const chars = q.lang==='ar' ? ['أ','ب','ج','د'] : ['A','B','C','D'];
        html += `<div class="q-options-container">`;
        q.options.forEach((opt, idx) => {
            const isCorrect = (idx === q.correct) ? 'correct-ans' : '';
            // عرض صورة الخيار إذا كانت موجودة
            let optionImage = '';
            if(q.optionImages && q.optionImages[idx]) {
                optionImage = `<img src="${q.optionImages[idx]}" style="max-height:50px; display:block; margin:5px 0; border-radius:3px;">`;
            }
            html += `<div class="q-option-view ${isCorrect}">${chars[idx]}. ${opt} ${optionImage}</div>`;
        });
        html += `</div>`;
    } else if (q.type === 'tf') {
        const txt = q.lang==='ar' ? ['صح','خطأ'] : ['True','False'];
        html += `<div class="q-options-container">`;
        const is0 = (q.correct === 0) ? 'correct-ans' : '';
        const is1 = (q.correct === 1) ? 'correct-ans' : '';
        html += `<div class="q-option-view ${is0}">${txt[0]}</div><div class="q-option-view ${is1}">${txt[1]}</div>`;
        html += `</div>`;
    } else { 
        html += `<div style="padding:10px; border:1px dashed #ccc; margin-top:5px;">الإجابة: <span class="q-option-view correct-ans">${q.correct}</span></div>`; 
    }
    html += `</div>`;
    return html;
}

        // --- Students (WhatsApp Activation) ---
        function addStudent() {
            const ph = document.getElementById('stPhone').value;
            const name = document.getElementById('stName').value;
            
            if(!ph || !name) return alert('يرجى إدخال الاسم ورقم الجوال');

            const pass = Math.random().toString(36).slice(-6);
            const pPass = Math.random().toString(36).slice(-6);
            
            db.students[ph] = { 
                id: ph, 
                name: name, 
                phone: ph, 
                email: document.getElementById('stEmail').value || '',
                parentPhone: document.getElementById('pPhone').value, 
                pass: pass, 
                pPass: pPass, 
                status: document.getElementById('stStatus').value, 
                courses: [], 
                history: [], 
                tasks: [],
                profileImage: null,
                lastLogin: Date.now(),
                subscriptionRequests: []
            };
            
            saveDB(); 
            renderStudentsTable();
            updateStats();
            
            const msg = encodeURIComponent(`مرحباً ${name}،\nتم تسجيل حسابك في المنصة التعليمية بنجاح.\n\nبيانات الدخول:\nاسم المستخدم: ${ph}\nكلمة المرور: ${pass}\n\nيرجى الاحتفاظ بها.`);
            window.open(`https://wa.me/${ph}?text=${msg}`, '_blank');
            
            addNotification('system', 'admin', `تم إضافة طالب جديد: ${name}`, 'success');
        }
        
        function renderStudentsTable(){ 
            document.querySelector('#studentsTable tbody').innerHTML = Object.values(db.students).map(s=>{
                const onlineStatus = s.lastLogin && (Date.now() - s.lastLogin < 300000) ? 
                    '<span class="student-status status-online"><i class="fas fa-circle"></i> أونلاين</span>' : 
                    '<span class="student-status" style="background:#e5e7eb;color:#4b5563;"><i class="fas fa-circle" style="color:#9ca3af;"></i> أوفلاين</span>';
                
                return `
                    <tr>
                        <td>
                            <div>${s.name}</div>
                            <div style="font-size:12px;">${onlineStatus}</div>
                        </td>
                        <td class="allow-copy">ط: ${s.phone}<br>P: ${s.pass}</td>
                        <td class="allow-copy">أب: ${s.parentPhone}<br>P: ${s.pPass}</td>
                        <td>
                            <span class="student-status ${s.status === 'active' ? 'status-online' : 'status-suspended'}">
                                ${s.status === 'active' ? 'نشط' : 'موقوف'}
                            </span>
                        </td>
                        <td style="display:flex; gap:5px;">
                            <button onclick="openEnrollModal('${s.id}')" class="btn-sm btn-primary" title="تسكين"><i class="fas fa-user-plus"></i></button>
                            <button onclick="togStat('${s.id}')" class="btn-sm btn-warning"><i class="fas fa-sync"></i></button>
                            <button onclick="delStudent('${s.id}')" class="btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            }).join(''); 
        }
        
        function togStat(id){ 
            db.students[id].status = db.students[id].status === 'active' ? 'inactive' : 'active'; 
            saveDB(); 
            renderStudentsTable(); 
            addNotification('system', id, `تم ${db.students[id].status === 'active' ? 'تفعيل' : 'تعليق'} حسابك`, db.students[id].status === 'active' ? 'success' : 'warning');
            addNotification('system', 'admin', `تم ${db.students[id].status === 'active' ? 'تفعيل' : 'تعليق'} حساب الطالب: ${db.students[id].name}`, 'info');
        }
        
        function delStudent(id) { 
            if(confirm('حذف الطالب نهائياً؟')) { 
                const studentName = db.students[id].name;
                delete db.students[id]; 
                saveDB(); 
                renderStudentsTable(); 
                updateStats();
                addNotification('system', 'admin', `تم حذف الطالب: ${studentName}`, 'warning');
            } 
        }
        
        // Export Enrollments
        function exportEnrollments() {
             const data = [];
             Object.values(db.students).forEach(st => {
                 let cNames = "غير مسجل";
                 if(st.courses && st.courses.length > 0) {
                     cNames = st.courses.map(cid => {
                         const c = db.courses.find(x => x.id === cid);
                         return c ? c.name : '';
                     }).filter(x => x).join("، ");
                 }
                 data.push({
                     "اسم الطالب": st.name,
                     "رقم الجوال": st.phone,
                     "ولي الأمر": st.parentPhone,
                     "الكورسات المسجلة": cNames,
                     "الحالة": st.status
                 });
             });
             
             const ws = XLSX.utils.json_to_sheet(data);
             const wb = XLSX.utils.book_new();
             XLSX.utils.book_append_sheet(wb, ws, "تسكين الطلاب");
             XLSX.writeFile(wb, "Student_Enrollments.xlsx");
        }

        function openEnrollModal(stId) {
            currentStudentForEnroll = stId;
            const st = db.students[stId];
            document.getElementById('enrollStName').innerText = st.name;
            const sel = document.getElementById('enrollCourseSelect');
            sel.innerHTML = db.courses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('enrollModal').classList.add('active');
        }
        
        function confirmEnroll() {
            const cId = parseInt(document.getElementById('enrollCourseSelect').value);
            const st = db.students[currentStudentForEnroll];
            if(!st.courses) st.courses = [];
            if(!st.courses.includes(cId)) {
                st.courses.push(cId);
                db.students[currentStudentForEnroll] = st;
                saveDB(); 
                alert('تم تسكين الطالب في الكورس بنجاح');
                updateStats();
                if(document.getElementById('adm-st-courses').classList.contains('active')) renderStudentCoursesManagement();
                
                const course = db.courses.find(c => c.id === cId);
                addNotification('system', currentStudentForEnroll, `تم تسجيلك في كورس: ${course.name}`, 'success');
                addNotification('system', 'admin', `تم تسكين الطالب ${st.name} في كورس: ${course.name}`, 'info');
            } else { 
                alert('الطالب مسجل بالفعل في هذا الكورس'); 
            }
            closeEnrollModal();
        }
        
        function closeEnrollModal() { 
            document.getElementById('enrollModal').classList.remove('active'); 
        }

        // --- Subscription Requests ---
        function loadSubscriptionRequests() {
            const statusFilter = document.getElementById('requestStatusFilter').value;
            const tbody = document.getElementById('subscriptionRequestsBody');
            tbody.innerHTML = '';
            
            const filteredRequests = db.subscriptionRequests.filter(req => {
                if(statusFilter === 'all') return true;
                return req.status === statusFilter;
            });
            
            if(filteredRequests.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">لا توجد طلبات</td></tr>`;
                return;
            }
            
            filteredRequests.forEach((req, idx) => {
                const student = db.students[req.studentId];
                const course = db.courses.find(c => c.id === req.courseId);
                
                if(!student || !course) return;
                
                let statusBadge = '';
                if(req.status === 'pending') {
                    statusBadge = '<span class="student-status status-pending">قيد الانتظار</span>';
                } else if(req.status === 'approved') {
                    statusBadge = '<span class="student-status status-online">مقبول</span>';
                } else {
                    statusBadge = '<span class="student-status" style="background:#fee2e2;color:#991b1b;">مرفوض</span>';
                }
                
                let actions = '';
                if(req.status === 'pending') {
                    actions = `
                        <button class="btn btn-success btn-sm" onclick="approveSubscriptionRequest(${idx})">قبول</button>
                        <button class="btn btn-danger btn-sm" onclick="rejectSubscriptionRequest(${idx})">رفض</button>
                    `;
                } else if(req.status === 'approved') {
                    actions = `<span style="color:green;">تم القبول</span>`;
                } else {
                    actions = `<span style="color:red;">تم الرفض</span>`;
                }
                
                tbody.innerHTML += `
                    <tr>
                        <td>${student.name}</td>
                        <td>${student.phone}</td>
                        <td>${course.name}</td>
                        <td>${new Date(req.date).toLocaleDateString('ar-EG')}</td>
                        <td>${statusBadge}</td>
                        <td>${actions}</td>
                    </tr>
                `;
            });
        }
        
        function approveSubscriptionRequest(idx) {
            const request = db.subscriptionRequests[idx];
            const student = db.students[request.studentId];
            const course = db.courses.find(c => c.id === request.courseId);
            
            if(!student || !course) return;
            
            // إضافة الكورس للطالب
            if(!student.courses) student.courses = [];
            if(!student.courses.includes(course.id)) {
                student.courses.push(course.id);
            }
            
            // تحديث حالة الطلب
            request.status = 'approved';
            request.approvedDate = Date.now();
            
            // تحديث طلبات الطالب
            if(!student.subscriptionRequests) student.subscriptionRequests = [];
            const studentReqIdx = student.subscriptionRequests.findIndex(req => req.courseId === course.id);
            if(studentReqIdx > -1) {
                student.subscriptionRequests[studentReqIdx].status = 'approved';
            }
            
            saveDB();
            loadSubscriptionRequests();
            checkNotifications();
            
            // إرسال رسالة واتساب
            const msg = encodeURIComponent(`مرحباً ${student.name}،\nتم تفعيل اشتراكك في كورس "${course.name}" في المنصة التعليمية.\n\nيمكنك الآن الدخول إلى الكورس والاستفادة من محتواه.\n\nمع تمنياتنا لك بالنجاح والتوفيق.`);
            window.open(`https://wa.me/${student.phone}?text=${msg}`, '_blank');
            
            // إضافة إشعارات
            addNotification('system', request.studentId, `تم قبول طلب اشتراكك في كورس: ${course.name}`, 'success');
            addNotification('admin', request.studentId, `تم قبول طلب اشتراكك في كورس: ${course.name}`, 'success');
            addNotification('system', 'admin', `تم قبول طلب اشتراك الطالب ${student.name} في كورس: ${course.name}`, 'info');
            
            alert('تم قبول طلب الاشتراك وإرسال رسالة للطالب');
        }
        
        function rejectSubscriptionRequest(idx) {
            const request = db.subscriptionRequests[idx];
            const student = db.students[request.studentId];
            const course = db.courses.find(c => c.id === request.courseId);
            
            if(!student || !course) return;
            
            request.status = 'rejected';
            request.rejectedDate = Date.now();
            
            // تحديث طلبات الطالب
            if(!student.subscriptionRequests) student.subscriptionRequests = [];
            const studentReqIdx = student.subscriptionRequests.findIndex(req => req.courseId === course.id);
            if(studentReqIdx > -1) {
                student.subscriptionRequests[studentReqIdx].status = 'rejected';
            }
            
            saveDB();
            loadSubscriptionRequests();
            checkNotifications();
            
            // إضافة إشعارات
            addNotification('system', request.studentId, `تم رفض طلب اشتراكك في كورس: ${course.name}`, 'warning');
            addNotification('admin', request.studentId, `تم رفض طلب اشتراكك في كورس: ${course.name}`, 'warning');
            addNotification('system', 'admin', `تم رفض طلب اشتراك الطالب ${student.name} في كورس: ${course.name}`, 'info');
            
            alert('تم رفض طلب الاشتراك');
        }

        // --- Performance & Charts ---
        function updatePerformancePage() { 
            updateStats(); 
            updatePerfDrops('c'); 
        }
        
        function updateStats() { 
            document.getElementById('stCount').innerText=Object.keys(db.students).length;
            document.getElementById('crCount').innerText=db.courses.length;
            document.getElementById('qCountAll').innerText=db.questions.length;
            renderAdminCharts();
        }

        function renderAdminCharts() {
            const students = Object.values(db.students);
            const courses = db.courses;
            const questions = db.questions;

            const grades = { '1':0, '2':0, '3':0 };
            students.forEach(s => { if(grades[s.grade] !== undefined) grades[s.grade]++; });

            const qTypes = { 'mcq':0, 'tf':0, 'fill':0 };
            questions.forEach(q => { if(qTypes[q.type] !== undefined) qTypes[q.type]++; });

            const courseEnrollment = courses.map(c => {
                let count = 0;
                students.forEach(s => { if(s.courses && s.courses.includes(c.id)) count++; });
                return count;
            });
            const courseNames = courses.map(c => c.name);

            if(adminCharts.grade) adminCharts.grade.destroy();
            if(adminCharts.questions) adminCharts.questions.destroy();
            if(adminCharts.activity) adminCharts.activity.destroy();

            const ctx1 = document.getElementById('gradeChart').getContext('2d');
            adminCharts.grade = new Chart(ctx1, {
                type: 'pie',
                data: {
                    labels: ['1 ثانوي', '2 ثانوي', '3 ثانوي'],
                    datasets: [{
                        data: [grades['1'], grades['2'], grades['3']],
                        backgroundColor: ['#4361ee', '#3f37c9', '#4895ef']
                    }]
                },
                options: { plugins: { title: { display: true, text: 'توزيع الطلاب حسب الصف' } } }
            });

            const ctx2 = document.getElementById('questionsChart').getContext('2d');
            adminCharts.questions = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['اختيار متعدد', 'صح/خطأ', 'أكمل'],
                    datasets: [{
                        data: [qTypes['mcq'], qTypes['tf'], qTypes['fill']],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef476f']
                    }]
                },
                options: { plugins: { title: { display: true, text: 'أنواع الأسئلة في البنك' } } }
            });

            const ctx3 = document.getElementById('activityChart').getContext('2d');
            adminCharts.activity = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: courseNames,
                    datasets: [{
                        label: 'عدد الطلاب المسجلين',
                        data: courseEnrollment,
                        backgroundColor: '#4361ee'
                    }]
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { title: { display: true, text: 'الإقبال على الكورسات' } }
                }
            });
        }

        function updatePerfDrops(t){ 
            const cSel=document.getElementById('perfCourse'), uSel=document.getElementById('perfUnit'), lSel=document.getElementById('perfLesson');
             if(t==='c') { 
                 const c=cSel.value; 
                 uSel.innerHTML='<option value="all">كل الوحدات</option>'; lSel.innerHTML='<option value="all">كل الدروس</option>'; 
                 if(c!=='all' && c!=='') db.courses[c].units.forEach((u,i)=>uSel.innerHTML+=`<option value="${i}">${u.title}</option>`); 
             }
             else if(t==='u') { 
                 const c=cSel.value, u=uSel.value; 
                 lSel.innerHTML='<option value="all">كل الدروس</option>'; 
                 if(c!=='all' && u!=='all') db.courses[c].units[u].lessons.forEach((l)=>lSel.innerHTML+=`<option value="${l.id}">${l.title}</option>`); 
             }
            loadDetailedGrades(); 
        }

        function loadDetailedGrades(){ 
            const tbody=document.querySelector('#detailedGradesTable tbody'); tbody.innerHTML='';
            
            const selectedC = document.getElementById('perfCourse').value; 
            const selectedU = document.getElementById('perfUnit').value;    
            const selectedL = document.getElementById('perfLesson').value; 

            let results = [];
            
            let validLIDs = [];
            let filterMode = 'lesson';

            if(selectedL !== 'all') {
                validLIDs.push(parseInt(selectedL));
            } else if (selectedU !== 'all') {
                db.courses[selectedC].units[selectedU].lessons.forEach(l => validLIDs.push(l.id));
            } else if (selectedC !== 'all') {
                 db.courses[selectedC].units.forEach(u => {
                     u.lessons.forEach(l => validLIDs.push(l.id));
                 });
            } else {
                filterMode = 'all';
            }

            Object.values(db.students).forEach(st=>{ 
                if(st.history) st.history.forEach(h=>{ 
                    if(filterMode !== 'all') {
                        if (h.type === 'comp') return;
                        if (!validLIDs.includes(h.lId)) return;
                    }

                    let cName = "-";
                    let typeName = "درس";
                    
                    if(h.type === 'comp') {
                        cName = "اختبار مجمع";
                        typeName = "شامل";
                    } else {
                        for(let c of db.courses) {
                             for(let u of c.units) {
                                 if(u.lessons.find(l=>l.id == h.lId)) { cName = c.name; break; }
                             }
                        }
                    }

                    const pct = Math.round(h.score/h.total*100);
                    tbody.innerHTML+=`<tr><td>${st.name}</td><td>${cName} (${typeName})</td><td>${h.lesson}</td><td>${h.score}/${h.total}</td><td>${pct>=50?'ناجح':'راسب'}</td></tr>`;
                    results.push({st, pct});
                }); 
            });

            const topT = document.querySelector('#topTable tbody'); topT.innerHTML='';
            const lowT = document.querySelector('#lowTable tbody'); lowT.innerHTML='';
            
            results.sort((a,b)=>b.pct-a.pct);
            
            results.forEach((r,i)=>{
                if(i<10) topT.innerHTML+=`<tr><td>${i+1}</td><td>${r.st.name}</td><td>${r.pct}%</td><td><a href="https://wa.me/${r.st.phone}?text=تهنئة.." class="btn-sm btn-success">طالب</a></td><td><a href="https://wa.me/${r.st.parentPhone}?text=تهنئة.." class="btn-sm btn-primary">ولي أمر</a></td></tr>`;
                if(r.pct<50) lowT.innerHTML+=`<tr><td>${r.st.name}</td><td>${r.pct}%</td><td><a href="https://wa.me/${r.st.parentPhone}?text=تنبيه.." class="btn-sm btn-danger">تنبيه</a></td></tr>`;
            });
        }

        // --- STUDENT LOGIC ---
        function initStudent() { 
            document.getElementById('stNameDisplay').innerText=currentUser.name; 
            document.getElementById('studentProfileImg').src = currentUser.profileImage || 'https://via.placeholder.com/80';
            
            // تحديث وقت الدخول الأخير
            currentUser.lastLogin = Date.now();
            db.students[currentUser.id] = currentUser;
            saveDB();
            
            renderStudentDashboard();
            checkNotifications();
            updateTeacherStatus();
        }

        function renderStudentDashboard() {
            const courseCount = currentUser.courses ? currentUser.courses.length : 0;
            let examsCount = 0, questionsSolved = 0, totalScore = 0, totalMax = 0;
            if(currentUser.history) {
                examsCount = currentUser.history.length;
                currentUser.history.forEach(h => {
                    questionsSolved += h.total; totalScore += h.score; totalMax += h.total;
                });
            }
            let perfLvl = "لم يبدأ";
            if(totalMax > 0) {
                const avg = (totalScore / totalMax) * 100;
                if(avg >= 90) perfLvl = "ممتاز"; else if(avg >= 75) perfLvl = "جيد جداً"; else if(avg >= 50) perfLvl = "جيد"; else perfLvl = "ضعيف";
            }
            document.getElementById('stStatsCourses').innerText = courseCount;
            document.getElementById('stStatsExams').innerText = examsCount;
            document.getElementById('stStatsQs').innerText = questionsSolved;
            document.getElementById('stStatsLvl').innerText = perfLvl;

            new Chart(document.getElementById('stChart').getContext('2d'), {
                type: 'bar',
                data: { labels: ['الاختبارات', 'الأسئلة'], datasets: [{ label: 'النشاط', data: [examsCount, questionsSolved], backgroundColor: ['#4361ee', '#3f37c9'] }] }
            });
        }

        function renderMyCourses() { 
             const my=document.getElementById('stMyCourses'); my.innerHTML='';
             db.courses.forEach(c=>{ 
                 if(currentUser.courses && currentUser.courses.includes(c.id)) {
                     if(c.active !== false) { 
                         const bgImage = c.image ? `background-image: url('${c.image}')` : 'background: #eee';
                         my.innerHTML+=`<div class="card course-card">
                            <div class="course-card-header" style="${bgImage}">
                                 ${!c.image ? '<i class="fas fa-book"></i>' : ''}
                            </div>
                            <div class="course-card-body">
                                <h3>${c.name}</h3>
                                <p>${c.grade} ثانوي</p>
                                <button class="btn btn-primary" style="width:100%" onclick="openCourseContent(${c.id})">عرض محتوى الكورس</button>
                            </div>
                          </div>`; 
                     }
                 }
             });
             
             document.getElementById('courseContentTabs').style.display = 'none';
        }

        // --- عرض محتوى الكورس في تبويبات ---
        function openCourseContent(courseId) {
            currentCourseContent = db.courses.find(c => c.id === courseId);
            if(!currentCourseContent) return;
            
            // إخفاء قائمة الكورسات وعرض التبويبات
            document.getElementById('stMyCourses').style.display = 'none';
            document.getElementById('courseContentTabs').style.display = 'block';
            
            // تحديث عنوان الكورس
            document.querySelector('#st-courses h2').innerHTML = `كورس: ${currentCourseContent.name} <button class="btn btn-dark btn-sm" onclick="backToCoursesList()">رجوع للقائمة</button>`;
            
            // تحميل محتوى التبويبات
            loadCourseVideos();
            loadCourseFiles();
            loadCourseQuizzes();
            
            // تفعيل تبويب الفيديوهات
            switchStudentTab('videos-tab', document.querySelector('.student-tab-btn'));
        }
        
        function backToCoursesList() {
            document.getElementById('stMyCourses').style.display = 'grid';
            document.getElementById('courseContentTabs').style.display = 'none';
            document.querySelector('#st-courses h2').innerHTML = 'كورساتي المسجلة';
        }
        
        function switchStudentTab(tabId, btn) {
            // إزالة النشط من جميع الأزرار
            document.querySelectorAll('.student-tab-btn').forEach(b => b.classList.remove('active'));
            // إخفاء جميع المحتويات
            document.querySelectorAll('.student-tab-content').forEach(c => c.classList.remove('active'));
            
            // تفعيل الزر المختار
            btn.classList.add('active');
            // عرض المحتوى المختار
            document.getElementById(tabId).classList.add('active');
        }
        
        function loadCourseVideos() {
            const container = document.getElementById('courseVideosList');
            container.innerHTML = '';
            
            let hasVideos = false;
            
            currentCourseContent.units.forEach(unit => {
                unit.lessons.forEach(lesson => {
                    if(lesson.data.video && lesson.data.video.length > 0) {
                        hasVideos = true;
                        lesson.data.video.forEach((video, index) => {
                            const videoCard = document.createElement('div');
                            videoCard.className = 'student-video-card';
                            videoCard.innerHTML = `
                                <div class="student-video-thumb">
                                    <i class="fas fa-play-circle"></i>
                                </div>
                                <div class="student-video-body">
                                    <h4>${lesson.title} - ${video.title || `فيديو ${index+1}`}</h4>
                                    <p><small>${unit.title}</small></p>
                                    <button class="btn btn-primary" onclick="playVideo('${video.url}', '${video.type}', '${video.title || lesson.title}')">
                                        <i class="fas fa-play"></i> تشغيل الفيديو
                                    </button>
                                </div>
                            `;
                            container.appendChild(videoCard);
                        });
                    }
                });
            });
            
            if(!hasVideos) {
                container.innerHTML = '<p style="text-align:center; padding:20px; color:#666;">لا توجد فيديوهات في هذا الكورس.</p>';
            }
        }
        
        function loadCourseFiles() {
            const container = document.getElementById('courseFilesList');
            container.innerHTML = '';
            
            let hasFiles = false;
            
            currentCourseContent.units.forEach(unit => {
                unit.lessons.forEach(lesson => {
                    if(lesson.data.pdf && lesson.data.pdf.length > 0) {
                        hasFiles = true;
                        // تحويل عرض الملفات إلى أيقونات
                        const fileIconContainer = document.createElement('div');
                        fileIconContainer.className = 'file-icon-container';
                        fileIconContainer.innerHTML = `
                            <div class="file-icon">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <h4>${lesson.title}</h4>
                            <p><small>${unit.title}</small></p>
                            <div style="margin-top:10px;">
                                ${lesson.data.pdf.map((pdf, idx) => `
                                    <div style="margin-bottom:5px; padding:8px; background:#f0f9ff; border-radius:5px; cursor:pointer;" onclick="viewFile('${pdf.url}', '${pdf.type}', '${pdf.title || lesson.title}')">
                                        <i class="fas fa-file-alt" style="color:var(--primary); margin-left:5px;"></i>
                                        ${pdf.title || `ملف ${idx+1}`}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        container.appendChild(fileIconContainer);
                    }
                });
            });
            
            if(!hasFiles) {
                container.innerHTML = '<p style="text-align:center; padding:20px; color:#666;">لا توجد ملفات في هذا الكورس.</p>';
            }
        }
        
        function loadCourseQuizzes() {
            const container = document.getElementById('courseQuizzesList');
            container.innerHTML = '';
            
            let hasQuizzes = false;
            
            currentCourseContent.units.forEach(unit => {
                unit.lessons.forEach(lesson => {
                    if(lesson.data.quiz && lesson.data.quiz.qs.length > 0) {
                        hasQuizzes = true;
                        const quizItem = document.createElement('div');
                        quizItem.className = 'student-quiz-item';
                        
                        // التحقق مما إذا كان الطالب قد أدى الاختبار من قبل
                        const lastAttempt = currentUser.history ? 
                            currentUser.history.find(h => h.lId === lesson.id && h.type === 'lesson') : null;
                        
                        let statusHTML = '';
                        if(lastAttempt) {
                            const percentage = Math.round((lastAttempt.score / lastAttempt.total) * 100);
                            statusHTML = `
                                <span style="color:${percentage >= 50 ? 'green' : 'red'}; font-weight:bold;">
                                    ${percentage}%
                                </span>
                            `;
                        }
                        
                        quizItem.innerHTML = `
                            <div>
                                <h4 style="margin:0;">${lesson.title}</h4>
                                <p style="margin:5px 0 0 0; color:#666; font-size:12px;">
                                    ${unit.title} | ${lesson.data.quiz.qs.length} سؤال | ${lesson.data.quiz.dur} دقيقة
                                </p>
                                <p style="margin:5px 0 0 0; color:#666; font-size:12px;">
                                    متاح من ${lesson.data.quiz.from} إلى ${lesson.data.quiz.to}
                                </p>
                            </div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                ${statusHTML}
                                <button class="btn btn-warning" onclick="startQuizFromCourse(${lesson.id})">
                                    ${lastAttempt ? 'إعادة الاختبار' : 'بدء الاختبار'}
                                </button>
                            </div>
                        `;
                        container.appendChild(quizItem);
                    }
                });
            });
            
            if(!hasQuizzes) {
                container.innerHTML = '<p style="text-align:center; padding:20px; color:#666;">لا توجد اختبارات في هذا الكورس.</p>';
            }
        }
        
      function playVideo(url, type, title) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'videoPlayerModal'; // إضافة ID للمودال
    
    let videoHTML = '';
    
    // التحقق الذكي من نوع الرابط
    const isYoutube = url.includes('youtube.com') || url.includes('youtu.be');

    if (type === 'uploaded') {
        videoHTML = `
            <div class="video-container">
                <video src="${url}" controls controlsList="nodownload" oncontextmenu="return false;" style="width:100%; border-radius:10px;" autoplay></video>
            </div>
        `;
    } else if (isYoutube) {
        // منطق استخراج معرف يوتيوب
        let videoId = url.split('v=')[1];
        const ampersandPosition = videoId ? videoId.indexOf('&') : -1;
        if (ampersandPosition !== -1) videoId = videoId.substring(0, ampersandPosition);
        if (!videoId && url.includes('youtu.be')) videoId = url.split('/').pop();
        
        videoHTML = `
            <div class="video-container">
                <iframe src="https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1&controls=1&showinfo=0&autoplay=1" allowfullscreen style="width:100%; height:60vh; border:none;"></iframe>
            </div>
        `;
    } else {
        videoHTML = `
            <div class="video-container">
                <iframe src="${url}" allowfullscreen style="width:100%; height:60vh; border:none;"></iframe>
            </div>
        `;
    }
    
    modal.innerHTML = `
        <div class="modal-content" style="width: 90%; max-width: 1000px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0;">${title}</h3>
                <button class="btn-icon delete" onclick="closeVideoModal()">X</button>
            </div>
            ${videoHTML}
            <p style="margin-top:10px; color:#666; text-align:center;">
                <i class="fas fa-info-circle"></i> الفيديو يعرض داخل المنصة فقط
            </p>
        </div>
    `;
    document.body.appendChild(modal);
}

// إضافة دالة لإغلاق الفيديو بشكل صحيح
function closeVideoModal() {
    const modal = document.getElementById('videoPlayerModal');
    if (modal) {
        modal.remove();
    }
    
    // التأكد من بقاء المستخدم في نفس التبويب
    if (currentCourseContent) {
        // لا نحتاج لفعل أي شيء - سيبقى المستخدم في نفس التبويب
        console.log('تم إغلاق الفيديو، المستخدم يبقى في نفس التبويب');
    }
}
        
        function viewFile(url, type, title) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'fileViewerModal';
    
    modal.innerHTML = `
        <div class="modal-content" style="width: 90%; height: 90%;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0;">${title}</h3>
                <button class="btn-icon delete" onclick="closeFileModal()">X</button>
            </div>
            <div class="pdf-container">
                <iframe src="${url}#toolbar=0&navpanes=0&scrollbar=0" 
                        style="width:100%; height:100%; border:none;" 
                        oncontextmenu="return false;"
                        id="fileViewerIframe">
                </iframe>
            </div>
            <p style="margin-top:10px; color:#666; text-align:center;">
                <i class="fas fa-info-circle"></i> الملف يعرض داخل المنصة فقط ولا يمكن تحميله
            </p>
        </div>
    `;
    
    // إضافة المودال إلى body
    document.body.appendChild(modal);
    
    // منع إغلاق المودال عند النقر خارجه
    modal.onclick = function(e) {
        if (e.target === modal) {
            closeFileModal();
        }
    };
}

// إضافة دالة لإغلاق الملف بشكل صحيح
function closeFileModal() {
    const modal = document.getElementById('fileViewerModal');
    if (modal) {
        // إيقاف الـ iframe
        const iframe = modal.querySelector('iframe');
        if (iframe) {
            iframe.src = '';
        }
        
        // إزالة المودال
        modal.remove();
    }
    
    // التأكد من بقاء المتصفح في نفس التبويب
    console.log('تم إغلاق الملف، المستخدم يبقى في نفس التبويب');
}
        
        function startQuizFromCourse(lessonId) {
            document.getElementById('st-courses').style.display = 'none';
            document.getElementById('st-quiz-active').style.display = 'block';
            startQuiz(lessonId, false);
        }

        function renderSubscribe() {
            const other=document.getElementById('stOtherCourses'); other.innerHTML='';
            db.courses.forEach(c=>{ 
                 if((!currentUser.courses || !currentUser.courses.includes(c.id)) && c.active !== false) {
                        let priceHTML = `<span>${c.price} ريال</span>`;
                        if(c.discount > 0) {
                            const finalPrice = Math.round(c.price - (c.price * c.discount / 100));
                            priceHTML = `<span class="old-price">${c.price}</span> <span style="color:var(--success); font-size:18px;">${finalPrice} ريال</span>`;
                        }
                        const bgImage = c.image ? `background-image: url('${c.image}')` : 'background: var(--dark)';
                        
                        other.innerHTML+=`<div class="card course-card course-card-dynamic">
                        <div class="course-card-header" style="${bgImage}">
                            ${!c.image ? '<i class="fas fa-lock"></i>' : ''}
                        </div>
                        <div class="course-card-body">
                            <h3>${c.name}</h3>
                            <div class="course-price-box">${priceHTML}</div>
                            <button class="btn btn-success" style="width:100%; margin-top:10px;" onclick="requestSubscription(${c.id})">اشتراك الآن</button>
                        </div>
                      </div>`; 
                 }
            });
        }

        function requestSubscription(courseId) {
            const course = db.courses.find(c => c.id === courseId);
            if(!course) return;
            
            // التحقق مما إذا كان هناك طلب سابق
            const existingRequest = db.subscriptionRequests.find(req => 
                req.studentId === currentUser.id && req.courseId === courseId && req.status === 'pending'
            );
            
            if(existingRequest) {
                alert('لديك بالفعل طلب اشتراك قيد الانتظار لهذا الكورس');
                return;
            }
            
            if(confirm(`هل تريد طلب الاشتراك في كورس "${course.name}"؟`)) {
                const request = {
                    id: Date.now(),
                    studentId: currentUser.id,
                    courseId: courseId,
                    date: Date.now(),
                    status: 'pending'
                };
                
                // إضافة الطلب لقاعدة البيانات العامة
                db.subscriptionRequests.push(request);
                
                // إضافة الطلب لملف الطالب
                if(!currentUser.subscriptionRequests) currentUser.subscriptionRequests = [];
                currentUser.subscriptionRequests.push({
                    courseId: courseId,
                    date: Date.now(),
                    status: 'pending'
                });
                
                db.students[currentUser.id] = currentUser;
                saveDB();
                
                // إضافة إشعارات
                addNotification('system', currentUser.id, `تم إرسال طلب اشتراكك في كورس: ${course.name}`, 'info');
                addNotification('system', 'admin', `طلب اشتراك جديد من الطالب ${currentUser.name} في كورس: ${course.name}`, 'info');
                
                alert('تم إرسال طلب الاشتراك بنجاح. سيتم مراجعته من قبل الإدارة وإشعارك بالنتيجة.');
                checkNotifications();
            }
        }

        function renderStudentFiles() {
            const display = document.getElementById('stFilesDisplay');
            const cId = parseInt(document.getElementById('stFileCourse').value);
            display.innerHTML = '';
            
            if(!cId) return;

            const course = db.courses.find(c => c.id === cId);
            if(!course) return;

            let hasFiles = false;
            course.units.forEach(u => {
                u.lessons.forEach(l => {
                    if(l.data.pdf && l.data.pdf.length > 0) {
                        hasFiles = true;
                        l.data.pdf.forEach((pdf, idx) => {
                            let displayTitle = pdf.title || `ملف ${idx+1}`;
                            let lessonTitle = l.title;
                            
                            display.innerHTML += `
                                <div class="file-icon-container" onclick="viewFile('${pdf.url}', '${pdf.type}', '${displayTitle}')">
                                    <div class="file-icon">
                                        <i class="fas fa-file-pdf"></i>
                                    </div>
                                    <h4>${displayTitle}</h4>
                                    <p><small>${lessonTitle} - ${u.title}</small></p>
                                    <div style="margin-top:10px; color:#666; font-size:12px;">
                                        <i class="fas fa-eye"></i> انقر للمعاينة
                                    </div>
                                </div>
                            `;
                        });
                    }
                });
            });

            if(!hasFiles) display.innerHTML = '<p style="text-align:center; padding:20px;">لا توجد ملفات في هذا الكورس.</p>';
        }
        
        function downloadFile(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function openFileViewer(url, title) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="width: 90%; height: 90%;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3 style="margin:0;">${title}</h3>
                        <button class="btn-icon delete" onclick="this.parentElement.parentElement.remove()">X</button>
                    </div>
                    <div class="pdf-embed-container">
                        <iframe src="${url}#toolbar=0&navpanes=0&scrollbar=0" style="width:100%; height:100%; border:none;"></iframe>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // --- Student Profile Management ---
        function loadStudentProfile() {
            document.getElementById('profileStudentName').innerText = currentUser.name;
            document.getElementById('profileStudentPhone').innerText = `رقم الجوال: ${currentUser.phone}`;
            document.getElementById('profileStudentGrade').innerText = `الصف: ${currentUser.grade || 'غير محدد'}`;
            document.getElementById('profileDisplayImg').src = currentUser.profileImage || 'https://via.placeholder.com/80';
            
            document.getElementById('profileName').value = currentUser.name;
            document.getElementById('profileEmail').value = currentUser.email || '';
            document.getElementById('profileParentPhone').value = currentUser.parentPhone || '';
            document.getElementById('profileGrade').value = currentUser.grade || '';
            document.getElementById('profilePassword').value = '';
            document.getElementById('profileConfirmPassword').value = '';
        }
        
        function openProfileEditModal() {
            stNav('st-profile');
        }
        
        function uploadProfileImage(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentUser.profileImage = e.target.result;
                    db.students[currentUser.id] = currentUser;
                    saveDB();
                    
                    document.getElementById('profileDisplayImg').src = e.target.result;
                    document.getElementById('studentProfileImg').src = e.target.result;
                    
                    addNotification('system', currentUser.id, 'تم تحديث صورتك الشخصية', 'success');
                    alert('تم تحديث صورتك الشخصية بنجاح');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function updateStudentProfile() {
            const name = document.getElementById('profileName').value;
            const email = document.getElementById('profileEmail').value;
            const parentPhone = document.getElementById('profileParentPhone').value;
            const grade = document.getElementById('profileGrade').value;
            const password = document.getElementById('profilePassword').value;
            const confirmPassword = document.getElementById('profileConfirmPassword').value;
            
            if(!name.trim()) {
                alert('يرجى إدخال الاسم');
                return;
            }
            
            if(password && password !== confirmPassword) {
                alert('كلمة المرور وتأكيدها غير متطابقين');
                return;
            }
            
            currentUser.name = name;
            currentUser.email = email;
            currentUser.parentPhone = parentPhone;
            currentUser.grade = grade;
            
            if(password) {
                currentUser.pass = password;
            }
            
            db.students[currentUser.id] = currentUser;
            saveDB();
            
            document.getElementById('stNameDisplay').innerText = name;
            loadStudentProfile();
            
            addNotification('system', currentUser.id, 'تم تحديث بياناتك الشخصية', 'success');
            alert('تم تحديث بياناتك الشخصية بنجاح');
        }
        
        function loadStudentRequests() {
            const tbody = document.getElementById('studentRequestsBody');
            tbody.innerHTML = '';
            
            if(!currentUser.subscriptionRequests || currentUser.subscriptionRequests.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">لا توجد طلبات</td></tr>`;
                return;
            }
            
            currentUser.subscriptionRequests.forEach(req => {
                const course = db.courses.find(c => c.id === req.courseId);
                if(!course) return;
                
                let statusBadge = '';
                if(req.status === 'pending') {
                    statusBadge = '<span class="student-status status-pending">قيد الانتظار</span>';
                } else if(req.status === 'approved') {
                    statusBadge = '<span class="student-status status-online">مقبول</span>';
                } else {
                    statusBadge = '<span class="student-status" style="background:#fee2e2;color:#991b1b;">مرفوض</span>';
                }
                
                let notes = '';
                if(req.status === 'approved') {
                    notes = 'تم قبول طلبك، يمكنك الآن الوصول للكورس';
                } else if(req.status === 'rejected') {
                    notes = 'تم رفض طلبك، يمكنك التواصل مع الإدارة';
                } else {
                    notes = 'جاري مراجعة طلبك من قبل الإدارة';
                }
                
                tbody.innerHTML += `
                    <tr>
                        <td>${course.name}</td>
                        <td>${new Date(req.date).toLocaleDateString('ar-EG')}</td>
                        <td>${statusBadge}</td>
                        <td>${notes}</td>
                    </tr>
                `;
            });
        }

        // --- NEW: Self Test Logic ---
        function renderSelfTestSetup() {
            const sel = document.getElementById('selfTestCourse');
            sel.innerHTML = '<option value="">-- اختر الكورس --</option>';
            if(currentUser.courses) {
                currentUser.courses.forEach(cid => {
                    const c = db.courses.find(x => x.id === cid);
                    if(c) sel.innerHTML += `<option value="${cid}">${c.name}</option>`;
                });
            }
        }

        function updSelfTestUnits() {
            const cId = parseInt(document.getElementById('selfTestCourse').value);
            const uSel = document.getElementById('selfTestUnit');
            uSel.innerHTML = '<option value="all">كل المنهج</option>';
            if(cId) {
                const c = db.courses.find(x => x.id === cId);
                if(c) c.units.forEach((u, idx) => uSel.innerHTML += `<option value="${idx}">${u.title}</option>`);
            }
        }

        function generateSelfTest() {
            const cId = parseInt(document.getElementById('selfTestCourse').value);
            const uIdx = document.getElementById('selfTestUnit').value;
            const count = parseInt(document.getElementById('selfTestCount').value);

            if(!cId) return alert('يرجى اختيار الكورس');

            const c = db.courses.find(x => x.id === cId);
            let validLids = [];
            
            if(uIdx === 'all') {
                c.units.forEach(u => u.lessons.forEach(l => validLids.push(l.id)));
            } else {
                c.units[parseInt(uIdx)].lessons.forEach(l => validLids.push(l.id));
            }

            let pool = db.questions.filter(q => validLids.includes(q.lessonId));

            if(pool.length === 0) return alert('لا توجد أسئلة متاحة في هذا النطاق');
            if(pool.length < count) alert(`ملاحظة: يوجد فقط ${pool.length} سؤال متاح.`);

            pool = pool.sort(() => 0.5 - Math.random()).slice(0, count);

            document.getElementById('st-self-test').style.display = 'none';
            document.getElementById('st-quiz-active').style.display = 'block';

            document.getElementById('takingQuizTitle').innerText = `اختبار تدريبي (${pool.length} سؤال)`;
            
            currentQuiz = { 
                qs: pool, 
                answers: {}, 
                idx: 0, 
                time: pool.length * 2 * 60,
                lessonId: null, 
                type: 'self', 
                title: 'تدريب ذاتي',
                randomOrder: true,
                randomOptions: true
            };
            
            initQuizRunner();
        }

        function renderAllExams() {
            const compList = document.getElementById('stCompExamsList'); compList.innerHTML = '';
            const today = new Date().toISOString().split('T')[0];

            if(db.compExams && db.compExams.length > 0) {
                db.compExams.forEach((e, idx) => {
                    if(today >= e.from && today <= e.to) {
                        compList.innerHTML += `
                            <div class="card" style="display:flex; justify-content:space-between; align-items:center; border-right:5px solid var(--warning);">
                                <div>
                                    <strong>${e.title}</strong>
                                    <div style="font-size:12px;">مدة: ${e.dur} دقيقة | أسئلة: ${e.qs.length}</div>
                                </div>
                                <button class="btn btn-warning" onclick="startCompExam(${idx})">بدء الاختبار</button>
                            </div>
                        `;
                    }
                });
            }
            if(compList.innerHTML === '') compList.innerHTML = '<p style="color:#888;">لا توجد اختبارات مجمعة متاحة حالياً.</p>';

            const list = document.getElementById('stExamsList'); list.innerHTML = '';
            if(currentUser.courses) {
                currentUser.courses.forEach(cid => {
                    const course = db.courses.find(c => c.id === cid);
                    if(course && course.active !== false) {
                        course.units.forEach(u => {
                            u.lessons.forEach(l => {
                                if(l.data.quiz && l.data.quiz.qs.length > 0) {
                                    const lastAttempt = currentUser.history.slice().reverse().find(h => h.lId === l.id && h.type !== 'comp');
                                    let btnHtml = '';

                                    if(lastAttempt) {
                                        const percentage = (lastAttempt.score / lastAttempt.total) * 100;
                                        if(percentage < 85) {
                                            btnHtml = `<span class="badge" style="background:#ddd; padding:5px; border-radius:5px; margin-left:5px;">${lastAttempt.score}/${lastAttempt.total}</span>
                                                       <button class="btn retry-wrong-btn btn-sm" onclick="startQuizFromList(${cid}, ${l.id}, true)">إعادة الأخطاء</button>
                                                       <button class="btn retry-all-btn btn-sm" onclick="startQuizFromList(${cid}, ${l.id}, false)">إعادة كاملة</button>`;
                                        } else {
                                            btnHtml = `<span class="badge" style="background:#d1fae5; color:green; padding:5px; border-radius:5px; font-weight:bold;">ممتاز</span>`;
                                        }
                                    } else {
                                        btnHtml = `<button class="btn btn-warning btn-sm" onclick="startQuizFromList(${cid}, ${l.id}, false)">ابدأ الاختبار</button>`;
                                    }

                                    list.innerHTML += `
                                    <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                                        <div>
                                            <div style="font-weight:bold;">${l.title}</div>
                                            <div style="font-size:12px; color:#666;">${course.name} - ${u.title}</div>
                                        </div>
                                        <div>
                                            ${btnHtml}
                                        </div>
                                    </div>`;
                                }
                            });
                        });
                    }
                });
            }
        }
        
        function renderStStatsTable() {
             const tbody = document.querySelector('#stHistoryTable tbody');
             tbody.innerHTML = '';
             
             // تحديث إحصائيات الأداء
             let totalScore = 0;
             let totalPossible = 0;
             let completedLessons = new Set();
             let totalExams = 0;
             
             if(currentUser.history && currentUser.history.length > 0) {
                 currentUser.history.slice().reverse().forEach((h, idx) => {
                     const revIdx = currentUser.history.length - 1 - idx;
                     let typeLabel = 'درس';
                     if(h.type === 'comp') typeLabel = '<span style="color:purple">اختبار مجمع</span>';
                     else if(h.type === 'self') typeLabel = '<span style="color:blue">تدريب ذاتي</span>';
                     
                     const percentage = Math.round((h.score/h.total)*100);
                     totalScore += h.score;
                     totalPossible += h.total;
                     totalExams++;
                     
                     if(h.type === 'lesson') {
                         completedLessons.add(h.lId);
                     }
                     
                     let retryBtn = '';
                     
                     if(h.type === 'lesson' && percentage < 85) {
                         retryBtn = `<button class="btn retry-wrong-btn btn-sm" onclick="retryWrongQuestions(${revIdx})">إعادة الأخطاء</button>
                                     <button class="btn retry-all-btn btn-sm" onclick="retryAllQuestions(${revIdx})">إعادة كاملة</button>`;
                     } else if(h.type === 'comp' && percentage < 85) {
                         retryBtn = `<button class="btn retry-all-btn btn-sm" onclick="retryCompExam(${revIdx})">إعادة الاختبار</button>`;
                     }

                     tbody.innerHTML += `<tr>
                        <td>${h.lesson}</td>
                        <td>${typeLabel}</td>
                        <td>${h.score}/${h.total} (${percentage}%)</td>
                        <td>${new Date(h.date || Date.now()).toLocaleDateString('ar-EG')}</td>
                        <td><button class="btn-sm btn-primary" onclick="reviewQuiz(${revIdx})">مراجعة</button></td>
                        <td>${retryBtn}</td>
                     </tr>`;
                 });
             } else { 
                 tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">لا يوجد سجل نشاط</td></tr>'; 
             }
             
             // تحديث إحصائيات الأداء
             const avgScore = totalPossible > 0 ? Math.round((totalScore / totalPossible) * 100) : 0;
             let performanceLevel = "لم يبدأ";
             if(avgScore >= 90) performanceLevel = "ممتاز";
             else if(avgScore >= 75) performanceLevel = "جيد جداً";
             else if(avgScore >= 50) performanceLevel = "جيد";
             else if(avgScore > 0) performanceLevel = "ضعيف";
             
             document.getElementById('myScoreAvg').innerText = avgScore + '%';
             document.getElementById('myCompleted').innerText = completedLessons.size;
             document.getElementById('myLevel').innerText = performanceLevel;
             document.getElementById('myTotalExams').innerText = totalExams;
        }

        function retryWrongQuestions(historyIdx) {
            const h = currentUser.history[historyIdx];
            if(!h.userAnswers) return alert('لا توجد بيانات كافية لإعادة الأخطاء');
            
            const wrongQIds = h.qIds.filter(qid => {
                const q = db.questions.find(x => x.id === qid);
                return q && h.userAnswers[qid] !== q.correct;
            });
            
            if(wrongQIds.length === 0) {
                alert('لا توجد أخطاء لإعادة الاختبار عليها!');
                return;
            }
            
            const qs = db.questions.filter(q => wrongQIds.includes(q.id));
            startRetryQuiz(qs, h.lesson + ' - إعادة الأخطاء', 'retry');
        }

        function retryAllQuestions(historyIdx) {
            const h = currentUser.history[historyIdx];
            const qs = db.questions.filter(q => h.qIds.includes(q.id));
            startRetryQuiz(qs, h.lesson + ' - إعادة كاملة', 'retry');
        }

        function retryCompExam(historyIdx) {
            const h = currentUser.history[historyIdx];
            if(!h.qIds) return alert('لا توجد بيانات كافية لإعادة الاختبار');
            
            const qs = db.questions.filter(q => h.qIds.includes(q.id));
            startRetryQuiz(qs, h.lesson + ' - إعادة الاختبار', 'comp');
        }

        function startRetryQuiz(qs, title, type) {
            document.getElementById('st-stats').style.display = 'none';
            document.getElementById('st-quiz-active').style.display = 'block';
            
            document.getElementById('takingQuizTitle').innerText = title;
            
            currentQuiz = { 
                qs: qs, 
                answers: {}, 
                idx: 0, 
                time: qs.length * 2 * 60,
                lessonId: null, 
                type: type,
                title: title,
                randomOrder: true,
                randomOptions: true
            };
            
            initQuizRunner();
        }

        function startCompExam(idx) {
            const e = db.compExams[idx];
            document.getElementById('st-all-exams').style.display='none';
            document.getElementById('st-quiz-active').style.display='block';
            
            document.getElementById('takingQuizTitle').innerText = e.title;
            
            let qs = db.questions.filter(q => e.qs.includes(q.id));
            
            // تطبيق الترتيب العشوائي إذا كان مفعل
            if(e.randomOrder) {
                qs = qs.sort(() => Math.random() - 0.5);
            }
            
            currentQuiz = { 
                qs: qs, 
                answers: {}, 
                idx: 0, 
                time: e.dur * 60, 
                lessonId: null,
                type: 'comp',
                title: e.title,
                randomOrder: e.randomOrder || true,
                randomOptions: e.randomOptions || true
            };
            
            initQuizRunner();
        }

        function startQuizFromList(cid, lid, retryMistakes) {
            document.getElementById('st-all-exams').style.display='none';
            document.getElementById('st-quiz-active').style.display='block';
            startQuiz(lid, retryMistakes); 
        }

        function openStCourse(cid){
             stNav('st-viewer'); 
             const c=db.courses.find(x=>x.id==cid);
             document.getElementById('stUnitMenu').innerHTML = `<h3 style="border-bottom:1px solid #eee; padding-bottom:10px;">${c.name}</h3>` + 
             c.units.map(u=>`<div style="background:#e0f2fe;padding:8px; margin-top:5px; font-weight:bold; border-radius:5px;">${u.title}</div>`+
             u.lessons.map(l=>`<div onclick="loadStLesson(${l.id})" style="padding:8px 15px; cursor:pointer; border-bottom:1px solid #f1f5f9; transition:0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='white'"><i class="fas fa-play-circle" style="color:var(--primary); margin-left:5px;"></i> ${l.title}</div>`).join('')).join('');
        }

        function loadStLesson(lid) {
            const l = db.courses.reduce((acc, c) => acc || c.units.reduce((a2, u) => a2 || u.lessons.find(l => l.id == lid), null), null);
            let contentHTML = '';

            if (l.data.video && l.data.video.length > 0) {
                l.data.video.forEach(v => {
                    // التحقق هل الرابط يوتيوب أم رابط عادي
                    const isYoutube = v.url.includes('youtube.com') || v.url.includes('youtu.be');
                    
                    if (v.type === 'uploaded') {
                        contentHTML += `
                             <div class="file-preview-container">
                                 <h4>${v.title || 'فيديو الدرس'}</h4>
                                 <div class="video-container">
                                     <video src="${v.url}" controls controlsList="nodownload" oncontextmenu="return false;" style="width:100%; border-radius:10px;"></video>
                                 </div>
                             </div>`;
                    } else {
                        // التعامل مع الروابط الخارجية (يوتيوب أو غيره)
                        let embedCode = '';
                        if (isYoutube) {
                            let videoId = v.url.split('v=')[1];
                            const ampersandPosition = videoId ? videoId.indexOf('&') : -1;
                            if (ampersandPosition !== -1) videoId = videoId.substring(0, ampersandPosition);
                            if (!videoId && v.url.includes('youtu.be')) videoId = v.url.split('/').pop();
                            
                            embedCode = `<iframe src="https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1&controls=1&showinfo=0" allowfullscreen style="width:100%; height:60vh; border:none;"></iframe>`;
                        } else {
                            // رابط خارجي عام (iframe مباشر)
                            embedCode = `<iframe src="${v.url}" allowfullscreen style="width:100%; height:60vh; border:none;"></iframe>`;
                        }

                        contentHTML += `
                             <div class="file-preview-container">
                                 <h4>${v.title || 'فيديو الدرس'}</h4>
                                 <div class="video-container">
                                     ${embedCode}
                                 </div>
                             </div>`;
                    }
                });
            } else {
                contentHTML = `<div style="background:#f1f5f9; color:#666; height:200px; display:flex; align-items:center; justify-content:center; border-radius:10px; margin-bottom:15px;">لا يوجد فيديو لهذا الدرس</div>`;
            }

            document.getElementById('stContentArea').innerHTML = contentHTML;

            // ... (باقي كود عرض ملفات PDF والاختبارات يبقى كما هو في الكود الأصلي) ...
            if(l.data.pdf && l.data.pdf.length > 0) {
                 l.data.pdf.forEach(pdf => {
                    const displayTitle = pdf.title || 'ملف PDF';
                    contentHTML += `
                        <div class="file-preview-container">
                            <h4>${displayTitle}</h4>
                            <div class="pdf-embed-container">
                                <iframe src="${pdf.url}#toolbar=0&navpanes=0&scrollbar=0" style="width:100%; height:100%; border:none;" oncontextmenu="return false;"></iframe>
                            </div>
                            <div style="margin-top:10px;">
                                <button class="btn btn-primary" onclick="downloadFile('${pdf.url}', '${displayTitle}')">تحميل الملف</button>
                            </div>
                        </div>`;
                 });
                 document.getElementById('stContentArea').innerHTML += contentHTML; // إضافة الـ PDF للمحتوى
            }
            
            if(l && l.data.quiz && l.data.quiz.qs.length > 0) {
                 document.getElementById('stContentArea').innerHTML += `
                     <div style="margin-top:20px;">
                         <button class="btn btn-success" style="width:100%; padding:15px; font-size:18px;" onclick="startQuizInViewer(${lid})">
                             بدء الاختبار لهذا الدرس
                         </button>
                     </div>`;
            }
        }
        
        function startQuizInViewer(lid) {
            document.getElementById('st-viewer').style.display = 'none';
            document.getElementById('st-quiz-active').style.display = 'block';
            startQuiz(lid, false);
        }

        function startQuiz(lid, retryMistakes = false){
             document.getElementById('stExamsList').style.display='none'; 
             document.getElementById('stQuizArea').style.display='block';
             
             const l = db.courses.reduce((acc, c) => acc || c.units.reduce((a2, u) => a2 || u.lessons.find(l => l.id == lid), null), null);
             
             let targetQIds = l.data.quiz.qs;

             if(retryMistakes) {
                 const lastAttempt = currentUser.history.slice().reverse().find(h => h.lId === lid);
                 if(lastAttempt && lastAttempt.userAnswers) {
                     targetQIds = targetQIds.filter(qid => {
                         const qDb = db.questions.find(x => x.id === qid);
                         const uAns = lastAttempt.userAnswers[qid];
                         return !qDb || uAns !== qDb.correct;
                     });
                     
                     if(targetQIds.length === 0) {
                         alert("لا توجد أخطاء لإعادتها!");
                         return stNav('st-all-exams');
                     }
                     document.getElementById('takingQuizTitle').innerText = `إعادة الأخطاء: ${l.title}`;
                 }
             } else {
                 document.getElementById('takingQuizTitle').innerText = l.title;
             }

             let qs = db.questions.filter(q => targetQIds.includes(q.id));
             
             // تطبيق إعدادات الترتيب العشوائي
             if(l.data.quiz && l.data.quiz.randomOrder !== false) {
                 qs = qs.sort(() => Math.random() - 0.5);
             }
             
             currentQuiz = { 
                 qs: qs, 
                 answers: {}, 
                 idx: 0, 
                 time: l.data.quiz.dur * 60, 
                 lessonId: lid, 
                 type: 'lesson', 
                 title: l.title,
                 randomOrder: l.data.quiz.randomOrder || true,
                 randomOptions: l.data.quiz.randomOptions || true
             };
             initQuizRunner();
        }

        function initQuizRunner() {
             renderQuizQ(0); 
             updateDots();
             clearInterval(examTimerInterval);
             examTimerInterval = setInterval(() => {
                 currentQuiz.time--;
                 const m = Math.floor(currentQuiz.time/60); 
                 const s = currentQuiz.time%60;
                 document.getElementById('quizTimer').innerText = `${m}:${s.toString().padStart(2, '0')}`;
                 if(currentQuiz.time <= 0) {
                     clearInterval(examTimerInterval);
                     submitQuiz();
                 }
             }, 1000);
        }
        
        function renderQuizQ(idx) {
             const q = currentQuiz.qs[idx];
    let options = [];
    
    if(q.type === 'mcq') {
        // إذا كان الترتيب عشوائي للخيارات مفعل
        if(currentQuiz.randomOptions) {
            const originalOptions = q.options.map((opt, i) => ({ 
                text: opt, 
                index: i,
                image: q.optionImages && q.optionImages[i] ? q.optionImages[i] : null 
            }));
            const shuffled = [...originalOptions].sort(() => Math.random() - 0.5);
            options = shuffled.map(item => ({ 
                text: item.text, 
                originalIndex: item.index,
                image: item.image 
            }));
        } else {
            options = q.options.map((opt, i) => ({ 
                text: opt, 
                originalIndex: i,
                image: q.optionImages && q.optionImages[i] ? q.optionImages[i] : null 
            }));
        }
    }
    
    let html = `<div class="quiz-question-box">سؤال ${idx+1}: ${q.text}</div>`;
    
    // عرض صورة السؤال إذا كانت موجودة
    if(q.image && q.image.trim() !== '') {
        html += `<div style="text-align:center; margin:10px 0;">
                    <img src="${q.image}" style="max-height:200px; max-width:100%; border-radius:8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                 </div>`;
    }
    
    if(q.type==='mcq') {
        options.forEach((o,i) => {
            const isChecked = currentQuiz.answers[q.id] === o.originalIndex;
            let optionContent = `<span>${o.text}</span>`;
            
            // إضافة صورة الخيار إذا كانت موجودة
            if(o.image && o.image.trim() !== '') {
                optionContent += `<div style="text-align:center; margin-top:5px;">
                                    <img src="${o.image}" style="max-height:80px; max-width:100%; border-radius:5px;">
                                 </div>`;
            }
            
            html += `<label class="quiz-option-label">
                        <input type="radio" name="answ" value="${o.originalIndex}" ${isChecked?'checked':''} onchange="ans(${q.id},${o.originalIndex})"> 
                        ${optionContent}
                     </label>`;
        });
    } else if(q.type==='tf') {
        ['صح','خطأ'].forEach((o,i) => {
            const isChecked = currentQuiz.answers[q.id] === i;
            html += `<label class="quiz-option-label">
                        <input type="radio" name="answ" value="${i}" ${isChecked?'checked':''} onchange="ans(${q.id},${i})"> 
                        <span>${o}</span>
                     </label>`;
        });
    } else {
        const userAnswer = currentQuiz.answers[q.id] || '';
        html += `<textarea class="form-control" placeholder="اكتب إجابتك هنا..." oninput="ans(${q.id}, this.value)" style="height:100px;">${userAnswer}</textarea>`;
    }
    
    document.getElementById('quizQuestionContainer').innerHTML = html;
}
        
        function ans(qid, v){ 
            currentQuiz.answers[qid]=v; 
            updateDots(); 
        }
        
        function nextQ(){ 
            if(currentQuiz.idx<currentQuiz.qs.length-1){ 
                currentQuiz.idx++; 
                renderQuizQ(currentQuiz.idx); 
                updateDots(); 
            } 
        }
        
        function prevQ(){ 
            if(currentQuiz.idx>0){ 
                currentQuiz.idx--; 
                renderQuizQ(currentQuiz.idx); 
                updateDots(); 
            } 
        }
        
        function updateDots(){
            document.getElementById('qNavDots').innerHTML = currentQuiz.qs.map((q,i)=>`
                <div class="q-dot ${i===currentQuiz.idx?'active':''} ${currentQuiz.answers[q.id]!==undefined?'solved':'unsolved'}" onclick="currentQuiz.idx=${i};renderQuizQ(${i});updateDots();">
                    ${i+1}
                </div>`).join('');
        }
        
        function submitQuiz(){
    clearInterval(examTimerInterval);
    let score=0;
    currentQuiz.qs.forEach((q,i)=>{ 
        if(q.type === 'fill') {
            if(currentQuiz.answers[q.id] && currentQuiz.answers[q.id].trim().toLowerCase() === q.correct.trim().toLowerCase()) {
                score++; 
            }
        } else if(currentQuiz.answers[q.id] === q.correct) {
            score++; 
        }
    });
    
    const pct = Math.round(score/currentQuiz.qs.length*100);
    
    currentUser.history.push({
        lId: currentQuiz.lessonId,
        type: currentQuiz.type,
        lesson: currentQuiz.title, 
        score, 
        total: currentQuiz.qs.length,
        date: Date.now(), 
        userAnswers: {...currentQuiz.answers}, 
        qIds: currentQuiz.qs.map(q => q.id)
    });
    
    db.students[currentUser.id] = currentUser; 
    saveDB();
    
    // إظهار نتيجة الاختبار في نفس الشاشة مع خيارات المراجعة
    const quizContainer = document.getElementById('quizQuestionContainer');
    const qNavDots = document.getElementById('qNavDots');
    const quizHeader = document.querySelector('.quiz-header');
    const quizTimer = document.getElementById('quizTimer');
    const navButtons = document.querySelectorAll('#st-quiz-active button');
    
    // إخفاء عناصر التحكم القديمة
    if(qNavDots) qNavDots.style.display = 'none';
    if(quizTimer) quizTimer.style.display = 'none';
    navButtons.forEach(btn => btn.style.display = 'none');
    
    let resultMessage = '';
    let resultColor = '';
    
    if(pct >= 85) {
        resultMessage = `🎉 مبروك! لقد حصلت على ${score}/${currentQuiz.qs.length} (${pct}%) - ناجح بامتياز`;
        resultColor = 'green';
    } else if(pct >= 50) {
        resultMessage = `✅ جيد! حصلت على ${score}/${currentQuiz.qs.length} (${pct}%) - ناجح`;
        resultColor = 'blue';
    } else {
        resultMessage = `⚠️ تحتاج إلى تحسين! حصلت على ${score}/${currentQuiz.qs.length} (${pct}%) - راسب`;
        resultColor = 'red';
    }
    
    quizContainer.innerHTML = `
        <div style="text-align:center; padding:40px 20px; background:#f8fafc; border-radius:15px; margin:20px 0;">
            <div style="font-size:48px; margin-bottom:20px;">
                ${pct >= 85 ? '🎉' : pct >= 50 ? '✅' : '⚠️'}
            </div>
            <h2 style="color:${resultColor}; margin-bottom:15px;">${resultMessage}</h2>
            
            <div style="display:flex; justify-content:center; gap:15px; margin-top:30px; flex-wrap:wrap;">
                <button class="btn btn-primary" onclick="reviewQuizImmediately()">
                    <i class="fas fa-eye"></i> مراجعة الإجابات
                </button>
                
                ${pct < 85 ? `
                    <button class="btn retry-wrong-btn" onclick="retryWrongQuestionsImmediately()">
                        <i class="fas fa-redo"></i> إعادة الأخطاء
                    </button>
                    <button class="btn retry-all-btn" onclick="retryAllQuestionsImmediately()">
                        <i class="fas fa-sync-alt"></i> إعادة الاختبار كاملاً
                    </button>
                ` : ''}
                
                <button class="btn btn-success" onclick="returnToAppropriateSection()">
                    <i class="fas fa-home"></i> العودة للقائمة
                </button>
            </div>
            
            <div style="margin-top:30px; padding-top:20px; border-top:1px solid #ddd;">
                <button class="btn btn-dark" onclick="shareResult()" style="margin-right:10px;">
                    <i class="fas fa-share-alt"></i> مشاركة النتيجة
                </button>
                <button class="btn btn-warning" onclick="downloadResult()">
                    <i class="fas fa-download"></i> تحميل التقرير
                </button>
            </div>
        </div>
    `;
    
    // إضافة إشعار
    addNotification('system', currentUser.id, `أكملت اختبار: ${currentQuiz.title} - النتيجة: ${score}/${currentQuiz.qs.length}`, 'info');
}

// دالة المراجعة الفورية
function reviewQuizImmediately() {
    const latestAttempt = currentUser.history[currentUser.history.length - 1];
    const hIdx = currentUser.history.length - 1;
    
    const modal = document.getElementById('reviewModal');
    const content = document.getElementById('reviewContent');
    content.innerHTML = `<h4>مراجعة اختبار: ${latestAttempt.lesson}</h4>`;
    content.innerHTML += `<p><strong>الدرجة:</strong> ${latestAttempt.score}/${latestAttempt.total} (${Math.round((latestAttempt.score/latestAttempt.total)*100)}%)</p>`;
    
    latestAttempt.qIds.forEach((qid, idx) => {
        const q = db.questions.find(x => x.id === qid);
        if(!q) return;
        const uAns = latestAttempt.userAnswers[qid];
        const isCorrect = (q.type === 'fill') 
            ? (uAns && uAns.trim().toLowerCase() === q.correct.trim().toLowerCase())
            : (uAns === q.correct);
        
        let boxClass = isCorrect ? 'rev-correct' : 'rev-wrong';
        let icon = isCorrect ? '<i class="fas fa-check" style="color:green"></i>' : '<i class="fas fa-times" style="color:red"></i>';
        
        let uAnsText = "لم يجب";
        let cAnsText = "";
        
        if(q.type === 'mcq') { 
            if(uAns !== undefined && uAns !== null) {
                uAnsText = q.options[uAns] || "إجابة غير معروفة";
            }
            cAnsText = q.options[q.correct] || "إجابة غير معروفة";
        }
        else if(q.type === 'tf') { 
            if(uAns !== undefined && uAns !== null) {
                uAnsText = (uAns===0 ? 'صح' : 'خطأ'); 
            }
            cAnsText = (q.correct===0 ? 'صح' : 'خطأ'); 
        }
        else if(q.type === 'fill') {
            uAnsText = uAns || "لم يجب";
            cAnsText = q.correct;
        }
        
        content.innerHTML += `
        <div class="${boxClass}">
            <div style="font-weight:bold; margin-bottom:10px;">${idx+1}. ${q.text}</div>
            <div style="margin-bottom:5px;"><strong>إجابتك:</strong> ${uAnsText} ${icon}</div>
            ${!isCorrect ? `<div class="rev-note"><strong>الإجابة الصحيحة:</strong> ${cAnsText}</div>` : ''}
            ${q.image ? `<img src="${q.image}" style="max-width:200px; max-height:150px; margin-top:10px; border-radius:5px;">` : ''}
        </div>`;
    });
    modal.classList.add('active');
}

// دالة إعادة الأخطاء فوراً
function retryWrongQuestionsImmediately() {
    const latestAttempt = currentUser.history[currentUser.history.length - 1];
    
    if(!latestAttempt.userAnswers) return alert('لا توجد بيانات كافية لإعادة الأخطاء');
    
    const wrongQIds = latestAttempt.qIds.filter(qid => {
        const q = db.questions.find(x => x.id === qid);
        return q && latestAttempt.userAnswers[qid] !== q.correct;
    });
    
    if(wrongQIds.length === 0) {
        alert('لا توجد أخطاء لإعادة الاختبار عليها!');
        return;
    }
    
    const qs = db.questions.filter(q => wrongQIds.includes(q.id));
    
    document.getElementById('quizQuestionContainer').innerHTML = `
        <div style="text-align:center; padding:20px;">
            <h3>جاري تحضير الاختبار...</h3>
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    
    setTimeout(() => {
        startRetryQuizImmediately(qs, latestAttempt.lesson + ' - إعادة الأخطاء');
    }, 1000);
}

// دالة إعادة الاختبار كاملاً فوراً
function retryAllQuestionsImmediately() {
    const latestAttempt = currentUser.history[currentUser.history.length - 1];
    const qs = db.questions.filter(q => latestAttempt.qIds.includes(q.id));
    
    document.getElementById('quizQuestionContainer').innerHTML = `
        <div style="text-align:center; padding:20px;">
            <h3>جاري تحضير الاختبار...</h3>
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    
    setTimeout(() => {
        startRetryQuizImmediately(qs, latestAttempt.lesson + ' - إعادة كاملة');
    }, 1000);
}

// دالة البدء الفوري
function startRetryQuizImmediately(qs, title) {
    document.getElementById('takingQuizTitle').innerText = title;
    
    currentQuiz = { 
        qs: qs, 
        answers: {}, 
        idx: 0, 
        time: qs.length * 2 * 60,
        lessonId: null, 
        type: 'retry',
        title: title,
        randomOrder: true,
        randomOptions: true
    };
    
    // إعادة إظهار عناصر التحكم
    const qNavDots = document.getElementById('qNavDots');
    const quizTimer = document.getElementById('quizTimer');
    const navButtons = document.querySelectorAll('#st-quiz-active button');
    
    if(qNavDots) qNavDots.style.display = 'flex';
    if(quizTimer) {
        quizTimer.style.display = 'block';
        quizTimer.innerText = Math.floor(currentQuiz.time/60) + ':' + (currentQuiz.time%60).toString().padStart(2, '0');
    }
    
    navButtons.forEach(btn => btn.style.display = 'inline-block');
    
    // إعادة بدء المؤقت
    clearInterval(examTimerInterval);
    examTimerInterval = setInterval(() => {
        currentQuiz.time--;
        const m = Math.floor(currentQuiz.time/60); 
        const s = currentQuiz.time%60;
        document.getElementById('quizTimer').innerText = `${m}:${s.toString().padStart(2, '0')}`;
        if(currentQuiz.time <= 0) {
            clearInterval(examTimerInterval);
            submitQuiz();
        }
    }, 1000);
    
    initQuizRunner();
}

// دالة العودة للقسم المناسب
function returnToAppropriateSection() {
    document.getElementById('st-quiz-active').style.display = 'none';
    
    if(currentQuiz.type === 'comp') {
        document.getElementById('st-all-exams').style.display = 'block';
        stNav('st-all-exams');
    } else if(currentQuiz.type === 'self') {
        document.getElementById('st-self-test').style.display = 'block';
        stNav('st-self-test');
    } else {
        document.getElementById('st-all-exams').style.display = 'block';
        stNav('st-all-exams');
    }
}

// دوال إضافية
function shareResult() {
    const latestAttempt = currentUser.history[currentUser.history.length - 1];
    const pct = Math.round((latestAttempt.score/latestAttempt.total)*100);
    const message = `حصلت على ${latestAttempt.score}/${latestAttempt.total} (${pct}%) في اختبار "${latestAttempt.lesson}" على المنصة التعليمية!`;
    
    if(navigator.share) {
        navigator.share({
            title: 'نتيجة الاختبار',
            text: message,
            url: window.location.href
        });
    } else {
        alert('يمكنك نسخ النتيجة: ' + message);
    }
}

function downloadResult() {
    const latestAttempt = currentUser.history[currentUser.history.length - 1];
    const pct = Math.round((latestAttempt.score/latestAttempt.total)*100);
    
    const report = `
        تقرير نتيجة الاختبار
        ====================
        
        اسم الاختبار: ${latestAttempt.lesson}
        التاريخ: ${new Date(latestAttempt.date).toLocaleString('ar-EG')}
        النتيجة: ${latestAttempt.score}/${latestAttempt.total}
        النسبة: ${pct}%
        الحالة: ${pct >= 50 ? 'ناجح' : 'راسب'}
        
        التفاصيل:
    `;
    
    const blob = new Blob([report], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `نتيجة_${latestAttempt.lesson}_${new Date().toISOString().slice(0,10)}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

        function reviewQuiz(hIdx) {
            const h = currentUser.history[hIdx];
            if(!h.userAnswers || !h.qIds) return alert("لا توجد تفاصيل محفوظة لهذا الاختبار (قديم)");
            const modal = document.getElementById('reviewModal');
            const content = document.getElementById('reviewContent');
            content.innerHTML = `<h4>مراجعة اختبار: ${h.lesson}</h4>`;
            content.innerHTML += `<p><strong>الدرجة:</strong> ${h.score}/${h.total} (${Math.round((h.score/h.total)*100)}%)</p>`;
            
            h.qIds.forEach((qid, idx) => {
                const q = db.questions.find(x => x.id === qid);
                if(!q) return;
                const uAns = h.userAnswers[qid];
                const isCorrect = (q.type === 'fill') 
                    ? (uAns && uAns.trim().toLowerCase() === q.correct.trim().toLowerCase())
                    : (uAns === q.correct);
                
                let boxClass = isCorrect ? 'rev-correct' : 'rev-wrong';
                let icon = isCorrect ? '<i class="fas fa-check" style="color:green"></i>' : '<i class="fas fa-times" style="color:red"></i>';
                
                let uAnsText = "لم يجب";
                let cAnsText = "";
                
                if(q.type === 'mcq') { 
                    if(uAns !== undefined && uAns !== null) {
                        uAnsText = q.options[uAns] || "إجابة غير معروفة";
                    }
                    cAnsText = q.options[q.correct] || "إجابة غير معروفة";
                }
                else if(q.type === 'tf') { 
                    if(uAns !== undefined && uAns !== null) {
                        uAnsText = (uAns===0 ? 'صح' : 'خطأ'); 
                    }
                    cAnsText = (q.correct===0 ? 'صح' : 'خطأ'); 
                }
                else if(q.type === 'fill') {
                    uAnsText = uAns || "لم يجب";
                    cAnsText = q.correct;
                }
                
                content.innerHTML += `
                <div class="${boxClass}">
                    <div style="font-weight:bold; margin-bottom:10px;">${idx+1}. ${q.text}</div>
                    <div style="margin-bottom:5px;"><strong>إجابتك:</strong> ${uAnsText} ${icon}</div>
                    ${!isCorrect ? `<div class="rev-note"><strong>الإجابة الصحيحة:</strong> ${cAnsText}</div>` : ''}
                    ${q.image ? `<img src="${q.image}" style="max-width:200px; max-height:150px; margin-top:10px; border-radius:5px;">` : ''}
                </div>`;
            });
            modal.classList.add('active');
        }

        // --- Parent Panel ---
        function initParent() {
            document.getElementById('parentStName').innerText = currentUser.name;
            const t = document.querySelector('#pDetailedTable tbody'); t.innerHTML='';
            document.getElementById('pCoursesCount').innerText = currentUser.courses ? currentUser.courses.length : 0;
            document.getElementById('pExamsCount').innerText = currentUser.history ? currentUser.history.length : 0;
            if(currentUser.history && currentUser.history.length > 0) {
                 let totalS = 0, totalM = 0;
                 currentUser.history.forEach(h => { 
                    const pct = Math.round(h.score/h.total*100);
                    t.innerHTML += `<tr><td>-</td><td>${h.lesson}</td><td>${h.score}/${h.total} (${pct}%)</td></tr>`;
                    totalS+=h.score; totalM+=h.total; 
                 });
                 document.getElementById('pAvg').innerText = Math.round((totalS/totalM)*100) + "%";
            }
        }

        // --- Notifications System ---
        function addNotification(sender, receiver, message, type = 'info') {
            const notification = {
                id: Date.now(),
                sender: sender,
                receiver: receiver,
                message: message,
                type: type,
                date: Date.now(),
                read: false
            };
            
            db.notifications.push(notification);
            saveDB();
            checkNotifications();
            
            return notification.id;
        }
        
        function checkNotifications() {
            if(currentUser) {
                // تحديث إشعارات الطالب
                if(currentUser.id) {
                    const studentUnread = db.notifications.filter(n => 
                        n.receiver === currentUser.id && !n.read
                    ).length;
                    
                    const studentBadge = document.getElementById('studentNotificationsBadge');
                    if(studentBadge) {
                        if(studentUnread > 0) {
                            studentBadge.textContent = studentUnread > 99 ? '99+' : studentUnread;
                            studentBadge.style.display = 'flex';
                        } else {
                            studentBadge.style.display = 'none';
                        }
                    }
                    
                    // تحديث إشعارات طلبات الطالب
                    const pendingRequests = db.subscriptionRequests.filter(req => 
                        req.studentId === currentUser.id && req.status === 'pending'
                    ).length;
                    
                    const requestsBadge = document.getElementById('studentRequestsBadge');
                    if(requestsBadge) {
                        if(pendingRequests > 0) {
                            requestsBadge.textContent = pendingRequests > 99 ? '99+' : pendingRequests;
                            requestsBadge.style.display = 'flex';
                        } else {
                            requestsBadge.style.display = 'none';
                        }
                    }
                }
                
                // تحديث إشعارات الأدمن
                if(document.getElementById('adminNotificationsBadge')) {
                    const adminUnread = db.notifications.filter(n => 
                        n.receiver === 'admin' && !n.read
                    ).length;
                    
                    const adminBadge = document.getElementById('adminNotificationsBadge');
                    if(adminUnread > 0) {
                        adminBadge.textContent = adminUnread > 99 ? '99+' : adminUnread;
                        adminBadge.style.display = 'flex';
                    } else {
                        adminBadge.style.display = 'none';
                    }
                }
                
                // تحديث إشعارات طلبات الأدمن
                if(document.getElementById('adminRequestsBadge')) {
                    const pendingAdminRequests = db.subscriptionRequests.filter(req => 
                        req.status === 'pending'
                    ).length;
                    
                    const adminRequestsBadge = document.getElementById('adminRequestsBadge');
                    if(pendingAdminRequests > 0) {
                        adminRequestsBadge.textContent = pendingAdminRequests > 99 ? '99+' : pendingAdminRequests;
                        adminRequestsBadge.style.display = 'flex';
                    } else {
                        adminRequestsBadge.style.display = 'none';
                    }
                }
                
                // تحديث إشعارات الشات للأدمن
                updateAdminChatBadge();
            }
        }
        
        function updateAdminChatBadge() {
            const adminChatBadge = document.getElementById('adminChatBadge');
            if(!adminChatBadge) return;
            
            const unreadMessages = db.chatMessages.filter(msg => 
                msg.receiverId === 'admin' && !msg.read
            ).length;
            
            if(unreadMessages > 0) {
                adminChatBadge.textContent = unreadMessages > 99 ? '99+' : unreadMessages;
                adminChatBadge.style.display = 'flex';
            } else {
                adminChatBadge.style.display = 'none';
            }
        }
        
        function loadAdminNotifications() {
            const listDiv = document.getElementById('adminNotificationsList');
            const adminNotifications = db.notifications.filter(n => n.receiver === 'admin')
                .sort((a, b) => b.date - a.date);
            
            if(adminNotifications.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center; color:#666;">لا توجد إشعارات</p>';
                return;
            }
            
            listDiv.innerHTML = adminNotifications.map(notif => {
                let icon = '';
                let color = '';
                switch(notif.type) {
                    case 'success': icon = 'fa-check-circle'; color = 'green'; break;
                    case 'warning': icon = 'fa-exclamation-triangle'; color = 'orange'; break;
                    case 'info': icon = 'fa-info-circle'; color = 'blue'; break;
                    default: icon = 'fa-bell'; color = 'gray';
                }
                
                return `
                    <div style="padding:15px; border-bottom:1px solid #eee; background:${notif.read ? '#fff' : '#f0f9ff'};">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div style="display:flex; gap:10px; align-items:center;">
                                <i class="fas ${icon}" style="color:${color};"></i>
                                <div>
                                    <div style="font-weight:bold;">${notif.message}</div>
                                    <div style="font-size:12px; color:#666;">
                                        ${notif.sender === 'system' ? 'النظام' : 'مستخدم'} - 
                                        ${new Date(notif.date).toLocaleString('ar-EG')}
                                    </div>
                                </div>
                            </div>
                            ${!notif.read ? '<span style="background:blue; color:white; padding:2px 8px; border-radius:10px; font-size:12px;">جديد</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // تحديث حالة الإشعارات كمقروءة
            adminNotifications.forEach(notif => {
                notif.read = true;
            });
            saveDB();
            checkNotifications();
        }
        
        function loadStudentNotifications() {
            const listDiv = document.getElementById('studentNotificationsList');
            const studentNotifications = db.notifications.filter(n => n.receiver === currentUser.id)
                .sort((a, b) => b.date - a.date);
            
            if(studentNotifications.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center; color:#666;">لا توجد إشعارات</p>';
                return;
            }
            
            listDiv.innerHTML = studentNotifications.map(notif => {
                let icon = '';
                let color = '';
                switch(notif.type) {
                    case 'success': icon = 'fa-check-circle'; color = 'green'; break;
                    case 'warning': icon = 'fa-exclamation-triangle'; color = 'orange'; break;
                    case 'info': icon = 'fa-info-circle'; color = 'blue'; break;
                    default: icon = 'fa-bell'; color = 'gray';
                }
                
                let senderName = 'النظام';
                if(notif.sender === 'admin') {
                    senderName = 'الإدارة';
                } else if(notif.sender !== 'system') {
                    const sender = db.students[notif.sender];
                    if(sender) senderName = sender.name;
                }
                
                return `
                    <div style="padding:15px; border-bottom:1px solid #eee; background:${notif.read ? '#fff' : '#f0f9ff'};">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div style="display:flex; gap:10px; align-items:center;">
                                <i class="fas ${icon}" style="color:${color};"></i>
                                <div>
                                    <div style="font-weight:bold;">${notif.message}</div>
                                    <div style="font-size:12px; color:#666;">
                                        ${senderName} - ${new Date(notif.date).toLocaleString('ar-EG')}
                                    </div>
                                </div>
                            </div>
                            ${!notif.read ? '<span style="background:blue; color:white; padding:2px 8px; border-radius:10px; font-size:12px;">جديد</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // تحديث حالة الإشعارات كمقروءة
            studentNotifications.forEach(notif => {
                notif.read = true;
            });
            saveDB();
            checkNotifications();
        }
        
        function clearAllNotifications(userType) {
            if(confirm('هل تريد حذف جميع الإشعارات؟')) {
                if(userType === 'admin') {
                    db.notifications = db.notifications.filter(n => n.receiver !== 'admin');
                } else {
                    db.notifications = db.notifications.filter(n => n.receiver !== currentUser.id);
                }
                saveDB();
                
                if(userType === 'admin') {
                    loadAdminNotifications();
                } else {
                    loadStudentNotifications();
                }
                
                checkNotifications();
                alert('تم حذف جميع الإشعارات');
            }
        }

        // --- Teacher Chat System ---
        function updateTeacherStatus() {
            if(!db.teachers['admin']) return;
            
            const teacher = db.teachers['admin'];
            const isOnline = teacher.status === 'online' && (Date.now() - teacher.lastActive < 300000); // 5 دقائق
            
            const teacherStatus = document.getElementById('teacherStatus');
            const chatTeacherStatus = document.getElementById('chatTeacherStatus');
            const chatStatusText = document.getElementById('chatStatusText');
            
            if(teacherStatus) {
                teacherStatus.className = 'teacher-status ' + (isOnline ? 'online' : 'offline');
            }
            
            if(chatTeacherStatus) {
                chatTeacherStatus.className = 'teacher-status ' + (isOnline ? 'online' : 'offline');
            }
            
            if(chatStatusText) {
                chatStatusText.innerText = isOnline ? 'أونلاين - يجيب خلال دقائق' : 'أوفلاين - سيرد عند عودته';
            }
        }
        
        function toggleTeacherChat() {
            const chat = document.getElementById('teacherChat');
            teacherChatOpen = !teacherChatOpen;
            
            if(teacherChatOpen) {
                chat.classList.add('active');
                loadChatMessages();
            } else {
                chat.classList.remove('active');
            }
            
            updateTeacherStatus();
        }
        
        function loadChatMessages() {
            const chatMessages = document.getElementById('chatMessages');
            if(!currentUser) return;
            
            // تحميل الرسائل من قاعدة البيانات
            const userMessages = db.chatMessages.filter(msg => 
                msg.senderId === currentUser.id || msg.receiverId === currentUser.id
            ).sort((a, b) => a.date - b.date);
            
            let messagesHTML = '';
            
            userMessages.forEach(msg => {
                const isStudent = msg.senderId === currentUser.id;
                const messageClass = isStudent ? 'student' : 'teacher';
                const senderName = isStudent ? 'أنت' : 'المعلم';
                
                messagesHTML += `
                    <div class="chat-message ${messageClass}">
                        <strong>${senderName}:</strong> ${msg.message}
                        <div style="font-size:11px; color:#666; margin-top:5px;">
                            ${new Date(msg.date).toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'})}
                        </div>
                    </div>
                `;
            });
            
            chatMessages.innerHTML = messagesHTML;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if(!message) return;
            
            // إضافة الرسالة لقاعدة البيانات
            const chatMessage = {
                id: Date.now(),
                senderId: currentUser.id,
                receiverId: 'admin',
                message: message,
                date: Date.now(),
                read: false
            };
            
            db.chatMessages.push(chatMessage);
            saveDB();
            
            // عرض الرسالة في الشات
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML += `
                <div class="chat-message student">
                    <strong>أنت:</strong> ${message}
                    <div style="font-size:11px; color:#666; margin-top:5px;">
                        ${new Date().toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'})}
                    </div>
                </div>
            `;
            
            // مسح حقل الإدخال
            input.value = '';
            
            // تمرير إلى الأعلى
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // إرسال إشعار للمعلم
            addNotification('student', 'admin', `رسالة جديدة من الطالب ${currentUser.name}: ${message}`, 'info');
            
            // تحديث بادج الشات للأدمن
            updateAdminChatBadge();
            
            // رد تلقائي بعد 5-10 ثواني
            setTimeout(() => {
                if(teacherChatOpen) {
                    const replies = [
                        "شكراً على سؤالك، سأرد عليك قريباً.",
                        "هل يمكنك توضيح سؤالك أكثر؟",
                        "هذا سؤال جيد، سأبحث عن الإجابة المناسبة.",
                        "لقد استلمت رسالتك وسأرد عليك في أقرب وقت.",
                        "هل تريد مساعدة في موضوع محدد؟"
                    ];
                    
                    const randomReply = replies[Math.floor(Math.random() * replies.length)];
                    
                    const replyMessage = {
                        id: Date.now() + 1,
                        senderId: 'admin',
                        receiverId: currentUser.id,
                        message: randomReply,
                        date: Date.now(),
                        read: false
                    };
                    
                    db.chatMessages.push(replyMessage);
                    saveDB();
                    
                    chatMessages.innerHTML += `
                        <div class="chat-message teacher">
                            <strong>المعلم:</strong> ${randomReply}
                            <div style="font-size:11px; color:#666; margin-top:5px;">
                                ${new Date().toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'})}
                            </div>
                        </div>
                    `;
                    
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // إشعار للطالب
                    addNotification('teacher', currentUser.id, `رد المعلم: ${randomReply}`, 'info');
                }
            }, 5000 + Math.random() * 5000);
        }

        // --- Admin Chat System ---
        function toggleAdminChat() {
            const chat = document.getElementById('adminChat');
            adminChatOpen = !adminChatOpen;
            
            if(adminChatOpen) {
                chat.classList.add('active');
                loadAdminChatStudents();
            } else {
                chat.classList.remove('active');
                selectedChatStudent = null;
                document.getElementById('adminChatMessages').innerHTML = '';
                document.getElementById('adminChatInput').disabled = true;
                document.getElementById('adminChatInput').placeholder = 'اختر طالباً للرد عليه...';
            }
        }
        
        function loadAdminChatStudents() {
            const container = document.getElementById('adminChatStudents');
            container.innerHTML = '';
            
            const studentsWithMessages = {};
            
            // جمع جميع الطلاب الذين لديهم رسائل
            db.chatMessages.forEach(msg => {
                if(msg.senderId !== 'admin' && db.students[msg.senderId]) {
                    if(!studentsWithMessages[msg.senderId]) {
                        studentsWithMessages[msg.senderId] = {
                            student: db.students[msg.senderId],
                            unread: 0,
                            lastMessage: msg.date
                        };
                    }
                    
                    if(msg.receiverId === 'admin' && !msg.read) {
                        studentsWithMessages[msg.senderId].unread++;
                    }
                    
                    if(msg.date > studentsWithMessages[msg.senderId].lastMessage) {
                        studentsWithMessages[msg.senderId].lastMessage = msg.date;
                    }
                }
            });
            
            // تحويل الكائن إلى مصفوفة وترتيبها حسب آخر رسالة
            const studentsArray = Object.values(studentsWithMessages);
            studentsArray.sort((a, b) => b.lastMessage - a.lastMessage);
            
            if(studentsArray.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:10px; color:#666;">لا توجد محادثات</p>';
                return;
            }
            
            studentsArray.forEach(studentData => {
                const student = studentData.student;
                const studentEl = document.createElement('div');
                studentEl.className = 'chat-student-frame';
                studentEl.style.cssText = `
                    padding: 10px;
                    margin-bottom: 10px;
                    cursor: pointer;
                    background: ${selectedChatStudent === student.id ? '#f0f9ff' : '#f8fafc'};
                    border-left: 4px solid ${selectedChatStudent === student.id ? 'var(--primary)' : '#ddd'};
                    transition: all 0.3s;
                `;
                
                studentEl.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong style="font-size:14px;">${student.name}</strong>
                            <div style="font-size:11px; color:#666;">${student.phone}</div>
                        </div>
                        ${studentData.unread > 0 ? 
                            `<span style="background:red; color:white; border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-size:10px;">${studentData.unread}</span>` : 
                            ''}
                    </div>
                `;
                
                studentEl.onclick = () => selectChatStudent(student.id);
                container.appendChild(studentEl);
            });
            
            // تحديث إحصائيات الرسائل
            document.getElementById('totalMessages').textContent = db.chatMessages.filter(msg => 
                msg.senderId !== 'admin' || msg.receiverId !== 'admin'
            ).length;
        }
        
        function selectChatStudent(studentId) {
            selectedChatStudent = studentId;
            const student = db.students[studentId];
            
            // تحديث العناصر المحددة
            document.querySelectorAll('.chat-student-frame').forEach(el => {
                el.style.background = '#f8fafc';
                el.style.borderLeftColor = '#ddd';
            });
            event.target.closest('.chat-student-frame').style.background = '#f0f9ff';
            event.target.closest('.chat-student-frame').style.borderLeftColor = 'var(--primary)';
            
            // تفعيل حقل الإدخال
            document.getElementById('adminChatInput').disabled = false;
            document.getElementById('adminChatInput').placeholder = `رد على ${student.name}...`;
            
            // تحميل رسائل الطالب
            loadStudentChatMessages(studentId);
            
            // تحديث الرسائل كمقروءة
            db.chatMessages.forEach(msg => {
                if(msg.senderId === studentId && msg.receiverId === 'admin' && !msg.read) {
                    msg.read = true;
                }
            });
            saveDB();
            
            // تحديث البادج
            updateAdminChatBadge();
            loadAdminChatStudents();
        }
        
        function loadStudentChatMessages(studentId) {
            const container = document.getElementById('adminChatMessages');
            container.innerHTML = '';
            
            const messages = db.chatMessages.filter(msg => 
                (msg.senderId === studentId && msg.receiverId === 'admin') || 
                (msg.senderId === 'admin' && msg.receiverId === studentId)
            ).sort((a, b) => a.date - b.date);
            
            if(messages.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">لا توجد رسائل</div>';
                return;
            }
            
            messages.forEach(msg => {
                const isAdmin = msg.senderId === 'admin';
                const messageClass = isAdmin ? 'teacher' : 'student';
                const senderName = isAdmin ? 'أنت (المعلم)' : db.students[msg.senderId]?.name || 'طالب';
                
                container.innerHTML += `
                    <div class="chat-message ${messageClass}">
                        <div style="font-weight:bold; margin-bottom:5px;">${senderName}</div>
                        <div>${msg.message}</div>
                        <div style="font-size:11px; color:#666; margin-top:5px;">
                            ${new Date(msg.date).toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'})}
                        </div>
                    </div>
                `;
            });
            
            container.scrollTop = container.scrollHeight;
        }
        
        function sendAdminChatMessage() {
            if(!selectedChatStudent) {
                alert('يرجى اختيار طالب أولاً');
                return;
            }
            
            const input = document.getElementById('adminChatInput');
            const message = input.value.trim();
            
            if(!message) return;
            
            const student = db.students[selectedChatStudent];
            
            // إضافة الرسالة لقاعدة البيانات
            const chatMessage = {
                id: Date.now(),
                senderId: 'admin',
                receiverId: selectedChatStudent,
                message: message,
                date: Date.now(),
                read: false
            };
            
            db.chatMessages.push(chatMessage);
            saveDB();
            
            // عرض الرسالة في الشات
            const container = document.getElementById('adminChatMessages');
            container.innerHTML += `
                <div class="chat-message teacher">
                    <div style="font-weight:bold; margin-bottom:5px;">أنت (المعلم)</div>
                    <div>${message}</div>
                    <div style="font-size:11px; color:#666; margin-top:5px;">
                        ${new Date().toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'})}
                    </div>
                </div>
            `;
            
            // مسح حقل الإدخال
            input.value = '';
            
            // تمرير إلى الأعلى
            container.scrollTop = container.scrollHeight;
            
            // إضافة إشعار للطالب
            addNotification('admin', selectedChatStudent, `رد المعلم على رسالتك: ${message.substring(0, 50)}...`, 'info');
            
            // تحديث بادج الإشعارات للطالب
            checkNotifications();
        }

        // تحديث حالة المعلم بشكل دوري
        setInterval(updateTeacherStatus, 60000); // كل دقيقة

        // Init
        if(db.courses.length > 0) renderCourses();
        updateDrops();
    </script>
</body>
</html>